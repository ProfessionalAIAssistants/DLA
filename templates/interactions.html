{% extends "base.html" %}

{% block title %}Interactions - CDE Prosperity{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-5">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-6 fw-bold mb-2">
                        <i class="fas fa-comments me-3" style="background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></i>
                        Interactions
                    </h1>
                    <p class="text-muted mb-0 fs-5">Track communications and engagement activities</p>
                </div>
                <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addInteractionModal">
                    <i class="fas fa-plus me-2"></i> Add Interaction
                </button>
            </div>
        </div>
    </div>

    <!-- Modern Stats Cards Row -->
    <div class="row mb-5">
        <div class="col-md-3">
            <div class="card card-metric h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-dark mb-2 text-uppercase fw-bold" style="font-size: 0.75rem; letter-spacing: 1px; opacity: 0.8;">Total Interactions</h6>
                        <h2 class="mb-0 fw-bold text-dark">{{ stats.total }}</h2>
                    </div>
                    <div class="ms-3">
                        <div class="rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 50px; height: 50px; background: rgba(255,255,255,0.2);">
                            <i class="fas fa-comments fa-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-metric success h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-dark mb-2 text-uppercase fw-bold" style="font-size: 0.75rem; letter-spacing: 1px; opacity: 0.8;">Today</h6>
                        <h2 class="mb-0 fw-bold text-dark">{{ stats.today }}</h2>
                    </div>
                    <div class="ms-3">
                        <div class="rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 50px; height: 50px; background: rgba(255,255,255,0.2);">
                            <i class="fas fa-calendar-day fa-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-metric info h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-dark-50 mb-2 text-uppercase" style="font-size: 0.75rem; letter-spacing: 1px;">This Week</h6>
                        <h2 class="mb-0 fw-bold">{{ stats.this_week }}</h2>
                    </div>
                    <div class="ms-3">
                        <div class="rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 50px; height: 50px; background: rgba(255,255,255,0.2);">
                            <i class="fas fa-calendar-week fa-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-metric warning h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-dark-50 mb-2 text-uppercase" style="font-size: 0.75rem; letter-spacing: 1px;">Pending</h6>
                        <h2 class="mb-0 fw-bold">{{ stats.pending }}</h2>
                    </div>
                    <div class="ms-3">
                        <div class="rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 50px; height: 50px; background: rgba(255,255,255,0.2);">
                            <i class="fas fa-clock fa-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Row -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse">
                            <i class="fas fa-filter"></i> Filters
                        </button>
                    </h5>
                </div>
                <div id="filtersCollapse" class="collapse">
                    <div class="card-body">
                        <form method="GET" id="filterForm">
                            <div class="row">
                                <div class="col-md-2">
                                    <label for="type_filter" class="form-label">Type</label>
                                    <select class="form-select" id="type_filter" name="type">
                                        <option value="">All Types</option>
                                        <option value="Call" {% if filters.type == 'Call' %}selected{% endif %}>Call</option>
                                        <option value="Email" {% if filters.type == 'Email' %}selected{% endif %}>Email</option>
                                        <option value="LinkedIn" {% if filters.type == 'LinkedIn' %}selected{% endif %}>LinkedIn</option>
                                        <option value="Text" {% if filters.type == 'Text' %}selected{% endif %}>Text</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="direction_filter" class="form-label">Direction</label>
                                    <select class="form-select" id="direction_filter" name="direction">
                                        <option value="">All Directions</option>
                                        <option value="Sent" {% if filters.direction == 'Sent' %}selected{% endif %}>Sent</option>
                                        <option value="Received" {% if filters.direction == 'Received' %}selected{% endif %}>Received</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="status_filter" class="form-label">Status</label>
                                    <select class="form-select" id="status_filter" name="status">
                                        <option value="">All Statuses</option>
                                        <option value="Pending" {% if filters.status == 'Pending' %}selected{% endif %}>Pending</option>
                                        <option value="Completed" {% if filters.status == 'Completed' %}selected{% endif %}>Completed</option>
                                        <option value="Failed" {% if filters.status == 'Failed' %}selected{% endif %}>Failed</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="start_date_filter" class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="start_date_filter" name="start_date" value="{{ filters.start_date or '' }}">
                                </div>
                                <div class="col-md-2">
                                    <label for="end_date_filter" class="form-label">End Date</label>
                                    <input type="date" class="form-control" id="end_date_filter" name="end_date" value="{{ filters.end_date or '' }}">
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary me-2">Apply</button>
                                    <a href="{{ url_for('interactions') }}" class="btn btn-secondary">Clear</a>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Interactions Table -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>Interactions ({{ interactions|length }} found)</h5>
                </div>
                <div class="card-body">
                    {% if interactions %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Date/Time</th>
                                    <th>Type</th>
                                    <th>Direction</th>
                                    <th>Subject</th>
                                    <th>Contact</th>
                                    <th>Opportunity</th>
                                    <th>Status</th>
                                    <th>Duration</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for interaction in interactions %}
                                <tr>
                                    <td>
                                        <div class="fw-bold">{{ interaction.interaction_date.split(' ')[0] if interaction.interaction_date else 'N/A' }}</div>
                                        <small class="text-muted">{{ interaction.interaction_date.split(' ')[1] if interaction.interaction_date and ' ' in interaction.interaction_date else '' }}</small>
                                    </td>
                                    <td>
                                        {% if interaction.type == 'Call' %}
                                            <span class="badge bg-primary"><i class="fas fa-phone"></i> {{ interaction.type }}</span>
                                        {% elif interaction.type == 'Email' %}
                                            <span class="badge bg-info"><i class="fas fa-envelope"></i> {{ interaction.type }}</span>
                                        {% elif interaction.type == 'LinkedIn' %}
                                            <span class="badge bg-secondary"><i class="fab fa-linkedin"></i> {{ interaction.type }}</span>
                                        {% elif interaction.type == 'Text' %}
                                            <span class="badge bg-success"><i class="fas fa-sms"></i> {{ interaction.type }}</span>
                                        {% else %}
                                            <span class="badge bg-light text-dark">{{ interaction.type or 'N/A' }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if interaction.direction == 'Sent' %}
                                            <span class="badge bg-warning"><i class="fas fa-arrow-up"></i> Sent</span>
                                        {% elif interaction.direction == 'Received' %}
                                            <span class="badge bg-success"><i class="fas fa-arrow-down"></i> Received</span>
                                        {% else %}
                                            <span class="badge bg-light text-dark">{{ interaction.direction or 'N/A' }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="fw-bold">{{ interaction.subject or 'No Subject' }}</div>
                                        {% if interaction.message %}
                                            <small class="text-muted">{{ (interaction.message or 'No message')[:100] }}{% if (interaction.message or '')|length > 100 %}...{% endif %}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if interaction.contact_name %}
                                            <div class="fw-bold">{{ interaction.contact_name }}</div>
                                            {% if interaction.contact_email_addr %}
                                                <small class="text-muted">{{ interaction.contact_email_addr }}</small>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">No Contact</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if interaction.opportunity_name %}
                                            <span class="badge bg-info">{{ interaction.opportunity_name }}</span>
                                        {% else %}
                                            <span class="text-muted">No Opportunity</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if interaction.status == 'Completed' %}
                                            <span class="badge bg-success">{{ interaction.status }}</span>
                                        {% elif interaction.status == 'Pending' %}
                                            <span class="badge bg-warning">{{ interaction.status }}</span>
                                        {% elif interaction.status == 'Failed' %}
                                            <span class="badge bg-danger">{{ interaction.status }}</span>
                                        {% else %}
                                            <span class="badge bg-light text-dark">{{ interaction.status or 'N/A' }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if interaction.duration_minutes %}
                                            {{ interaction.duration_minutes }} min
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="viewInteraction({{ interaction.id }})">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="editInteraction({{ interaction.id }})">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteInteraction({{ interaction.id }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No interactions found</h5>
                        <p class="text-muted">Start by adding your first interaction or adjust your filters.</p>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addInteractionModal">
                            <i class="fas fa-plus"></i> Add First Interaction
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Interaction Modal -->
<div class="modal fade" id="addInteractionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus"></i> Add New Interaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addInteractionForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="add_type" class="form-label">Type <span class="text-danger">*</span></label>
                                <select class="form-select" id="add_type" name="type" required>
                                    <option value="">Select Type</option>
                                    <option value="Call">Call</option>
                                    <option value="Email">Email</option>
                                    <option value="LinkedIn">LinkedIn</option>
                                    <option value="Text">Text</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="add_interaction_date" class="form-label">Date/Time</label>
                                <input type="datetime-local" class="form-control" id="add_interaction_date" name="interaction_date">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="add_subject" class="form-label">Subject</label>
                        <input type="text" class="form-control" id="add_subject" name="subject" placeholder="Brief description of the interaction">
                    </div>
                    <div class="mb-3">
                        <label for="add_description" class="form-label">Description/Notes</label>
                        <textarea class="form-control" id="add_description" name="description" rows="4" placeholder="Detailed notes about the interaction"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="add_contact_id" class="form-label">Contact</label>
                                <select class="form-select" id="add_contact_id" name="contact_id">
                                    <option value="">Select Contact</option>
                                    <!-- Contacts will be loaded via JavaScript -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="add_opportunity_id" class="form-label">Opportunity</label>
                                <select class="form-select" id="add_opportunity_id" name="opportunity_id">
                                    <option value="">Select Opportunity</option>
                                    <!-- Opportunities will be loaded via JavaScript -->
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="add_duration_minutes" class="form-label">Duration (minutes)</label>
                                <input type="number" class="form-control" id="add_duration_minutes" name="duration_minutes" min="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="add_location" class="form-label">Location</label>
                                <input type="text" class="form-control" id="add_location" name="location" placeholder="Meeting location or phone number">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="add_outcome" class="form-label">Outcome</label>
                        <textarea class="form-control" id="add_outcome" name="outcome" rows="2" placeholder="Result or outcome of the interaction"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveInteraction()">Save Interaction</button>
            </div>
        </div>
    </div>
</div>

<!-- View Interaction Modal -->
<div class="modal fade" id="viewInteractionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-eye"></i> View Interaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="viewInteractionContent">
                <!-- Content will be loaded via JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="editInteractionFromView()">Edit</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Interaction Modal -->
<div class="modal fade" id="editInteractionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit"></i> Edit Interaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editInteractionForm">
                    <input type="hidden" id="edit_interaction_id" name="id">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_type" class="form-label">Type <span class="text-danger">*</span></label>
                                <select class="form-select" id="edit_type" name="type" required>
                                    <option value="">Select Type</option>
                                    <option value="Call">Call</option>
                                    <option value="Email">Email</option>
                                    <option value="LinkedIn">LinkedIn</option>
                                    <option value="Text">Text</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_direction" class="form-label">Direction <span class="text-danger">*</span></label>
                                <select class="form-select" id="edit_direction" name="direction" required>
                                    <option value="">Select Direction</option>
                                    <option value="Sent">Sent</option>
                                    <option value="Received">Received</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_status" class="form-label">Status</label>
                                <select class="form-select" id="edit_status" name="status">
                                    <option value="Pending">Pending</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Failed">Failed</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_interaction_date" class="form-label">Date/Time</label>
                                <input type="datetime-local" class="form-control" id="edit_interaction_date" name="interaction_date">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_subject" class="form-label">Subject</label>
                        <input type="text" class="form-control" id="edit_subject" name="subject">
                    </div>
                    <div class="mb-3">
                        <label for="edit_message" class="form-label">Message/Notes</label>
                        <textarea class="form-control" id="edit_message" name="message" rows="4"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_contact_id" class="form-label">Contact</label>
                                <select class="form-select" id="edit_contact_id" name="contact_id">
                                    <option value="">Select Contact</option>
                                    <!-- Contacts will be loaded via JavaScript -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_opportunity_id" class="form-label">Opportunity</label>
                                <select class="form-select" id="edit_opportunity_id" name="opportunity_id">
                                    <option value="">Select Opportunity</option>
                                    <!-- Opportunities will be loaded via JavaScript -->
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_duration_minutes" class="form-label">Duration (minutes)</label>
                                <input type="number" class="form-control" id="edit_duration_minutes" name="duration_minutes" min="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_location" class="form-label">Location</label>
                                <input type="text" class="form-control" id="edit_location" name="location">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_outcome" class="form-label">Outcome</label>
                        <textarea class="form-control" id="edit_outcome" name="outcome" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateInteraction()">Update Interaction</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentInteractionId = null;

// Load contacts and opportunities for dropdowns
document.addEventListener('DOMContentLoaded', function() {
    loadContactsAndOpportunities();
    
    // Set default datetime to now
    const now = new Date();
    const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
    document.getElementById('add_interaction_date').value = localDateTime;
});

function loadContactsAndOpportunities() {
    // Load contacts
    fetch('/api/contacts')
        .then(response => response.json())
        .then(contacts => {
            const addContactSelect = document.getElementById('add_contact_id');
            const editContactSelect = document.getElementById('edit_contact_id');
            
            contacts.forEach(contact => {
                const option = new Option(`${contact.name} (${contact.email})`, contact.id);
                addContactSelect.add(option.cloneNode(true));
                editContactSelect.add(option);
            });
        })
        .catch(error => console.error('Error loading contacts:', error));
    
    // Load opportunities
    fetch('/api/opportunities')
        .then(response => response.json())
        .then(opportunities => {
            const addOpportunitySelect = document.getElementById('add_opportunity_id');
            const editOpportunitySelect = document.getElementById('edit_opportunity_id');
            
            opportunities.forEach(opportunity => {
                const option = new Option(opportunity.name, opportunity.id);
                addOpportunitySelect.add(option.cloneNode(true));
                editOpportunitySelect.add(option);
            });
        })
        .catch(error => console.error('Error loading opportunities:', error));
}

function saveInteraction() {
    const form = document.getElementById('addInteractionForm');
    const formData = new FormData(form);
    
    // Convert FormData to JSON
    const data = {};
    formData.forEach((value, key) => {
        if (value) data[key] = value;
    });
    
    fetch('/api/interactions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            location.reload();
        } else {
            alert('Error saving interaction: ' + result.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving interaction');
    });
}

function viewInteraction(interactionId) {
    fetch(`/api/interactions/${interactionId}`)
        .then(response => response.json())
        .then(interaction => {
            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <strong>Type:</strong> ${interaction.type || 'N/A'}<br>
                        <strong>Direction:</strong> ${interaction.direction || 'N/A'}<br>
                        <strong>Status:</strong> ${interaction.status || 'N/A'}<br>
                        <strong>Date/Time:</strong> ${interaction.interaction_date ? new Date(interaction.interaction_date).toLocaleString() : 'N/A'}<br>
                        <strong>Duration:</strong> ${interaction.duration_minutes ? interaction.duration_minutes + ' minutes' : 'N/A'}<br>
                        <strong>Location:</strong> ${interaction.location || 'N/A'}
                    </div>
                    <div class="col-md-6">
                        <strong>Contact:</strong> ${interaction.contact_name || 'N/A'}<br>
                        <strong>Contact Email:</strong> ${interaction.contact_email_addr || 'N/A'}<br>
                        <strong>Opportunity:</strong> ${interaction.opportunity_name || 'N/A'}<br>
                        <strong>Account:</strong> ${interaction.account_name || 'N/A'}
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-12">
                        <strong>Subject:</strong><br>
                        <p>${interaction.subject || 'No subject'}</p>
                        
                        <strong>Message/Notes:</strong><br>
                        <p>${interaction.message || 'No message'}</p>
                        
                        <strong>Outcome:</strong><br>
                        <p>${interaction.outcome || 'No outcome recorded'}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('viewInteractionContent').innerHTML = html;
            currentInteractionId = interactionId;
            new bootstrap.Modal(document.getElementById('viewInteractionModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading interaction details');
        });
}

function editInteraction(interactionId) {
    fetch(`/api/interactions/${interactionId}`)
        .then(response => response.json())
        .then(interaction => {
            // Populate edit form
            document.getElementById('edit_interaction_id').value = interaction.id;
            document.getElementById('edit_type').value = interaction.type || '';
            document.getElementById('edit_direction').value = interaction.direction || '';
            document.getElementById('edit_status').value = interaction.status || '';
            document.getElementById('edit_subject').value = interaction.subject || '';
            document.getElementById('edit_message').value = interaction.message || '';
            document.getElementById('edit_contact_id').value = interaction.contact_id || '';
            document.getElementById('edit_opportunity_id').value = interaction.opportunity_id || '';
            document.getElementById('edit_duration_minutes').value = interaction.duration_minutes || '';
            document.getElementById('edit_location').value = interaction.location || '';
            document.getElementById('edit_outcome').value = interaction.outcome || '';
            
            // Handle datetime
            if (interaction.interaction_date) {
                const date = new Date(interaction.interaction_date);
                const localDateTime = new Date(date.getTime() - date.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                document.getElementById('edit_interaction_date').value = localDateTime;
            }
            
            currentInteractionId = interactionId;
            new bootstrap.Modal(document.getElementById('editInteractionModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading interaction details');
        });
}

function editInteractionFromView() {
    document.querySelector('#viewInteractionModal .btn-close').click();
    setTimeout(() => editInteraction(currentInteractionId), 300);
}

function updateInteraction() {
    const form = document.getElementById('editInteractionForm');
    const formData = new FormData(form);
    
    // Convert FormData to JSON
    const data = {};
    formData.forEach((value, key) => {
        if (value) data[key] = value;
    });
    
    const interactionId = data.id;
    delete data.id; // Remove id from data to send
    
    fetch(`/api/interactions/${interactionId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            location.reload();
        } else {
            alert('Error updating interaction: ' + result.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating interaction');
    });
}

function deleteInteraction(interactionId) {
    if (confirm('Are you sure you want to delete this interaction?')) {
        fetch(`/api/interactions/${interactionId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                location.reload();
            } else {
                alert('Error deleting interaction: ' + result.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting interaction');
        });
    }
}

// Auto-open interaction modal if interaction_id is in URL
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const interactionId = urlParams.get('interaction_id');
    
    if (interactionId) {
        // Small delay to ensure page is fully loaded
        setTimeout(() => {
            viewInteraction(parseInt(interactionId));
        }, 500);
    }
});
</script>

{% endblock %}
