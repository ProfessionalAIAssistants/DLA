{% extends "base.html" %}
{% from "macros/processing_report_macros.html" import summary_card, badge_with_change, file_table, record_type_card, updated_record_card, card_section, report_header, summary_row, detailed_summary_card, database_changes_card, filter_settings_card %}

{% block title %}Processing Report Details - DLA CRM{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    {{ report_header(report) }}

    <!-- Summary Cards -->
    {{ summary_row(report) }}

    <!-- Detailed Record Summary -->
    {{ detailed_summary_card(report) }}

    <!-- Database Changes -->
    {{ database_changes_card(report) }}

    <!-- Filter Settings Used -->
    {{ filter_settings_card(report) }}

    <!-- Processed Files Details -->
    {% if report.processed_files %}
    {% call card_section("Successfully Processed Files (" + report.processed_files|length|string + ")", "check-circle", "success") %}
        {{ file_table(report.processed_files, "processed") }}
    {% endcall %}
    {% endif %}

    <!-- Skipped Files Details -->
    {% if report.skipped_files %}
    {% call card_section("Skipped Files (" + report.skipped_files|length|string + ")", "exclamation-triangle", "warning") %}
        {{ file_table(report.skipped_files, "skipped") }}
    {% endcall %}
    {% endif %}

    <!-- Error Files Details -->
    {% if report.error_files %}
    {% call card_section("Error Files (" + report.error_files|length|string + ")", "times-circle", "danger") %}
        {{ file_table(report.error_files, "error") }}
    {% endcall %}
    {% endif %}

    <!-- Created Records Summary -->
    {% if report.created_records %}
    {% call card_section("Records Created During Processing", "plus-circle", "success", "created-records") %}
        <div class="row">
            {% for record_type, records in report.created_records.items() %}
            {% if records %}
            {{ record_type_card(record_type, records, "success") }}
            {% endif %}
            {% endfor %}
        </div>
    {% endcall %}
    {% endif %}

    <!-- Updated Records Summary -->
    {% if report.updated_records %}
    {% call card_section("Records Updated During Processing", "edit", "info") %}
        <div class="row">
            {% for record_type, records in report.updated_records.items() %}
            {% if records %}
            {{ updated_record_card(record_type, records) }}
            {% endif %}
            {% endfor %}
        </div>
    {% endcall %}
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/processing_report_detail.js') }}"></script>
<script>
// Make ProcessingReportJS globally available immediately
window.ProcessingReportJS = ProcessingReportJS;

// Initialize processing report functionality
document.addEventListener('DOMContentLoaded', function() {
    ProcessingReportJS.init('{{ filename }}');
});

// Ensure record viewing function is globally available for onclick handlers
window.viewRecord = function(recordType, recordId) {
    ProcessingReportJS.Records.view(recordType, recordId);
};
</script>

<style>
@media print {
    .btn, .card-header { print-color-adjust: exact; }
    .container-fluid { max-width: none; }
}
.badge-stage {
    font-size: 0.75em;
    padding: 0.25em 0.5em;
}
.btn-action {
    font-size: 0.75em;
    padding: 0.25rem 0.5rem;
}
.record-item:hover {
    background-color: #f8f9fa !important;
    transform: translateY(-1px);
    transition: all 0.2s ease;
}

.record-item {
    transition: all 0.2s ease;
}

.record-item:active {
    transform: translateY(0px);
}
</style>
{% endblock %}
