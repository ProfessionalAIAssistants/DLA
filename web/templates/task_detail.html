{% extends "base.html" %}

{% block title %}{{ task.subject if task.subject else 'Task Details' }} - CDE Prosperity{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>Task Details</h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
                            <li class="breadcrumb-item"><a href="/tasks">Tasks</a></li>
                            <li class="breadcrumb-item active">{{ task.subject[:50] if task.subject else 'Untitled Task' }}...</li>
                        </ol>
                    </nav>
                </div>
                <div class="btn-group">
                    <a href="/tasks" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Tasks
                    </a>
                    {% if edit_mode %}
                    <button class="btn btn-success" onclick="saveTask()">
                        <i class="fas fa-save me-2"></i>Save Changes
                    </button>
                    <a href="/tasks/{{ task.id }}" class="btn btn-secondary">
                        <i class="fas fa-times me-2"></i>Cancel
                    </a>
                    {% else %}
                    <a href="/tasks/{{ task.id }}?edit=true" class="btn btn-primary">
                        <i class="fas fa-edit me-2"></i>Edit Task
                    </a>
                    {% endif %}
                </div>
            </div>

            <!-- Main Content Row -->
            <div class="row">
                <!-- Right Panel -->
                <div class="col-lg-4 order-lg-2 mb-4">
                    <!-- Quick Actions -->
                    <div class="card mb-4 border-0 shadow-sm">
                        <div class="card-header bg-primary text-white border-0">
                            <h6 class="card-title mb-0 fw-bold">
                                <i class="fas fa-bolt me-2"></i>Quick Actions
                            </h6>
                        </div>
                        <div class="card-body">
                            <!-- Status Change Actions -->
                            <div class="mb-3">
                                <small class="text-muted d-block mb-2 fw-medium">Task Control</small>
                                {% if task.status == 'Not Started' %}
                                <button class="btn btn-success btn-sm w-100 mb-2" onclick="startTask()">
                                    <i class="fas fa-play me-2"></i>Start Task
                                </button>
                                {% elif task.status == 'In Progress' %}
                                <button class="btn btn-primary btn-sm w-100 mb-2" onclick="endTask()">
                                    <i class="fas fa-check me-2"></i>Complete Task
                                </button>
                                <div class="d-grid gap-1">
                                    <button class="btn btn-warning btn-sm" onclick="updateTaskStatus('Waiting')">
                                        <i class="fas fa-pause me-1"></i>Pause
                                    </button>
                                    <button class="btn btn-secondary btn-sm" onclick="updateTaskStatus('Deferred')">
                                        <i class="fas fa-clock me-1"></i>Defer
                                    </button>
                                </div>
                                {% elif task.status == 'Waiting' or task.status == 'Deferred' %}
                                <button class="btn btn-success btn-sm w-100 mb-2" onclick="updateTaskStatus('In Progress')">
                                    <i class="fas fa-play me-2"></i>Resume Task
                                </button>
                                <button class="btn btn-primary btn-sm w-100 mb-2" onclick="endTask()">
                                    <i class="fas fa-check me-2"></i>Complete Task
                                </button>
                                <button class="btn btn-outline-secondary btn-sm w-100" onclick="updateTaskStatus('Not Started')">
                                    <i class="fas fa-undo me-1"></i>Reset to Not Started
                                </button>
                                {% elif task.status == 'Completed' %}
                                <div class="alert alert-success text-center py-2 mb-2">
                                    <i class="fas fa-check-circle me-1"></i>Task Completed
                                </div>
                                <button class="btn btn-outline-primary btn-sm w-100" onclick="updateTaskStatus('In Progress')">
                                    <i class="fas fa-undo me-1"></i>Reopen Task
                                </button>
                                {% else %}
                                <button class="btn btn-success btn-sm w-100 mb-2" onclick="updateTaskStatus('In Progress')">
                                    <i class="fas fa-play me-2"></i>Start Task
                                </button>
                                <button class="btn btn-primary btn-sm w-100 mb-2" onclick="endTask()">
                                    <i class="fas fa-check me-2"></i>Complete Task
                                </button>
                                <button class="btn btn-outline-secondary btn-sm w-100" onclick="updateTaskStatus('Not Started')">
                                    <i class="fas fa-undo me-1"></i>Reset
                                </button>
                                {% endif %}
                            </div>

                            <!-- Priority Change Actions -->
                            <div class="mb-3">
                                <small class="text-muted d-block mb-2 fw-medium">Change Priority</small>
                                <div class="d-flex gap-1 flex-wrap">
                                    {% if task.priority != 'High' %}
                                    <button class="btn btn-outline-danger btn-sm flex-fill" onclick="updateTaskPriority('High')">
                                        <i class="fas fa-exclamation me-1"></i>High
                                    </button>
                                    {% endif %}
                                    {% if task.priority != 'Medium' %}
                                    <button class="btn btn-outline-warning btn-sm flex-fill" onclick="updateTaskPriority('Medium')">
                                        <i class="fas fa-minus me-1"></i>Medium
                                    </button>
                                    {% endif %}
                                    {% if task.priority != 'Low' %}
                                    <button class="btn btn-outline-info btn-sm flex-fill" onclick="updateTaskPriority('Low')">
                                        <i class="fas fa-arrow-down me-1"></i>Low
                                    </button>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Quick Tasks Actions -->
                            <div class="mb-3">
                                <small class="text-muted d-block mb-2 fw-medium">Quick Tasks</small>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="rescheduleTask()">
                                        <i class="fas fa-calendar me-2"></i>Reschedule
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="duplicateTask()">
                                        <i class="fas fa-copy me-2"></i>Duplicate Task
                                    </button>
                                </div>
                            </div>

                            <!-- Danger Zone -->
                            <div class="mb-0">
                                <small class="text-muted d-block mb-2 fw-medium">Danger Zone</small>
                                <button class="btn btn-outline-danger btn-sm w-100" onclick="deleteTask()">
                                    <i class="fas fa-trash me-2"></i>Delete Task
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Task Details -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-info text-white border-0">
                            <h6 class="card-title mb-0 fw-bold">
                                <i class="fas fa-info-circle me-2"></i>Task Details
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div class="row">
                                    <div class="col-4">
                                        <strong class="text-dark">ID:</strong>
                                    </div>
                                    <div class="col-8">
                                        <span class="text-dark">#{{ task.id }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="row">
                                    <div class="col-4">
                                        <strong class="text-dark">Start Date:</strong>
                                    </div>
                                    <div class="col-8">
                                        <span class="text-dark">
                                            {% if task.start_date %}
                                                {% if task.start_date.__class__.__name__ == 'str' %}
                                                    {{ task.start_date }}
                                                {% else %}
                                                    {{ task.start_date.strftime('%m/%d/%Y') }}
                                                {% endif %}
                                            {% else %}
                                                Not Set
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="row">
                                    <div class="col-4">
                                        <strong class="text-dark">Completed:</strong>
                                    </div>
                                    <div class="col-8">
                                        <span class="text-dark">
                                            {% if task.completed_date %}
                                                {% if task.completed_date.__class__.__name__ == 'str' %}
                                                    {{ task.completed_date }}
                                                {% else %}
                                                    {{ task.completed_date.strftime('%m/%d/%Y') }}
                                                {% endif %}
                                            {% else %}
                                                Not Set
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="row">
                                    <div class="col-4">
                                        <strong class="text-dark">Time Taken:</strong>
                                    </div>
                                    <div class="col-8">
                                        <span class="text-dark">{{ task.time_taken + ' minutes' if task.time_taken else 'Not tracked' }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="row">
                                    <div class="col-4">
                                        <strong class="text-dark">Owner:</strong>
                                    </div>
                                    <div class="col-8">
                                        <span class="text-dark">{{ task.owner or 'Unassigned' }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="row">
                                    <div class="col-4">
                                        <strong class="text-dark">Created:</strong>
                                    </div>
                                    <div class="col-8">
                                        <span class="text-dark">
                                            {% if task.created_date and task.created_date != 'CURRENT_TIMESTAMP' %}
                                                {% if task.created_date.__class__.__name__ == 'str' %}
                                                    {{ task.created_date }}
                                                {% else %}
                                                    {{ task.created_date.strftime('%m/%d/%Y') }}
                                                {% endif %}
                                            {% else %}
                                                Unknown
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            {% if task.related_opportunity_id %}
                            <div class="mb-3">
                                <div class="row">
                                    <div class="col-4">
                                        <strong class="text-dark">Related Opp:</strong>
                                    </div>
                                    <div class="col-8">
                                        <a href="/opportunity/{{ task.related_opportunity_id }}" class="text-primary text-decoration-none">
                                            View Opportunity
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% if task.related_account_id %}
                            <div class="mb-3">
                                <small class="text-muted">Related Account</small>
                                <p class="mb-0">
                                    <a href="/account/{{ task.related_account_id }}">
                                        View Account
                                    </a>
                                </p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Left Panel (Main Content) -->
                <div class="col-lg-8 order-lg-1">
            
            <!-- Task Information -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-tasks me-2 text-primary"></i>Task Information
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if edit_mode %}
                            <form id="taskForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="subject" class="form-label">Subject</label>
                                        <input type="text" class="form-control" id="subject" name="subject" value="{{ task.subject }}" required>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="status" class="form-label">Status</label>
                                        <select class="form-select" id="status" name="status">
                                            <option value="Not Started" {{ 'selected' if task.status == 'Not Started' }}>Not Started</option>
                                            <option value="In Progress" {{ 'selected' if task.status == 'In Progress' }}>In Progress</option>
                                            <option value="Waiting" {{ 'selected' if task.status == 'Waiting' }}>Waiting</option>
                                            <option value="Deferred" {{ 'selected' if task.status == 'Deferred' }}>Deferred</option>
                                            <option value="Completed" {{ 'selected' if task.status == 'Completed' }}>Completed</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="priority" class="form-label">Priority</label>
                                        <select class="form-select" id="priority" name="priority">
                                            <option value="Low" {{ 'selected' if task.priority == 'Low' }}>Low</option>
                                            <option value="Medium" {{ 'selected' if task.priority == 'Medium' }}>Medium</option>
                                            <option value="High" {{ 'selected' if task.priority == 'High' }}>High</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="work_date" class="form-label">Work Date</label>
                                        <input type="date" class="form-control" id="work_date" name="work_date" value="{{ task.work_date }}">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="due_date" class="form-label">Due Date</label>
                                        <input type="date" class="form-control" id="due_date" name="due_date" value="{{ task.due_date }}">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="owner" class="form-label">Owner</label>
                                        <input type="text" class="form-control" id="owner" name="owner" value="{{ task.owner }}">
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="start_date" class="form-label">Start Date</label>
                                        <input type="date" class="form-control" id="start_date" name="start_date" value="{{ task.start_date }}">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="completed_date" class="form-label">Completed Date</label>
                                        <input type="date" class="form-control" id="completed_date" name="completed_date" value="{{ task.completed_date }}">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="time_taken" class="form-label">Time Taken (minutes)</label>
                                        <input type="number" class="form-control" id="time_taken" name="time_taken" value="{{ task.time_taken }}">
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="contact_id" class="form-label">Contact</label>
                                        <select class="form-select" id="contact_id" name="contact_id">
                                            <option value="">Select Contact</option>
                                            <!-- Contacts will be loaded via JavaScript -->
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="account_id" class="form-label">Account</label>
                                        <select class="form-select" id="account_id" name="account_id">
                                            <option value="">Select Account</option>
                                            <!-- Accounts will be loaded via JavaScript -->
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="opportunity_id" class="form-label">Opportunity</label>
                                        <select class="form-select" id="opportunity_id" name="opportunity_id">
                                            <option value="">Select Opportunity</option>
                                            <!-- Opportunities will be loaded via JavaScript -->
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="quote_id" class="form-label">Quote</label>
                                        <select class="form-select" id="quote_id" name="quote_id">
                                            <option value="">Select Quote</option>
                                            <!-- Quotes will be loaded via JavaScript -->
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="description" class="form-label">Description</label>
                                    <textarea class="form-control" id="description" name="description" rows="4">{{ task.description }}</textarea>
                                </div>
                            </form>
                            {% else %}
                            <!-- View Mode -->
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <h6 class="text-muted">Subject</h6>
                                    <p class="mb-0">{{ task.subject }}</p>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <h6 class="text-muted">Status</h6>
                                    <span class="badge bg-{{ 'secondary' if task.status == 'Not Started' else 'primary' if task.status == 'In Progress' else 'warning' if task.status == 'Waiting' else 'info' if task.status == 'Deferred' else 'success' }}">
                                        {{ task.status }}
                                    </span>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <h6 class="text-muted">Priority</h6>
                                    <span class="badge bg-{{ 'danger' if task.priority == 'High' else 'warning' if task.priority == 'Medium' else 'secondary' }}">
                                        {{ task.priority or 'Medium' }}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div class="border rounded p-2 bg-light">
                                        <h6 class="text-muted mb-1"><i class="fas fa-calendar-alt me-1"></i>Work Date</h6>
                                        <p class="mb-0 fw-semibold">{{ task.work_date or 'Not set' }}</p>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="border rounded p-2 bg-light">
                                        <h6 class="text-muted mb-1"><i class="fas fa-clock me-1"></i>Due Date</h6>
                                        <p class="mb-0 fw-semibold">{{ task.due_date or 'Not set' }}</p>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="border rounded p-2 bg-light">
                                        <h6 class="text-muted mb-1"><i class="fas fa-hourglass-half me-1"></i>Days Till Due</h6>
                                        {% if task.days_till_due is not none %}
                                            <span class="badge bg-{{ 'danger' if task.days_till_due < 0 else 'warning' if task.days_till_due == 0 else 'success' }} fs-6">
                                                {{ task.days_till_due }} days
                                            </span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="border rounded p-2 bg-light">
                                        <h6 class="text-muted mb-1"><i class="fas fa-exclamation-triangle me-1"></i>Past Due</h6>
                                        {% if task.past_due %}
                                            <span class="badge bg-danger fs-6"><i class="fas fa-times me-1"></i>Yes</span>
                                        {% else %}
                                            <span class="badge bg-success fs-6"><i class="fas fa-check me-1"></i>No</span>
                                        {% endif %}
                                    </div>
                                </div>

                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="border rounded p-2 bg-light">
                                        <h6 class="text-muted mb-1"><i class="fas fa-calendar-check me-1"></i>Scheduled</h6>
                                        <span class="badge bg-{{ 'success' if task.scheduled == 'Scheduled' else 'warning' }} fs-6">
                                            {{ task.scheduled }}
                                        </span>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="border rounded p-2 bg-light">
                                        <h6 class="text-muted mb-1"><i class="fas fa-stopwatch me-1"></i>Countdown</h6>
                                        <span class="badge bg-{{ 'success' if 'Completed' in task.countdown else 'danger' if 'overdue' in task.countdown else 'warning' if 'Due Today' in task.countdown else 'primary' }} fs-6">
                                            {{ task.countdown }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            {% if task.parent_item_type %}
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <h6 class="text-muted">Parent Item</h6>
                                    <div class="d-flex flex-wrap gap-1">
                                        {% if task.parent_item_type == 'Account' and task.account_name %}
                                            <span class="badge bg-light text-dark">
                                                <i class="fas fa-building me-1"></i>{{ task.account_name }}
                                            </span>
                                        {% elif task.parent_item_type == 'Contact' and task.contact_name %}
                                            <span class="badge bg-light text-dark">
                                                <i class="fas fa-user me-1"></i>{{ task.contact_name }}
                                            </span>
                                        {% elif task.parent_item_type == 'Opportunity' and task.opportunity_name %}
                                            <span class="badge bg-light text-dark">
                                                <i class="fas fa-handshake me-1"></i>{{ task.opportunity_name }}
                                            </span>
                                        {% elif task.parent_item_type == 'Product' and task.product_name %}
                                            <span class="badge bg-light text-dark">
                                                <i class="fas fa-box me-1"></i>{{ task.product_name }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">{{ task.parent_item_type }} #{{ task.parent_item_id }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if task.clean_description or task.description %}
                            <div class="mb-3">
                                <h6 class="text-muted">Description</h6>
                                <div class="border rounded p-3 bg-light" id="taskDescription">
                                    {% if task.clean_description %}
                                        {{ task.clean_description | replace('\n', '<br>') | safe }}
                                    {% else %}
                                        {{ task.description | replace('\n', '<br>') | safe }}
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>

                    <!-- Related Opportunities (for processing tasks) -->
                    {% if opportunities %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-handshake me-2 text-primary"></i>Newly Created Opportunities
                            </h5>
                            <small class="text-muted">Opportunities created during this PDF processing session</small>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover" id="opportunitiesTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Request Number</th>
                                            <th>NSN</th>
                                            <th>Quantity</th>
                                            <th>Buyer</th>
                                            <th>Close Date</th>
                                            <th>Stage</th>
                                            <th class="text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for opp in opportunities %}
                                        <tr ondblclick="viewOpportunity({{ opp.id }})" style="cursor: pointer;">
                                            <td>
                                                <code class="small">{{ opp.name or opp.request_number or opp.solicitation_number or 'N/A' }}</code>
                                            </td>
                                            <td>
                                                <span class="small">{{ opp.product_nsn or 'N/A' }}</span>
                                            </td>
                                            <td>
                                                <span class="fw-bold">{{ opp.quantity or 'N/A' }}</span>
                                                {% if opp.unit %}
                                                <small class="text-muted">{{ opp.unit }}</small>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="text-truncate" style="max-width: 120px;" title="{{ opp.buyer or 'Unknown' }}">
                                                    {{ opp.buyer or 'Unknown' }}
                                                </div>
                                            </td>
                                            <td>
                                                {% if opp.close_date %}
                                                <small>{{ opp.close_date | date }}</small>
                                                {% else %}
                                                <span class="text-muted">Not set</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="badge bg-{{ 'primary' if opp.stage == 'Prospecting' else 'info' if opp.stage == 'Qualification' else 'warning' if opp.stage == 'Proposal' else 'success' if opp.stage == 'Won' else 'danger' if opp.stage == 'Lost' else 'secondary' }}">
                                                    {{ opp.stage or 'Unknown' }}
                                                </span>
                                            </td>
                                            <td class="text-center">
                                                <div class="btn-group btn-group-sm">
                                                    <button type="button" class="btn btn-outline-primary" onclick="viewOpportunity({{ opp.id }})" title="View Details">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary" onclick="editOpportunity({{ opp.id }})" title="Edit">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-danger" onclick="deleteOpportunity({{ opp.id }})" title="Delete">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3">
                                <div class="row text-center">
                                    <div class="col-3">
                                        <h6 class="text-primary mb-1">{{ opportunities|length }}</h6>
                                        <small class="text-muted">Total Created</small>
                                    </div>
                                    <div class="col-3">
                                        <h6 class="text-success mb-1">{{ opportunities|selectattr('stage', 'equalto', 'Qualification')|list|length }}</h6>
                                        <small class="text-muted">In Qualification</small>
                                    </div>
                                    <div class="col-3">
                                        <h6 class="text-info mb-1">{{ opportunities|selectattr('stage', 'equalto', 'Proposal')|list|length }}</h6>
                                        <small class="text-muted">In Proposal</small>
                                    </div>
                                    <div class="col-3">
                                        <h6 class="text-warning mb-1">{{ opportunities|selectattr('stage', 'equalto', 'Prospecting')|list|length }}</h6>
                                        <small class="text-muted">New/Prospecting</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Processing Report (for PDF processing tasks) -->
                    {% if processing_data %}
                    <div class="card mb-4">
                        <div class="card-header d-flex align-items-center">
                            <div class="bg-success bg-opacity-10 rounded-circle p-2 me-3">
                                <i class="fas fa-chart-bar text-success"></i>
                            </div>
                            <div>
                                <h5 class="card-title mb-0">Records Created During Processing</h5>
                                <small class="text-muted">Double-click any record to view details</small>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Opportunities -->
                                <div class="col-md-6 mb-4">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-handshake text-primary me-2"></i>
                                        <h6 class="text-primary mb-0">Opportunities ({{ processing_data.created_opportunities|length if processing_data.created_opportunities else 0 }})</h6>
                                    </div>
                                    {% if processing_data.created_opportunities %}
                                        {% for opp in processing_data.created_opportunities %}
                                        <div class="mb-2 p-2 bg-light rounded small" ondblclick="viewOpportunity({{ opp.id }})" style="cursor: pointer;" title="Double-click to view details">
                                            <div class="fw-bold">{{ opp.request_number or 'Unknown' }}</div>
                                            <div class="text-muted">NSN: {{ opp.nsn or 'N/A' }}</div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-muted small">• None</div>
                                    {% endif %}
                                </div>
                                
                                <!-- Contacts -->
                                <div class="col-md-6 mb-4">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-user text-success me-2"></i>
                                        <h6 class="text-success mb-0">Contacts ({{ processing_data.created_contacts|length if processing_data.created_contacts else 0 }})</h6>
                                    </div>
                                    {% if processing_data.created_contacts %}
                                        {% for contact in processing_data.created_contacts %}
                                        <div class="mb-2 p-2 bg-light rounded small" ondblclick="viewContact({{ contact.id }})" style="cursor: pointer;" title="Double-click to view details">
                                            <div class="fw-bold">{{ contact.name or 'Unknown' }}</div>
                                            <div class="text-muted">{{ contact.email or 'No email' }}</div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-muted small">• None</div>
                                    {% endif %}
                                </div>
                                
                                <!-- Accounts -->
                                <div class="col-md-6 mb-4">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-building text-info me-2"></i>
                                        <h6 class="text-info mb-0">Accounts ({{ processing_data.created_accounts|length if processing_data.created_accounts else 0 }})</h6>
                                    </div>
                                    {% if processing_data.created_accounts %}
                                        {% for account in processing_data.created_accounts %}
                                        <div class="mb-2 p-2 bg-light rounded small" ondblclick="viewAccount({{ account.id }})" style="cursor: pointer;" title="Double-click to view details">
                                            <div class="fw-bold">{{ account.name or 'Unknown' }}</div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-muted small">• None</div>
                                    {% endif %}
                                </div>
                                
                                <!-- Products -->
                                <div class="col-md-6 mb-4">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-box text-warning me-2"></i>
                                        <h6 class="text-warning mb-0">Products ({{ processing_data.created_products|length if processing_data.created_products else 0 }})</h6>
                                    </div>
                                    {% if processing_data.created_products %}
                                        {% for product in processing_data.created_products %}
                                        <div class="mb-2 p-2 bg-light rounded small" ondblclick="viewProduct({{ product.id }})" style="cursor: pointer;" title="Double-click to view details">
                                            <div class="fw-bold">NSN: {{ product.nsn or 'Unknown NSN' }}</div>
                                            <div class="text-muted">{{ product.name or 'Unknown Product' }}</div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-muted small">• None</div>
                                    {% endif %}
                                </div>
                                
                                <!-- QPLs -->
                                <div class="col-md-6 mb-4">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-list-alt text-purple me-2"></i>
                                        <h6 class="text-purple mb-0">QPLs ({{ processing_data.created_qpls|length if processing_data.created_qpls else 0 }})</h6>
                                    </div>
                                    {% if processing_data.created_qpls %}
                                        {% for qpl in processing_data.created_qpls %}
                                        <div class="mb-2 p-2 bg-light rounded small" ondblclick="viewQPL({{ qpl.id }})" style="cursor: pointer;" title="Double-click to view details">
                                            <div class="fw-bold">{{ qpl.name or 'Unknown QPL' }}</div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-muted small">• None</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Records Updated Section -->
                            <div class="border-top pt-3">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-edit text-secondary me-2"></i>
                                    <h6 class="text-secondary mb-0">Records Updated During Processing</h6>
                                </div>
                                {% if processing_data.updated_records %}
                                    <div class="text-muted">Updated {{ processing_data.updated_records|length }} existing records</div>
                                {% else %}
                                    <div class="text-muted">No records updated</div>
                                {% endif %}
                            </div>
                            
                            <!-- Processing Summary -->
                            <div class="border-top pt-3 mt-3">
                                <h6 class="mb-2">Processing Summary:</h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="text-center p-2 bg-primary bg-opacity-10 rounded">
                                            <div class="h4 text-primary mb-0">{{ processing_data.processed or 0 }}</div>
                                            <small class="text-muted">Processed</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center p-2 bg-success bg-opacity-10 rounded">
                                            {% set total_created = (processing_data.created_opportunities|length if processing_data.created_opportunities else 0) + (processing_data.created_contacts|length if processing_data.created_contacts else 0) + (processing_data.created_accounts|length if processing_data.created_accounts else 0) + (processing_data.created_products|length if processing_data.created_products else 0) + (processing_data.created_qpls|length if processing_data.created_qpls else 0) %}
                                            <div class="h4 text-success mb-0">{{ total_created }}</div>
                                            <small class="text-muted">Created</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center p-2 bg-warning bg-opacity-10 rounded">
                                            <div class="h4 text-warning mb-0">{{ processing_data.skipped or 0 }}</div>
                                            <small class="text-muted">Skipped</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center p-2 bg-danger bg-opacity-10 rounded">
                                            <div class="h4 text-danger mb-0">{{ processing_data.errors|length if processing_data.errors else 0 }}</div>
                                            <small class="text-muted">Errors</small>
                                        </div>
                                    </div>
                                </div>
                                
                                {% if processing_data.errors %}
                                <div class="mt-3">
                                    <h6 class="text-danger">Errors Encountered:</h6>
                                    {% for error in processing_data.errors %}
                                    <div class="alert alert-danger small mb-1">• {{ error }}</div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Processing Report (for processing tasks) -->
                    {% if processing_report %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-file-alt me-2 text-info"></i>Processing Report
                            </h5>
                            <small class="text-muted">Detailed report from PDF processing operation</small>
                        </div>
                        <div class="card-body">
                            <div class="bg-light p-3 rounded">
                                <pre class="mb-0 small">{{ processing_report }}</pre>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

<!-- jQuery and DataTables JS -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
function saveTask() {
    const form = document.getElementById('taskForm');
    const formData = new FormData(form);
    
    fetch('/tasks/{{ task.id }}', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            window.location.href = '/tasks/{{ task.id }}';
        } else {
            alert('Failed to save task');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to save task');
    });
}

function updateTaskStatus(status) {
    fetch('/tasks/{{ task.id }}/status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ status: status })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Failed to update task: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update task');
    });
}

function rescheduleTask() {
    const newDate = prompt('Enter new due date (YYYY-MM-DD):');
    if (newDate) {
        fetch('/tasks/{{ task.id }}/reschedule', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ due_date: newDate })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to reschedule task: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to reschedule task');
        });
    }
}

function deleteTask() {
    if (confirm('Are you sure you want to delete this task?')) {
        fetch('/tasks/{{ task.id }}', {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '/tasks';
            } else {
                alert('Failed to delete task: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete task');
        });
    }
}

function duplicateTask() {
    if (confirm('Create a duplicate of this task?')) {
        fetch('/tasks/{{ task.id }}/duplicate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '/tasks/' + data.task_id;
            } else {
                alert('Failed to duplicate task: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to duplicate task');
        });
    }
}

function updateTaskPriority(priority) {
    fetch('/tasks/{{ task.id }}/priority', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ priority: priority })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Failed to update priority: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update priority');
    });
}

function startTask() {
    fetch('/tasks/{{ task.id }}/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            console.error('Failed to start task:', data.error);
        }
    })
    .catch(error => {
        console.error('Error starting task:', error);
    });
}

function endTask() {
    fetch('/tasks/{{ task.id }}/end', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            console.error('Failed to complete task:', data.error);
        }
    })
    .catch(error => {
        console.error('Error completing task:', error);
    });
}

// Opportunities table functions
function viewOpportunity(oppId) {
    window.location.href = '/opportunity/' + oppId;
}

function editOpportunity(oppId) {
    // Navigate to opportunity detail page with edit mode
    window.location.href = '/opportunity/' + oppId + '?edit=true';
}

function deleteOpportunity(oppId) {
    if (confirm('Are you sure you want to delete this opportunity? This action cannot be undone.')) {
        fetch('/api/opportunities/' + oppId, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to delete opportunity: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete opportunity');
        });
    }
}

// Record navigation functions
function viewContact(contactId) {
    window.location.href = '/contact/' + contactId;
}

function viewAccount(accountId) {
    window.location.href = '/account/' + accountId;
}

function viewProduct(productId) {
    window.location.href = '/products#product-' + productId;
}

function viewQPL(qplId) {
    window.location.href = '/qpl/' + qplId;
}

// Function to make URLs clickable
function makeUrlsClickable(text) {
    // Updated regex to stop at HTML tags and common punctuation that ends URLs
    const urlRegex = /(https?:\/\/[^\s<>"']+?)(?=\s|<|$|[.!?](?:\s|<|$))/g;
    return text.replace(urlRegex, '<a href="$1" target="_blank" class="text-primary text-decoration-none">$1</a>');
}

// Initialize DataTables when document is ready
$(document).ready(function() {
    // Make URLs clickable in task description
    const descriptionElement = document.getElementById('taskDescription');
    if (descriptionElement) {
        const originalContent = descriptionElement.innerHTML;
        descriptionElement.innerHTML = makeUrlsClickable(originalContent);
    }
    
    // Initialize opportunities table with pagination
    if ($('#opportunitiesTable').length) {
        $('#opportunitiesTable').DataTable({
            pageLength: 10,
            responsive: true,
            order: [[4, 'desc']], // Sort by close date descending
            language: {
                search: "Search opportunities:",
                lengthMenu: "Show _MENU_ opportunities per page",
                info: "Showing _START_ to _END_ of _TOTAL_ opportunities",
                emptyTable: "No opportunities found for this task"
            },
            columnDefs: [
                { orderable: false, targets: 6 } // Disable sorting on Actions column (0-indexed, so Actions = 6)
            ]
        });
    }
});

// Load dropdown data for task form
function loadTaskDropdowns() {
    // Load contacts
    fetch('/api/contacts')
        .then(response => response.json())
        .then(contacts => {
            const contactSelect = document.getElementById('contact_id');
            if (contactSelect) {
                contactSelect.innerHTML = '<option value="">Select Contact</option>';
                contacts.forEach(contact => {
                    const option = document.createElement('option');
                    option.value = contact.id;
                    option.textContent = `${contact.first_name || ''} ${contact.last_name || ''}`.trim() + 
                                       (contact.email ? ` (${contact.email})` : '');
                    contactSelect.appendChild(option);
                });
            }
        })
        .catch(error => console.error('Error loading contacts:', error));
    
    // Load accounts
    fetch('/api/accounts')
        .then(response => response.json())
        .then(data => {
            const accountSelect = document.getElementById('account_id');
            if (accountSelect) {
                accountSelect.innerHTML = '<option value="">Select Account</option>';
                const accounts = data.success && data.accounts ? data.accounts : (Array.isArray(data) ? data : []);
                accounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.id;
                    option.textContent = account.name || `Account #${account.id}`;
                    accountSelect.appendChild(option);
                });
            }
        })
        .catch(error => console.error('Error loading accounts:', error));
    
    // Load opportunities
    fetch('/api/opportunities')
        .then(response => response.json())
        .then(opportunities => {
            const opportunitySelect = document.getElementById('opportunity_id');
            if (opportunitySelect) {
                opportunitySelect.innerHTML = '<option value="">Select Opportunity</option>';
                opportunities.forEach(opportunity => {
                    const option = document.createElement('option');
                    option.value = opportunity.id;
                    option.textContent = opportunity.name || `Opportunity #${opportunity.id}`;
                    opportunitySelect.appendChild(option);
                });
            }
        })
        .catch(error => console.error('Error loading opportunities:', error));
    
    // Load quotes
    fetch('/api/quotes')
        .then(response => response.json())
        .then(quotes => {
            const quoteSelect = document.getElementById('quote_id');
            if (quoteSelect) {
                quoteSelect.innerHTML = '<option value="">Select Quote</option>';
                quotes.forEach(quote => {
                    const option = document.createElement('option');
                    option.value = quote.id;
                    option.textContent = quote.name || `Quote #${quote.id}`;
                    quoteSelect.appendChild(option);
                });
            }
        })
        .catch(error => console.error('Error loading quotes:', error));
}

// Load dropdowns when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadTaskDropdowns();
});
</script>
{% endblock %}
