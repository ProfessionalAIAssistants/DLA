{% extends "base.html" %}

{% block title %}Dashboard - CDE Prosperity{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Modern Header -->
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h1 class="display-6 fw-bold mb-2">
                <i class="fas fa-tachometer-alt me-3" style="background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></i>
                Dashboard
            </h1>
            <p class="text-muted mb-0 fs-5">Overview of your business performance</p>
        </div>
        <div class="d-flex gap-3">
            <button type="button" class="btn btn-primary btn-lg" onclick="loadPDFs()" id="loadPDFsBtn">
                <i class="fas fa-file-pdf me-2"></i>
                Load PDFs
                <span class="badge bg-warning ms-2" id="pdfCount" onclick="loadPDFCount()" style="cursor: pointer;" title="Click to refresh">Loading...</span>
            </button>
            <button type="button" class="btn btn-danger btn-lg" onclick="clearAllData()" id="clearDataBtn" title="Development Only: Clear all database data">
                <i class="fas fa-trash-alt me-2"></i>
                Clear All Data
                <span class="badge bg-light text-dark ms-2">DEV</span>
            </button>
            <button type="button" class="btn btn-outline-primary btn-lg">
                <i class="fas fa-calendar-day me-2"></i>
                Today: <span id="currentDate"></span>
            </button>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="row mb-5">
        <div class="col-md-3">
            <div class="card card-metric h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-dark mb-2 text-uppercase fw-bold" style="font-size: 0.75rem; letter-spacing: 1px; opacity: 0.8;">Pipeline Value</h6>
                        <h2 class="mb-0 fw-bold text-dark">{{ data.metrics.total_pipeline_value | currency if data and data.metrics else "$0" }}</h2>
                        <small class="text-dark" style="opacity: 0.7;">Active opportunities</small>
                    </div>
                    <div class="ms-3">
                        <div class="rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 50px; height: 50px; background: rgba(255,255,255,0.2);">
                            <i class="fas fa-chart-line fa-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-metric success h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-dark mb-2 text-uppercase fw-bold" style="font-size: 0.75rem; letter-spacing: 1px; opacity: 0.8;">Total Won</h6>
                        <h2 class="mb-0 fw-bold text-dark">{{ data.metrics.total_won_value | currency if data and data.metrics else "$0" }}</h2>
                        <small class="text-dark" style="opacity: 0.7;">Successful bids</small>
                    </div>
                    <div class="ms-3">
                        <div class="rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 50px; height: 50px; background: rgba(255,255,255,0.2);">
                            <i class="fas fa-trophy fa-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-metric warning h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-dark mb-2 text-uppercase fw-bold" style="font-size: 0.75rem; letter-spacing: 1px; opacity: 0.8;">Pending Tasks</h6>
                        <h2 class="mb-0 fw-bold text-dark">{{ data.metrics.pending_tasks if data and data.metrics else 0 }}</h2>
                        <small class="text-dark" style="opacity: 0.7;">Need attention</small>
                    </div>
                    <div class="ms-3">
                        <div class="rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 50px; height: 50px; background: rgba(255,255,255,0.2);">
                            <i class="fas fa-tasks fa-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-metric danger h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-dark mb-2 text-uppercase fw-bold" style="font-size: 0.75rem; letter-spacing: 1px; opacity: 0.8;">Overdue Tasks</h6>
                        <h2 class="mb-0 fw-bold text-dark">{{ data.metrics.overdue_tasks if data and data.metrics else 0 }}</h2>
                        <small class="text-dark" style="opacity: 0.7;">Require action</small>
                    </div>
                    <div class="ms-3">
                        <div class="rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 50px; height: 50px; background: rgba(255,255,255,0.2);">
                            <i class="fas fa-exclamation-triangle fa-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar and Upcoming Events -->
    <div class="row mb-5">
        <!-- Interactive Calendar -->
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>CDE Prosperity Calendar
                    </h5>
                </div>
                <div class="card-body p-2">
                    <!-- Calendar container -->
                    <div id="dashboard-calendar" style="min-height: 600px; height: auto; overflow: visible;"></div>
                </div>
            </div>
        </div>

        <!-- Upcoming Events Sidebar -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clock me-2"></i>Upcoming Events
                    </h5>
                    <span class="badge bg-primary" id="upcomingCount">0</span>
                </div>
                <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                    <div id="upcoming-events-list">
                        <!-- Events will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Opportunities Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-dollar-sign me-2"></i>Recent Opportunities
                    </h5>
                    <a href="{{ url_for('opportunities') }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-arrow-right me-1"></i>View All
                    </a>
                </div>
                <div class="card-body">
                    {% if data.recent_opportunities %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Opportunity</th>
                                        <th>Buyer</th>
                                        <th>Stage</th>
                                        <th>State</th>
                                        <th>Bid Price</th>
                                        <th>Quantity</th>
                                        <th>Close Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for opp in data.recent_opportunities[:10] %}
                                    <tr class="opportunity-row" 
                                        ondblclick="window.location.href='{{ url_for('opportunity_detail', opportunity_id=opp.id) }}'" 
                                        style="cursor: pointer;" 
                                        title="Double-click to view details">
                                        <td>
                                            <strong>{{ opp.name }}</strong>
                                            {% if opp.mfr %}
                                            <br><small class="text-muted">MFR: {{ opp.mfr[:30] }}{{ '...' if opp.mfr|length > 30 else '' }}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-primary">
                                                <i class="fas fa-user me-1"></i>{{ opp.buyer or 'Not assigned' }}
                                            </small>
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if opp.stage == 'Project Started' else 'warning' if opp.stage == 'Submit Bid' else 'info' if opp.stage == 'RFQ Received' else 'secondary' if opp.stage == 'RFQ Requested' else 'primary' }}">
                                                {{ opp.stage or 'Prospecting' }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if opp.state == 'Won' else 'danger' if opp.state == 'Bid Lost' else 'warning' if opp.state in ['Past Due', 'No Bid'] else 'primary' }}">
                                                {{ opp.state or 'Active' }}
                                            </span>
                                        </td>
                                        <td>
                                            <strong class="text-success">{{ opp.bid_price | currency if opp.bid_price else 'TBD' }}</strong>
                                        </td>
                                        <td>
                                            <span class="badge bg-light text-dark">
                                                {{ opp.quantity or 'N/A' }}{{ ' ' + opp.unit if opp.unit else '' }}
                                            </span>
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                <i class="fas fa-calendar me-1"></i>{{ opp.close_date | date if opp.close_date else 'No close date' }}
                                            </small>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <a href="{{ url_for('opportunity_detail', opportunity_id=opp.id) }}" class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation();" title="View Details">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteOpportunity({{ opp.id }}, '{{ opp.name }}')" title="Delete Opportunity">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-dollar-sign fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No recent opportunities</h5>
                            <p class="text-muted">Recent opportunities will appear here once they are created.</p>
                            <a href="{{ url_for('opportunities') }}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Create Opportunity
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

<!-- Main Content Row -->
<div class="row">
    <!-- Task Schedule -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="taskRangeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <span id="currentTaskRange">Today's Tasks</span>
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="taskRangeDropdown">
                        <li><a class="dropdown-item" href="#" onclick="showTasks('today')">Today's Tasks</a></li>
                        <li><a class="dropdown-item" href="#" onclick="showTasks('this_week')">This Week</a></li>
                        <li><a class="dropdown-item" href="#" onclick="showTasks('next_week')">Next Week</a></li>
                    </ul>
                </div>
                <a href="{{ url_for('tasks') }}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body">
                <!-- Today's Tasks -->
                <div id="today-tasks" class="task-range active">
                    {% if data.today_tasks %}
                        {% for task in data.today_tasks %}
                        <div class="d-flex justify-content-between align-items-center border-bottom py-2 task-item" 
                             ondblclick="window.location.href='{{ url_for('task_detail', task_id=task.id) }}'" 
                             style="cursor: pointer;" 
                             title="Double-click to view details">
                            <div>
                                <h6 class="mb-1">{{ task.subject }}</h6>
                                <small class="text-muted">
                                    <i class="fas fa-user me-1"></i>{{ task.assigned_to or 'Unassigned' }}
                                    <span class="badge bg-{{ 'danger' if task.priority == 'High' else 'warning' if task.priority == 'Normal' else 'secondary' }} ms-2">
                                        {{ task.priority }}
                                    </span>
                                </small>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); completeTask({{ task.id }})" title="Mark Complete">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteTask({{ task.id }})" title="Delete Task">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No tasks scheduled for today.</p>
                    {% endif %}
                </div>
                
                <!-- This Week's Tasks -->
                <div id="this_week-tasks" class="task-range" style="display: none;">
                    {% if data.this_week_tasks %}
                        {% for task in data.this_week_tasks %}
                        <div class="d-flex justify-content-between align-items-center border-bottom py-2 task-item" 
                             ondblclick="window.location.href='{{ url_for('task_detail', task_id=task.id) }}'" 
                             style="cursor: pointer;" 
                             title="Double-click to view details">
                            <div>
                                <h6 class="mb-1">{{ task.subject }}</h6>
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i>{{ task.due_date if task.due_date else 'No due date' }}
                                    <i class="fas fa-user ms-2 me-1"></i>{{ task.assigned_to or 'Unassigned' }}
                                    <span class="badge bg-{{ 'danger' if task.priority == 'High' else 'warning' if task.priority == 'Normal' else 'secondary' }} ms-2">
                                        {{ task.priority }}
                                    </span>
                                </small>
                            </div>
                            <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); completeTask({{ task.id }})">
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No tasks scheduled for this week.</p>
                    {% endif %}
                </div>
                
                <!-- Next Week's Tasks -->
                <div id="next_week-tasks" class="task-range" style="display: none;">
                    {% if data.next_week_tasks %}
                        {% for task in data.next_week_tasks %}
                        <div class="d-flex justify-content-between align-items-center border-bottom py-2 task-item" 
                             ondblclick="window.location.href='{{ url_for('task_detail', task_id=task.id) }}'" 
                             style="cursor: pointer;" 
                             title="Double-click to view details">
                            <div>
                                <h6 class="mb-1">{{ task.subject }}</h6>
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i>{{ task.due_date if task.due_date else 'No due date' }}
                                    <i class="fas fa-user ms-2 me-1"></i>{{ task.assigned_to or 'Unassigned' }}
                                    <span class="badge bg-{{ 'danger' if task.priority == 'High' else 'warning' if task.priority == 'Normal' else 'secondary' }} ms-2">
                                        {{ task.priority }}
                                    </span>
                                </small>
                            </div>
                            <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); completeTask({{ task.id }})">
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No tasks scheduled for next week.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Overdue Tasks -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0 text-danger">Overdue Tasks</h5>
                <a href="{{ url_for('tasks') }}?status=overdue" class="btn btn-sm btn-outline-danger">View All</a>
            </div>
            <div class="card-body">
                {% if data.overdue_tasks %}
                    {% for task in data.overdue_tasks[:5] %}
                    <div class="d-flex justify-content-between align-items-center border-bottom py-2 task-item" 
                         ondblclick="window.location.href='{{ url_for('task_detail', task_id=task.id) }}'" 
                         style="cursor: pointer;" 
                         title="Double-click to view details">
                        <div>
                            <h6 class="mb-1">{{ task.subject }}</h6>
                            <small class="text-muted">
                                Due: {{ task.due_date | date }}
                                <span class="badge bg-danger ms-2">{{ task.priority }}</span>
                            </small>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); completeTask({{ task.id }})" title="Mark Complete">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteTask({{ task.id }})" title="Delete Task">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No overdue tasks.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <!-- New Quotes -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Recent Quotes</h5>
                <a href="{{ url_for('rfqs') }}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body">
                {% if data.new_rfqs %}
                    {% for rfq in data.new_rfqs %}
                    <div class="border-bottom py-2 rfq-item" 
                         ondblclick="window.location.href='{{ url_for('rfq_detail', rfq_id=rfq.id) }}'" 
                         style="cursor: pointer;" 
                         title="Double-click to view details">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">
                                    <a href="{{ url_for('rfq_detail', rfq_id=rfq.id) }}" class="text-decoration-none">
                                        Quote {{ rfq.request_number }}
                                    </a>
                                </h6>
                                <small class="text-muted">
                                    {{ (rfq.product_description or 'No description')[:50] }}...
                                    <br>
                                    NSN: {{ rfq.nsn or 'N/A' }} | Close: {{ rfq.close_date | date }}
                                </small>
                            </div>
                            <span class="badge bg-{{ 'success' if rfq.status == 'Qualified' else 'primary' if rfq.status == 'New' else 'secondary' }}">
                                {{ rfq.status }}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No recent quotes.</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Closing Opportunities -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Closing Soon</h5>
                <a href="{{ url_for('opportunities') }}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body">
                {% if data.closing_opportunities %}
                    {% for opp in data.closing_opportunities %}
                    <div class="border-bottom py-2 opportunity-item" 
                         ondblclick="window.location.href='{{ url_for('opportunity_detail', opportunity_id=opp.id) }}'" 
                         style="cursor: pointer;" 
                         title="Double-click to view details">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">{{ opp.name }}</h6>
                                <small class="text-muted">
                                    {{ opp.bid_price | currency }} | {{ opp.stage }} | Close: {{ opp.close_date | date }}
                                </small>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-{{ 'warning' if opp.stage == 'Negotiation' else 'info' if opp.stage == 'Proposal' else 'primary' }}">
                                    {{ opp.stage }}
                                </span>
                                <div class="btn-group" role="group">
                                    <a href="{{ url_for('opportunity_detail', opportunity_id=opp.id) }}" class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation();" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteOpportunity({{ opp.id }}, '{{ opp.name }}')" title="Delete Opportunity">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No opportunities closing soon.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Recent Activity</h5>
                <a href="{{ url_for('interactions') }}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body">
                {% if data.recent_interactions %}
                    {% for interaction in data.recent_interactions %}
                    <div class="d-flex justify-content-between align-items-center border-bottom py-2 interaction-item" 
                         ondblclick="window.location.href='{{ url_for('interaction_detail', interaction_id=interaction.id) }}'" 
                         style="cursor: pointer;" 
                         title="Double-click to view details">
                        <div>
                            <h6 class="mb-1">{{ interaction.subject }}</h6>
                            <small class="text-muted">
                                <i class="fas fa-{{ 'phone' if interaction.type == 'Call' else 'envelope' if interaction.type == 'Email' else 'users' if interaction.type == 'Meeting' else 'comment' }} me-1"></i>
                                {{ interaction.type }} - {{ interaction.interaction_date | datetime }}
                                {% if interaction.account_name %}
                                    | {{ interaction.account_name }}
                                {% endif %}
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No recent activity.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- FullCalendar CSS via CDN -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<!-- FullCalendar JS via CDN -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
    let calendar;
    let currentView = 'dayGridMonth';
    
    // Display current date
    document.addEventListener('DOMContentLoaded', function() {
        const dateElement = document.getElementById('currentDate');
        if (dateElement) {
            const today = new Date();
            const options = { year: 'numeric', month: 'short', day: '2-digit' };
            dateElement.textContent = today.toLocaleDateString('en-US', options);
        }
        
        // Initialize calendar
        initializeCalendar();
        
        // Add manual today button fix
        setTimeout(() => {
            if (calendar) {
                // Force the calendar to today's date
                calendar.today();
                console.log('Calendar forced to today');
            }
        }, 2000);
        
        // Load upcoming events
        loadUpcomingEvents();
        
        // Load PDF count on page load
        setTimeout(() => {
            loadPDFCount();
        }, 1000); // Add a delay to ensure DOM is ready
        
        // Also try loading it again after a longer delay in case there are issues
        setTimeout(() => {
            loadPDFCount();
        }, 3000);
    });
    
    // Initialize FullCalendar
    function initializeCalendar() {
        const calendarEl = document.getElementById('dashboard-calendar');
        
        console.log('Initializing calendar...');
        
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,listWeek'
            },
            height: 'auto',
            contentHeight: 'auto',
            aspectRatio: 1.8,
            expandRows: true,
            handleWindowResize: true,
            now: new Date(),
            events: function(fetchInfo, successCallback, failureCallback) {
                console.log('Loading calendar events...');
                fetch('/api/calendar-events', {
                    method: 'GET'
                })
                .then(response => {
                    console.log('Calendar API response status:', response.status);
                    return response.json();
                })
                .then(events => {
                    console.log('Calendar events loaded:', events.length);
                    successCallback(events);
                })
                .catch(error => {
                    console.error('Error loading calendar events:', error);
                    failureCallback(error);
                });
            },
            eventClick: function(info) {
                showEventModal(info.event);
            },
            eventMouseEnter: function(info) {
                // Show tooltip
                const tooltip = document.createElement('div');
                tooltip.className = 'calendar-tooltip';
                tooltip.innerHTML = `
                    <strong>${info.event.title}</strong><br>
                    ${info.event.extendedProps.description || ''}
                    ${info.event.extendedProps.overdue ? '<br><span class="text-danger">‚ö†Ô∏è Overdue</span>' : ''}
                `;
                tooltip.style.cssText = `
                    position: absolute;
                    background: rgba(0,0,0,0.9);
                    color: white;
                    padding: 8px 12px;
                    border-radius: 4px;
                    font-size: 12px;
                    z-index: 1000;
                    max-width: 250px;
                    pointer-events: none;
                `;
                document.body.appendChild(tooltip);
                
                // Position tooltip
                const rect = info.el.getBoundingClientRect();
                tooltip.style.left = rect.left + 'px';
                tooltip.style.top = (rect.bottom + 5) + 'px';
                
                info.el.addEventListener('mouseleave', () => {
                    tooltip.remove();
                });
            }
        });
        
        console.log('Rendering calendar...');
        calendar.render();
        console.log('Calendar rendered successfully');
        
        // Add custom today button functionality as backup
        setTimeout(() => {
            const todayBtn = document.querySelector('.fc-today-button');
            if (todayBtn) {
                console.log('Found today button, adding click handler');
                todayBtn.addEventListener('click', function() {
                    console.log('Today button clicked');
                    calendar.today();
                });
            }
        }, 1000);
    }
    
    // Show event details modal
    function showEventModal(event) {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${event.title}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Date:</strong> ${event.startStr}</p>
                        <p><strong>Type:</strong> ${event.extendedProps.type || 'Event'}</p>
                        <p><strong>Priority:</strong> 
                            <span class="badge bg-${event.extendedProps.priority === 'high' ? 'danger' : event.extendedProps.priority === 'medium' ? 'warning' : 'secondary'}">
                                ${event.extendedProps.priority || 'medium'}
                            </span>
                        </p>
                        ${event.extendedProps.overdue ? '<p class="text-danger"><i class="fas fa-exclamation-triangle"></i> This item is overdue</p>' : ''}
                        <p>${event.extendedProps.description || 'No description available'}</p>
                    </div>
                    <div class="modal-footer">
                        ${event.extendedProps.url ? `<a href="${event.extendedProps.url}" class="btn btn-primary">View Details</a>` : ''}
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();
        
        modal.addEventListener('hidden.bs.modal', () => {
            modal.remove();
        });
    }
    
    // Load upcoming events for sidebar
    function loadUpcomingEvents() {
        fetch('/api/upcoming-events')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('upcoming-events-list');
                const countBadge = document.getElementById('upcomingCount');
                
                if (data.events && data.events.length > 0) {
                    countBadge.textContent = data.events.length;
                    
                    container.innerHTML = data.events.map(event => {
                        const eventDate = new Date(event.date);
                        const isToday = eventDate.toDateString() === new Date().toDateString();
                        const isTomorrow = eventDate.toDateString() === new Date(Date.now() + 86400000).toDateString();
                        
                        let dateDisplay;
                        if (isToday) {
                            dateDisplay = 'Today';
                        } else if (isTomorrow) {
                            dateDisplay = 'Tomorrow';
                        } else {
                            dateDisplay = eventDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        }
                        
                        return `
                            <div class="border-bottom px-3 py-2 ${event.overdue ? 'bg-light-danger' : ''}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 fw-bold ${event.overdue ? 'text-danger' : ''}">${event.title}</h6>
                                        <small class="text-muted d-block">${event.description}</small>
                                        <div class="mt-1">
                                            <span class="badge bg-${event.priority === 'high' ? 'danger' : event.priority === 'medium' ? 'warning' : 'secondary'} me-1">
                                                ${event.priority}
                                            </span>
                                            <small class="text-muted">${dateDisplay}</small>
                                            ${event.overdue ? '<span class="badge bg-danger ms-1">Overdue</span>' : ''}
                                        </div>
                                    </div>
                                    ${event.url ? `<a href="${event.url}" class="btn btn-sm btn-outline-primary ms-2"><i class="fas fa-eye"></i></a>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    countBadge.textContent = '0';
                    container.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-calendar-check fa-2x text-muted mb-2"></i>
                            <p class="text-muted mb-0">No upcoming events</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading upcoming events:', error);
                document.getElementById('upcoming-events-list').innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                        <p class="text-muted mb-0">Error loading events</p>
                    </div>
                `;
            });
    }
    
    // Load PDF count from server
    function loadPDFCount() {
        console.log('loadPDFCount called');
        const pdfCountElement = document.getElementById('pdfCount');
        
        // First set loading state
        if (pdfCountElement) {
            pdfCountElement.textContent = 'Loading...';
            pdfCountElement.className = 'badge bg-secondary ms-2';
            pdfCountElement.title = 'Loading PDF count...';
        }
        
        fetch('/api/pdf-count')
            .then(response => {
                console.log('PDF count response received:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('PDF count data:', data);
                if (pdfCountElement) {
                    pdfCountElement.textContent = data.count;
                    pdfCountElement.title = `${data.count} PDF files found - Click to refresh`;
                    console.log('Updated pdfCount element to:', data.count);
                    
                    // Update badge color based on count
                    if (data.count > 0) {
                        pdfCountElement.className = 'badge bg-success ms-2';
                    } else {
                        pdfCountElement.className = 'badge bg-warning ms-2';
                    }
                }
                
                const btn = document.getElementById('loadPDFsBtn');
                if (btn) {
                    if (data.count > 0) {
                        btn.classList.remove('btn-secondary');
                        btn.classList.add('btn-primary');
                    } else {
                        btn.classList.remove('btn-primary');
                        btn.classList.add('btn-secondary');
                    }
                }
            })
            .catch(error => {
                console.error('Error loading PDF count:', error);
                if (pdfCountElement) {
                    pdfCountElement.textContent = '?';
                    pdfCountElement.className = 'badge bg-danger ms-2';
                    pdfCountElement.title = 'Error loading count - Click to retry';
                }
            });
    }
    
    // Load PDFs function
    function loadPDFs() {
        const btn = document.getElementById('loadPDFsBtn');
        const originalText = btn.innerHTML;
        
        // Show loading state
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
        btn.disabled = true;
        
        fetch('/api/load-pdfs', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Build success message
                let message = `Successfully processed ${data.processed} PDFs. ${data.created} new records created, ${data.updated} records updated.`;
                
                // Add task creation notification
                if (data.review_task_created) {
                    message += ` A review task has been created and is due today.`;
                }
                
                // No popups - processing complete, info available in reports
                console.log('PDF processing completed:', message);
                
                // Refresh PDF count
                loadPDFCount();
                
                // Refresh page after 2 seconds to show updated data
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                console.error('Error processing PDFs:', data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            console.error('Network error while processing PDFs');
        })
        .finally(() => {
            // Restore button
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }
    
    // Clear All Data function (Development Only)
    function clearAllData() {
        // Double confirmation for safety
        if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL data from the database!\n\nThis includes:\n‚Ä¢ All Opportunities\n‚Ä¢ All Products\n‚Ä¢ All Accounts/Contacts\n‚Ä¢ All Tasks\n‚Ä¢ All QPL entries\n‚Ä¢ All Interactions\n\nThis action cannot be undone!\n\nAre you sure you want to continue?')) {
            return;
        }
        
        if (!confirm('üö® FINAL CONFIRMATION\n\nThis will permanently delete EVERYTHING in your CRM database.\n\nType "DELETE" in the next prompt to confirm.')) {
            return;
        }
        
        const confirmText = prompt('Type "DELETE" to confirm database clearing:');
        if (confirmText !== 'DELETE') {
            showAlert('error', 'Database clearing cancelled - confirmation text did not match.');
            return;
        }
        
        const btn = document.getElementById('clearDataBtn');
        const originalText = btn.innerHTML;
        
        // Show loading state
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Clearing...';
        btn.disabled = true;
        
        fetch('/api/clear-all-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', 'All database data has been cleared successfully. Refreshing page...');
                
                // Refresh page after 2 seconds to show empty state
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                showAlert('error', 'Error clearing data: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'Network error while clearing data');
        })
        .finally(() => {
            // Restore button
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }
    
    // Show alert function
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
        alertDiv.style.top = '20px';
        alertDiv.style.right = '20px';
        alertDiv.style.zIndex = '9999';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
    
    // Task range switching function
    function showTasks(range) {
        // Hide all task ranges
        document.querySelectorAll('.task-range').forEach(el => {
            el.style.display = 'none';
        });
        
        // Show selected range
        document.getElementById(range + '-tasks').style.display = 'block';
        
        // Update dropdown text
        const rangeNames = {
            'today': "Today's Tasks",
            'this_week': 'This Week',
            'next_week': 'Next Week'
        };
        document.getElementById('currentTaskRange').textContent = rangeNames[range];
    }
    
    // Complete task function
    function completeTask(taskId) {
        fetch(`/api/tasks/${taskId}/complete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', 'Task marked as complete');
                // Refresh calendar and events
                calendar.refetchEvents();
                loadUpcomingEvents();
                // Refresh page after short delay
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert('error', 'Error completing task: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'Network error while completing task');
        });
    }

    // Delete task function
    function deleteTask(taskId) {
        fetch(`/tasks/${taskId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', 'Task deleted successfully');
                // Refresh calendar and events
                calendar.refetchEvents();
                loadUpcomingEvents();
                // Refresh page after short delay
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert('error', 'Error deleting task: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'Network error while deleting task');
        });
    }
    
    // Delete opportunity function
    function deleteOpportunity(opportunityId, opportunityName) {
        if (confirm(`Are you sure you want to delete the opportunity "${opportunityName}"? This action cannot be undone.`)) {
            fetch(`/api/opportunities/${opportunityId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + (data.message || 'Failed to delete opportunity'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the opportunity');
            });
        }
    }
    
    // Auto-refresh dashboard every 5 minutes
    setTimeout(function() {
        location.reload();
    }, 300000);
</script>

<style>
    /* Enhanced styles for double-clickable items */
    .task-item:hover,
    .rfq-item:hover,
    .opportunity-item:hover,
    .interaction-item:hover,
    .opportunity-row:hover {
        background-color: #f8f9fa !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.2s ease-in-out;
    }
    
    .task-item,
    .rfq-item,
    .opportunity-item,
    .interaction-item,
    .opportunity-row {
        transition: all 0.2s ease-in-out;
        border-radius: 4px;
        margin: 2px 0;
        padding: 8px !important;
    }
    
    /* Add subtle border to indicate clickable items */
    .task-item,
    .rfq-item,
    .opportunity-item,
    .interaction-item {
        border-left: 3px solid transparent;
    }
    
    .task-item:hover {
        border-left-color: #007bff;
    }
    
    .rfq-item:hover {
        border-left-color: #28a745;
    }
    
    .opportunity-item:hover {
        border-left-color: #ffc107;
    }
    
    .interaction-item:hover {
        border-left-color: #6f42c1;
    }
    
    /* Add pointer cursor and tooltip styling */
    [title]:hover::after {
        content: attr(title);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 1000;
        pointer-events: none;
    }
</style>
{% endblock %}
