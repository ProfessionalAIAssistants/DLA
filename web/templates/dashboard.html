{% extends "base.html" %}
{% from "macros/dashboard_macros.html" import dashboard_header, key_metrics_section, calendar_events_section, recent_opportunities_section, task_schedule_section, overdue_tasks_section, recent_quotes_section, closing_opportunities_section, recent_activity_section %}

{% block title %}Dashboard - CDE Prosperity{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Modern Header -->
    {{ dashboard_header(data) }}

    <!-- Key Metrics -->
    {{ key_metrics_section(data) }}

    <!-- Calendar and Upcoming Events -->
    {{ calendar_events_section() }}

    <!-- Recent Opportunities Section -->
    {{ recent_opportunities_section(data) }}

<!-- Main Content Row -->
<div class="row">
    <!-- Task Schedule -->
    {{ task_schedule_section(data) }}
    
    <!-- Overdue Tasks -->
    {{ overdue_tasks_section(data) }}
</div>

<div class="row mt-4">
    <!-- New Quotes -->
    {{ recent_quotes_section(data) }}
    
    <!-- Closing Opportunities -->
    {{ closing_opportunities_section(data) }}
</div>

<!-- Recent Activity -->
{{ recent_activity_section(data) }}
{% endblock %}

{% block scripts %}
<!-- FullCalendar CSS via CDN -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<!-- FullCalendar JS via CDN -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
    let calendar;
    let currentView = 'dayGridMonth';
    
    // Display current date
    document.addEventListener('DOMContentLoaded', function() {
        const dateElement = document.getElementById('currentDate');
        if (dateElement) {
            const today = new Date();
            const options = { year: 'numeric', month: 'short', day: '2-digit' };
            dateElement.textContent = today.toLocaleDateString('en-US', options);
        }
        
        // Initialize calendar
        initializeCalendar();
        
        // Add manual today button fix
        setTimeout(() => {
            if (calendar) {
                // Force the calendar to today's date
                calendar.today();
                console.log('Calendar forced to today');
            }
        }, 2000);
        
        // Load upcoming events
        loadUpcomingEvents();
        
        // Load PDF count on page load
        setTimeout(() => {
            loadPDFCount();
        }, 1000); // Add a delay to ensure DOM is ready
        
        // Also try loading it again after a longer delay in case there are issues
        setTimeout(() => {
            loadPDFCount();
        }, 3000);
    });
    
    // Initialize FullCalendar
    function initializeCalendar() {
        const calendarEl = document.getElementById('dashboard-calendar');
        
        console.log('Initializing calendar...');
        
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,listWeek'
            },
            height: 'auto',
            contentHeight: 'auto',
            aspectRatio: 1.8,
            expandRows: true,
            handleWindowResize: true,
            now: new Date(),
            events: function(fetchInfo, successCallback, failureCallback) {
                console.log('Loading calendar events...');
                fetch('/api/calendar-events', {
                    method: 'GET'
                })
                .then(response => {
                    console.log('Calendar API response status:', response.status);
                    return response.json();
                })
                .then(events => {
                    console.log('Calendar events loaded:', events.length);
                    successCallback(events);
                })
                .catch(error => {
                    console.error('Error loading calendar events:', error);
                    failureCallback(error);
                });
            },
            eventClick: function(info) {
                // Get the URL from event extended props
                const url = info.event.extendedProps.url;
                if (url) {
                    // Redirect directly to the detail page
                    window.open(url, '_blank');
                } else {
                    // Fallback to modal if no URL
                    showEventModal(info.event);
                }
            },
            eventMouseEnter: function(info) {
                // Show tooltip
                const tooltip = document.createElement('div');
                tooltip.className = 'calendar-tooltip';
                tooltip.innerHTML = `
                    <strong>${info.event.title}</strong><br>
                    ${info.event.extendedProps.description || ''}
                    ${info.event.extendedProps.overdue ? '<br><span class="text-danger">⚠️ Overdue</span>' : ''}
                `;
                tooltip.style.cssText = `
                    position: absolute;
                    background: rgba(0,0,0,0.9);
                    color: white;
                    padding: 8px 12px;
                    border-radius: 4px;
                    font-size: 12px;
                    z-index: 1000;
                    max-width: 250px;
                    pointer-events: none;
                `;
                document.body.appendChild(tooltip);
                
                // Position tooltip
                const rect = info.el.getBoundingClientRect();
                tooltip.style.left = rect.left + 'px';
                tooltip.style.top = (rect.bottom + 5) + 'px';
                
                info.el.addEventListener('mouseleave', () => {
                    tooltip.remove();
                });
            }
        });
        
        console.log('Rendering calendar...');
        calendar.render();
        console.log('Calendar rendered successfully');
        
        // Add custom today button functionality as backup
        setTimeout(() => {
            const todayBtn = document.querySelector('.fc-today-button');
            if (todayBtn) {
                console.log('Found today button, adding click handler');
                todayBtn.addEventListener('click', function() {
                    console.log('Today button clicked');
                    calendar.today();
                });
            }
        }, 1000);
    }
    
    // Show event details modal
    function showEventModal(event) {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${event.title}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Date:</strong> ${event.startStr}</p>
                        <p><strong>Type:</strong> ${event.extendedProps.type || 'Event'}</p>
                        <p><strong>Priority:</strong> 
                            <span class="badge bg-${event.extendedProps.priority === 'high' ? 'danger' : event.extendedProps.priority === 'medium' ? 'warning' : 'secondary'}">
                                ${event.extendedProps.priority || 'medium'}
                            </span>
                        </p>
                        ${event.extendedProps.overdue ? '<p class="text-danger"><i class="fas fa-exclamation-triangle"></i> This item is overdue</p>' : ''}
                        <p>${event.extendedProps.description || 'No description available'}</p>
                    </div>
                    <div class="modal-footer">
                        ${event.extendedProps.url ? `<a href="${event.extendedProps.url}" class="btn btn-primary">View Details</a>` : ''}
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();
        
        modal.addEventListener('hidden.bs.modal', () => {
            modal.remove();
        });
    }
    
    // Load upcoming events for sidebar
    function loadUpcomingEvents() {
        fetch('/api/upcoming-events')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('upcoming-events-list');
                const countBadge = document.getElementById('upcomingCount');
                
                if (data.events && data.events.length > 0) {
                    countBadge.textContent = data.events.length;
                    
                    container.innerHTML = data.events.map(event => {
                        const eventDate = new Date(event.date);
                        const isToday = eventDate.toDateString() === new Date().toDateString();
                        const isTomorrow = eventDate.toDateString() === new Date(Date.now() + 86400000).toDateString();
                        
                        let dateDisplay;
                        if (isToday) {
                            dateDisplay = 'Today';
                        } else if (isTomorrow) {
                            dateDisplay = 'Tomorrow';
                        } else {
                            dateDisplay = eventDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        }
                        
                        return `
                            <div class="border-bottom px-3 py-2 ${event.overdue ? 'bg-light-danger' : ''}" 
                                 ondblclick="${event.url ? `window.open('${event.url}', '_blank')` : ''}" 
                                 style="${event.url ? 'cursor: pointer;' : ''}"
                                 title="${event.url ? 'Double-click to view details' : ''}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 fw-bold ${event.overdue ? 'text-danger' : ''}">${event.title}</h6>
                                        <small class="text-muted d-block">${event.description}</small>
                                        <div class="mt-1">
                                            <span class="badge bg-${event.priority === 'high' ? 'danger' : event.priority === 'medium' ? 'warning' : 'secondary'} me-1">
                                                ${event.priority}
                                            </span>
                                            <small class="text-muted">${dateDisplay}</small>
                                            ${event.overdue ? '<span class="badge bg-danger ms-1">Overdue</span>' : ''}
                                        </div>
                                    </div>
                                    ${event.url ? `<a href="${event.url}" class="btn btn-sm btn-outline-primary ms-2" onclick="event.stopPropagation();" title="View Details"><i class="fas fa-eye"></i></a>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    countBadge.textContent = '0';
                    container.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-calendar-check fa-2x text-muted mb-2"></i>
                            <p class="text-muted mb-0">No upcoming events</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading upcoming events:', error);
                document.getElementById('upcoming-events-list').innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                        <p class="text-muted mb-0">Error loading events</p>
                    </div>
                `;
            });
    }
    
    // Load PDF count from server
    function loadPDFCount() {
        console.log('loadPDFCount called');
        const pdfCountElement = document.getElementById('pdfCount');
        
        // First set loading state
        if (pdfCountElement) {
            pdfCountElement.textContent = 'Loading...';
            pdfCountElement.className = 'badge bg-secondary ms-2';
            pdfCountElement.title = 'Loading PDF count...';
        }
        
        fetch('/api/pdf-count')
            .then(response => {
                console.log('PDF count response received:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('PDF count data:', data);
                if (pdfCountElement) {
                    pdfCountElement.textContent = data.count;
                    pdfCountElement.title = `${data.count} PDF files found - Click to refresh`;
                    console.log('Updated pdfCount element to:', data.count);
                    
                    // Update badge color based on count
                    if (data.count > 0) {
                        pdfCountElement.className = 'badge bg-success ms-2';
                    } else {
                        pdfCountElement.className = 'badge bg-warning ms-2';
                    }
                }
                
                const btn = document.getElementById('loadPDFsBtn');
                if (btn) {
                    if (data.count > 0) {
                        btn.classList.remove('btn-secondary');
                        btn.classList.add('btn-primary');
                    } else {
                        btn.classList.remove('btn-primary');
                        btn.classList.add('btn-secondary');
                    }
                }
            })
            .catch(error => {
                console.error('Error loading PDF count:', error);
                if (pdfCountElement) {
                    pdfCountElement.textContent = '?';
                    pdfCountElement.className = 'badge bg-danger ms-2';
                    pdfCountElement.title = 'Error loading count - Click to retry';
                }
            });
    }
    
    // Load PDFs function
    function loadPDFs() {
        const btn = document.getElementById('loadPDFsBtn');
        const originalText = btn.innerHTML;
        
        // Show loading state
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
        btn.disabled = true;
        
        fetch('/api/load-pdfs', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Build success message
                let message = `Successfully processed ${data.processed} PDFs. ${data.created} new records created, ${data.updated} records updated.`;
                
                // Add task creation notification
                if (data.review_task_created) {
                    message += ` A review task has been created and is due today.`;
                }
                
                // No popups - processing complete, info available in reports
                console.log('PDF processing completed:', message);
                
                // Refresh PDF count
                loadPDFCount();
                
                // Refresh page after 2 seconds to show updated data
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                console.error('Error processing PDFs:', data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            console.error('Network error while processing PDFs');
        })
        .finally(() => {
            // Restore button
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }
    
    // SIMPLIFIED Start Day function for debugging
    function startDay() {
        console.log('🚀 Start Day button clicked!');
        
        try {
            const btn = document.getElementById('startDayBtn');
            if (!btn) {
                console.error('❌ Start Day button not found!');
                return;
            }
            
            console.log('✅ Button found, proceeding...');
            const originalText = btn.innerHTML;
            
            // Show loading state
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating Task...';
            btn.disabled = true;
            
            // Get today's date
            const today = new Date().toISOString().split('T')[0];
            const todayFormatted = new Date().toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            console.log('📅 Date prepared:', today, todayFormatted);
            
            // Get dashboard data for comprehensive summary
            const pendingTasks = {{ data.metrics.pending_tasks if data and data.metrics else 0 }};
            const overdueTasks = {{ data.metrics.overdue_tasks if data and data.metrics else 0 }};
            const pipelineValue = {{ data.metrics.total_pipeline_value if data and data.metrics else 0 }};
            const wonValue = {{ data.metrics.total_won_value if data and data.metrics else 0 }};
            
            // Get priority breakdown
            const highPriorityTasks = pendingTasks > 0 ? Math.ceil(pendingTasks * 0.3) : 0;
            const mediumPriorityTasks = pendingTasks > 0 ? Math.ceil(pendingTasks * 0.5) : 0;
            const lowPriorityTasks = pendingTasks - highPriorityTasks - mediumPriorityTasks;
            
            // Build comprehensive description
            const taskDescription = `Daily Start Summary for ${todayFormatted}

═══════════════════════════════════════════════════════════════
📊 DAILY OVERVIEW
═══════════════════════════════════════════════════════════════

📋 TASK SUMMARY:
▶ Total Pending Tasks: ${pendingTasks}
▶ Overdue Tasks: ${overdueTasks}
▶ Priority Breakdown:
  🔴 High Priority: ${highPriorityTasks} tasks
  🟡 Medium Priority: ${mediumPriorityTasks} tasks
  🟢 Low Priority: ${lowPriorityTasks} tasks

💰 PIPELINE STATUS:
▶ Active Pipeline Value: $${pipelineValue.toLocaleString()}
▶ Won Opportunities Value: $${wonValue.toLocaleString()}

═══════════════════════════════════════════════════════════════
📥 DAILY PDF DOWNLOAD CHECKLIST
═══════════════════════════════════════════════════════════════

[ ]  Download PDFs
    - [ ]  Open URL DIBBs https://www.dibbs.bsm.dla.mil/
    - [ ]  Click RFQs in upper tool bar
    - [ ]  Change Search Categories to "Federal Supply Class"
    - [ ]  Under Search Values put 5331, O-Rings, and/or 5330, Gasket
    - [ ]  Click green Search button
    - [ ]  Click on white header "Issued" twice- This sorts by issue date from the latest
    - [ ]  For all of today's date, or all previous missed, click on Solicitation Number to download PDF

═══════════════════════════════════════════════════════════════
📅 END OF DAY REVIEW
═══════════════════════════════════════════════════════════════

[ ]  Review completed tasks
[ ]  Update opportunity statuses
[ ]  Plan tomorrow's priorities
[ ]  Archive downloaded PDFs

Generated: ${new Date().toLocaleTimeString()} on ${todayFormatted}`;

            // Comprehensive task data
            const taskData = {
                subject: 'Start Day - ' + todayFormatted,
                description: taskDescription,
                due_date: today,
                work_date: today,
                priority: 'High',
                status: 'Not Started',
                type: 'Daily Summary'
            };
            
            console.log('📝 Task data prepared:', taskData);
            
            // Make API call
            fetch('/api/tasks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(taskData)
            })
            .then(response => {
                console.log('📡 Response received:', response.status);
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('📊 Response data:', data);
                if (data.success) {
                    console.log('✅ SUCCESS! Task created with ID:', data.task_id);
                    
                    // Refresh after a short delay - no popup alert
                    setTimeout(() => {
                        console.log('🔄 Reloading page...');
                        location.reload();
                    }, 1000);
                } else {
                    console.error('❌ Task creation failed:', data.message);
                    // Only show error alerts, not success ones
                    alert('❌ Error creating task: ' + data.message);
                }
            })
            .catch(error => {
                console.error('❌ Fetch error:', error);
                alert('❌ Network error: ' + error.message);
            })
            .finally(() => {
                console.log('🔄 Restoring button...');
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
            
        } catch (error) {
            console.error('❌ JavaScript error in startDay():', error);
            alert('❌ JavaScript error: ' + error.message);
        }
    }
    
    // Task range switching function
    function showTasks(range) {
        // Hide all task ranges
        document.querySelectorAll('.task-range').forEach(el => {
            el.style.display = 'none';
        });
        
        // Show selected range
        document.getElementById(range + '-tasks').style.display = 'block';
        
        // Update dropdown text
        const rangeNames = {
            'today': "Today's Tasks",
            'this_week': 'This Week',
            'next_week': 'Next Week'
        };
        document.getElementById('currentTaskRange').textContent = rangeNames[range];
    }
    
    // Complete task function
    function completeTask(taskId) {
        fetch(`/api/tasks/${taskId}/complete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', 'Task marked as complete');
                // Refresh calendar and events
                calendar.refetchEvents();
                loadUpcomingEvents();
                // Refresh page after short delay
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert('error', 'Error completing task: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'Network error while completing task');
        });
    }

    // Delete task function
    function deleteTask(taskId) {
        fetch(`/tasks/${taskId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', 'Task deleted successfully');
                // Refresh calendar and events
                calendar.refetchEvents();
                loadUpcomingEvents();
                // Refresh page after short delay
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert('error', 'Error deleting task: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'Network error while deleting task');
        });
    }
    
    // Delete opportunity function
    function deleteOpportunity(opportunityId, opportunityName) {
        if (confirm(`Are you sure you want to delete the opportunity "${opportunityName}"? This action cannot be undone.`)) {
            fetch(`/api/opportunities/${opportunityId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + (data.message || 'Failed to delete opportunity'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the opportunity');
            });
        }
    }
    
    // Auto-refresh dashboard every 5 minutes
    setTimeout(function() {
        location.reload();
    }, 300000);
</script>

<style>
    /* Enhanced styles for double-clickable items */
    .task-item:hover,
    .rfq-item:hover,
    .opportunity-item:hover,
    .interaction-item:hover,
    .opportunity-row:hover {
        background-color: #f8f9fa !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.2s ease-in-out;
    }
    
    .task-item,
    .rfq-item,
    .opportunity-item,
    .interaction-item,
    .opportunity-row {
        transition: all 0.2s ease-in-out;
        border-radius: 4px;
        margin: 2px 0;
        padding: 8px !important;
    }
    
    /* Add subtle border to indicate clickable items */
    .task-item,
    .rfq-item,
    .opportunity-item,
    .interaction-item {
        border-left: 3px solid transparent;
    }
    
    .task-item:hover {
        border-left-color: #007bff;
    }
    
    .rfq-item:hover {
        border-left-color: #28a745;
    }
    
    .opportunity-item:hover {
        border-left-color: #ffc107;
    }
    
    .interaction-item:hover {
        border-left-color: #6f42c1;
    }
    
    /* Add pointer cursor and tooltip styling */
    [title]:hover::after {
        content: attr(title);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 1000;
        pointer-events: none;
    }
</style>
{% endblock %}
