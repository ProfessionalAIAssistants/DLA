<!-- Dashboard Header Macro -->
{% macro dashboard_header(data) %}
<div class="d-flex justify-content-between align-items-center mb-5">
    <div>
        <h1 class="display-6 fw-bold mb-2">
            <i class="fas fa-tachometer-alt me-3" style="background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></i>
            Dashboard
        </h1>
        <p class="text-muted mb-0 fs-5">Overview of your business performance</p>
    </div>
    <div class="d-flex gap-3">
        <button type="button" class="btn btn-primary btn-lg" onclick="loadPDFs()" id="loadPDFsBtn">
            <i class="fas fa-file-pdf me-2"></i>
            Load PDFs
            <span class="badge bg-warning ms-2" id="pdfCount" onclick="loadPDFCount()" style="cursor: pointer;" title="Click to refresh">Loading...</span>
        </button>
        <button type="button" class="btn btn-success btn-lg" onclick="startDay()" id="startDayBtn" title="Create daily PDF download task">
            <i class="fas fa-play me-2"></i>
            Start Day
        </button>
        <button type="button" class="btn btn-outline-primary btn-lg">
            <i class="fas fa-calendar-day me-2"></i>
            Today: <span id="currentDate"></span>
        </button>
    </div>
</div>
{% endmacro %}

<!-- Single Metric Card Macro -->
{% macro metric_card(title, value, description, icon, color_class="") %}
<div class="col-md-3">
    <div class="card card-metric {{ color_class }} h-100">
        <div class="card-body d-flex align-items-center">
            <div class="flex-grow-1">
                <h6 class="text-dark mb-2 text-uppercase fw-bold" style="font-size: 0.75rem; letter-spacing: 1px; opacity: 0.8;">{{ title }}</h6>
                <h2 class="mb-0 fw-bold text-dark">{{ value }}</h2>
                <small class="text-dark" style="opacity: 0.7;">{{ description }}</small>
            </div>
            <div class="ms-3">
                <div class="rounded-circle d-flex align-items-center justify-content-center" 
                     style="width: 50px; height: 50px; background: rgba(255,255,255,0.2);">
                    <i class="fas fa-{{ icon }} fa-lg"></i>
                </div>
            </div>
        </div>
    </div>
</div>
{% endmacro %}

<!-- Key Metrics Section Macro -->
{% macro key_metrics_section(data) %}
<div class="row mb-5">
    {{ metric_card(
        title="Pipeline Value",
        value=data.metrics.total_pipeline_value | currency if data and data.metrics else "$0",
        description="Active opportunities",
        icon="chart-line"
    ) }}
    {{ metric_card(
        title="Total Won",
        value=data.metrics.total_won_value | currency if data and data.metrics else "$0",
        description="Successful bids",
        icon="trophy",
        color_class="success"
    ) }}
    {{ metric_card(
        title="Pending Tasks",
        value=data.metrics.pending_tasks if data and data.metrics else 0,
        description="Need attention",
        icon="tasks",
        color_class="warning"
    ) }}
    {{ metric_card(
        title="Overdue Tasks",
        value=data.metrics.overdue_tasks if data and data.metrics else 0,
        description="Require action",
        icon="exclamation-triangle",
        color_class="danger"
    ) }}
</div>
{% endmacro %}

<!-- Calendar and Events Section Macro -->
{% macro calendar_events_section() %}
<div class="row mb-5">
    <!-- Interactive Calendar -->
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-calendar-alt me-2"></i>CDE Prosperity Calendar
                </h5>
            </div>
            <div class="card-body p-2">
                <!-- Calendar container -->
                <div id="dashboard-calendar" style="min-height: 600px; height: auto; overflow: visible;"></div>
            </div>
        </div>
    </div>

    <!-- Upcoming Events Sidebar -->
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-clock me-2"></i>Upcoming Events
                </h5>
                <span class="badge bg-primary" id="upcomingCount">0</span>
            </div>
            <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                <div id="upcoming-events-list">
                    <!-- Events will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endmacro %}

<!-- Recent Opportunities Section Macro -->
{% macro recent_opportunities_section(data) %}
<div class="row mb-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-dollar-sign me-2"></i>Recent Opportunities
                </h5>
                <a href="{{ url_for('opportunities') }}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-arrow-right me-1"></i>View All
                </a>
            </div>
            <div class="card-body">
                                <div class="card-body">
                    {% if data.recent_opportunities and data.recent_opportunities|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Opportunity</th>
                                    <th>Buyer</th>
                                    <th>Stage</th>
                                    <th>State</th>
                                    <th>Bid Price</th>
                                    <th>Quantity</th>
                                    <th>Close Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for opp in data.recent_opportunities[:10] %}
                                <tr class="opportunity-row" 
                                    ondblclick="window.location.href='{{ url_for('opportunity_detail', opportunity_id=opp.id) }}'" 
                                    style="cursor: pointer;" 
                                    title="Double-click to view details">
                                    <td>
                                        <strong>{{ opp.name }}</strong>
                                        {% if opp.mfr %}
                                        <br><small class="text-muted">MFR: {{ opp.mfr[:30] }}{{ '...' if opp.mfr|length > 30 else '' }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-primary">
                                            <i class="fas fa-user me-1"></i>{{ opp.buyer or 'Not assigned' }}
                                        </small>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if opp.stage == 'Project Started' else 'warning' if opp.stage == 'Submit Bid' else 'info' if opp.stage == 'RFQ Received' else 'secondary' if opp.stage == 'RFQ Requested' else 'primary' }}">
                                            {{ opp.stage or 'Prospecting' }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if opp.state == 'Won' else 'danger' if opp.state == 'Bid Lost' else 'warning' if opp.state in ['Past Due', 'No Bid'] else 'primary' }}">
                                            {{ opp.state or 'Active' }}
                                        </span>
                                    </td>
                                    <td>
                                        <strong class="text-success">{{ opp.bid_price | currency if opp.bid_price else 'TBD' }}</strong>
                                    </td>
                                    <td>
                                        <span class="badge bg-light text-dark">
                                            {{ opp.quantity or 'N/A' }}{{ ' ' + opp.unit if opp.unit else '' }}
                                        </span>
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            <i class="fas fa-calendar me-1"></i>{{ opp.close_date | date if opp.close_date else 'No close date' }}
                                        </small>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('opportunity_detail', opportunity_id=opp.id) }}" class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation();" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteOpportunity({{ opp.id }}, '{{ opp.name }}')" title="Delete Opportunity">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-dollar-sign fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No recent opportunities</h5>
                        <p class="text-muted">Recent opportunities will appear here once they are created.</p>
                        <a href="{{ url_for('opportunities') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Create Opportunity
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endmacro %}

<!-- Task Range Section Macro -->
{% macro task_range_section(range_id, tasks, title_text) %}
<div id="{{ range_id }}-tasks" class="task-range" style="{{ 'display: none;' if range_id != 'today' else '' }}">
    {% if tasks and tasks|length > 0 %}
        {% for task in tasks %}
        <div class="d-flex justify-content-between align-items-center border-bottom py-2 task-item" 
             ondblclick="window.location.href='{{ url_for('task_detail', task_id=task.id) }}'" 
             style="cursor: pointer;" 
             title="Double-click to view details">
            <div>
                <h6 class="mb-1">{{ task.subject }}</h6>
                <small class="text-muted">
                    {% if range_id != 'today' %}
                        <i class="fas fa-calendar me-1"></i>{{ task.due_date if task.due_date else 'No due date' }}
                    {% endif %}
                    <i class="fas fa-user {% if range_id != 'today' %}ms-2 {% endif %}me-1"></i>{{ task.assigned_to or 'Unassigned' }}
                    <span class="badge bg-{{ 'danger' if task.priority == 'High' else 'warning' if task.priority == 'Normal' else 'secondary' }} ms-2">
                        {{ task.priority }}
                    </span>
                </small>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); completeTask({{ task.id }})" title="Mark Complete">
                    <i class="fas fa-check"></i>
                </button>
                {% if range_id == 'today' %}
                <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteTask({{ task.id }})" title="Delete Task">
                    <i class="fas fa-trash"></i>
                </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <p class="text-muted">{{ title_text }}</p>
    {% endif %}
</div>
{% endmacro %}

<!-- Task Schedule Section Macro -->
{% macro task_schedule_section(data) %}
<div class="col-md-6">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="taskRangeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <span id="currentTaskRange">Today's Tasks</span>
                </button>
                <ul class="dropdown-menu" aria-labelledby="taskRangeDropdown">
                    <li><a class="dropdown-item" href="#" onclick="showTasks('today')">Today's Tasks</a></li>
                    <li><a class="dropdown-item" href="#" onclick="showTasks('this_week')">This Week</a></li>
                    <li><a class="dropdown-item" href="#" onclick="showTasks('next_week')">Next Week</a></li>
                </ul>
            </div>
            <a href="{{ url_for('tasks') }}" class="btn btn-sm btn-outline-primary">View All</a>
        </div>
        <div class="card-body">
            {{ task_range_section('today', data.today_tasks, 'No tasks scheduled for today.') }}
            {{ task_range_section('this_week', data.this_week_tasks, 'No tasks scheduled for this week.') }}
            {{ task_range_section('next_week', data.next_week_tasks, 'No tasks scheduled for next week.') }}
        </div>
    </div>
</div>
{% endmacro %}

<!-- Overdue Tasks Section Macro -->
{% macro overdue_tasks_section(data) %}
<div class="col-md-6">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0 text-danger">Overdue Tasks</h5>
            <a href="{{ url_for('tasks') }}?status=overdue" class="btn btn-sm btn-outline-danger">View All</a>
        </div>
        <div class="card-body">
            {% if data.overdue_tasks and data.overdue_tasks|length > 0 %}
                {% for task in data.overdue_tasks[:5] %}
                <div class="d-flex justify-content-between align-items-center border-bottom py-2 task-item" 
                     ondblclick="window.location.href='{{ url_for('task_detail', task_id=task.id) }}'" 
                     style="cursor: pointer;" 
                     title="Double-click to view details">
                    <div>
                        <h6 class="mb-1">{{ task.subject }}</h6>
                        <small class="text-muted">
                            Due: {{ task.due_date | date }}
                            <span class="badge bg-danger ms-2">{{ task.priority }}</span>
                        </small>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); completeTask({{ task.id }})" title="Mark Complete">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteTask({{ task.id }})" title="Delete Task">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-muted">No overdue tasks.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endmacro %}

<!-- Recent Quotes Section Macro -->
{% macro recent_quotes_section(data) %}
<div class="col-md-6">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Recent Quotes</h5>
            <a href="{{ url_for('rfqs') }}" class="btn btn-sm btn-outline-primary">View All</a>
        </div>
        <div class="card-body">
            {% if data.new_rfqs and data.new_rfqs|length > 0 %}
                {% for rfq in data.new_rfqs %}
                <div class="border-bottom py-2 rfq-item" 
                     ondblclick="window.location.href='{{ url_for('rfq_detail', rfq_id=rfq.id) }}'" 
                     style="cursor: pointer;" 
                     title="Double-click to view details">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">
                                <a href="{{ url_for('rfq_detail', rfq_id=rfq.id) }}" class="text-decoration-none">
                                    Quote {{ rfq.request_number }}
                                </a>
                            </h6>
                            <small class="text-muted">
                                {{ (rfq.product_description or 'No description')[:50] }}...
                                <br>
                                NSN: {{ rfq.nsn or 'N/A' }} | Close: {{ rfq.close_date | date }}
                            </small>
                        </div>
                        <span class="badge bg-{{ 'success' if rfq.status == 'Qualified' else 'primary' if rfq.status == 'New' else 'secondary' }}">
                            {{ rfq.status }}
                        </span>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-muted">No recent quotes.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endmacro %}

<!-- Closing Opportunities Section Macro -->
{% macro closing_opportunities_section(data) %}
<div class="col-md-6">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Closing Soon</h5>
            <a href="{{ url_for('opportunities') }}" class="btn btn-sm btn-outline-primary">View All</a>
        </div>
        <div class="card-body">
            {% if data.closing_opportunities and data.closing_opportunities|length > 0 %}
                {% for opp in data.closing_opportunities %}
                <div class="border-bottom py-2 opportunity-item" 
                     ondblclick="window.location.href='{{ url_for('opportunity_detail', opportunity_id=opp.id) }}'" 
                     style="cursor: pointer;" 
                     title="Double-click to view details">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">{{ opp.name }}</h6>
                            <small class="text-muted">
                                {{ opp.bid_price | currency }} | {{ opp.stage }} | Close: {{ opp.close_date | date }}
                            </small>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge bg-{{ 'warning' if opp.stage == 'Negotiation' else 'info' if opp.stage == 'Proposal' else 'primary' }}">
                                {{ opp.stage }}
                            </span>
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('opportunity_detail', opportunity_id=opp.id) }}" class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation();" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteOpportunity({{ opp.id }}, '{{ opp.name }}')" title="Delete Opportunity">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-muted">No opportunities closing soon.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endmacro %}

<!-- Recent Activity Section Macro -->
{% macro recent_activity_section(data) %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Recent Activity</h5>
                <a href="{{ url_for('interactions') }}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body">
                {% if data.recent_interactions and data.recent_interactions|length > 0 %}
                    {% for interaction in data.recent_interactions %}
                    <div class="d-flex justify-content-between align-items-center border-bottom py-2 interaction-item" 
                         ondblclick="window.location.href='{{ url_for('interaction_detail', interaction_id=interaction.id) }}'" 
                         style="cursor: pointer;" 
                         title="Double-click to view details">
                        <div>
                            <h6 class="mb-1">{{ interaction.subject }}</h6>
                            <small class="text-muted">
                                <i class="fas fa-{{ 'phone' if interaction.type == 'Call' else 'envelope' if interaction.type == 'Email' else 'users' if interaction.type == 'Meeting' else 'comment' }} me-1"></i>
                                {{ interaction.type }} - {{ interaction.interaction_date | datetime }}
                                {% if interaction.account_name %}
                                    | {{ interaction.account_name }}
                                {% endif %}
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No recent activity.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endmacro %}