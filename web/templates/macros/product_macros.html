{% macro product_header(product) %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="display-6 fw-bold mb-2">{{ product.name }}</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="/products">Products</a></li>
                <li class="breadcrumb-item active">{{ product.nsn or product.name }}</li>
            </ol>
        </nav>
    </div>
    <div class="d-flex gap-2">
        <button type="button" class="btn btn-primary" onclick="editProduct({{ product.id }})">
            <i class="fas fa-edit me-2"></i>Edit
        </button>
        <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="fas fa-cog me-2"></i>Actions
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="addQPLManufacturer({{ product.id }})">
                    <i class="fas fa-plus me-2"></i>Add QPL Manufacturer
                </a></li>
                <li><a class="dropdown-item" href="#" onclick="exportQPLData({{ product.id }})">
                    <i class="fas fa-download me-2"></i>Export QPL Data
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger" href="#" onclick="deleteProduct({{ product.id }})">
                    <i class="fas fa-trash me-2"></i>Delete
                </a></li>
            </ul>
        </div>
    </div>
</div>
{% endmacro %}

{% macro product_information_card(product) %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            <i class="fas fa-box me-2"></i>Product Information
        </h5>
        <span class="badge bg-{{ 'success' if product.is_active else 'secondary' }} fs-6">
            {{ 'Active' if product.is_active else 'Inactive' }}
        </span>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label fw-bold text-muted small">PRODUCT</label>
                    <div class="p-2 bg-light rounded">
                        <code class="text-primary fs-5">{{ product.nsn or 'Not Assigned' }}</code>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold text-muted small">FSC</label>
                    <div class="p-2 bg-light rounded">
                        {{ product.fsc or 'Not Assigned' }}
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label fw-bold text-muted small">PRODUCT DESCRIPTION</label>
                    <div class="p-2 bg-light rounded">
                        {{ product.description or 'Not Assigned' }}
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold text-muted small">NOTES</label>
                    <div class="p-2 bg-light rounded">
                        {{ product.notes or 'Not Assigned' }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endmacro %}

{% macro qpl_manufacturers_card(product, qpl_manufacturers) %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            <i class="fas fa-industry me-2"></i>QPL Manufacturers
            <span class="badge bg-primary ms-2">{{ qpl_manufacturers|length }}</span>
        </h5>
        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addQPLManufacturer({{ product.id }})">
            <i class="fas fa-plus me-1"></i>Add Manufacturer
        </button>
    </div>
    <div class="card-body">
        {% if qpl_manufacturers %}
        <div class="table-responsive">
            <table class="table table-hover" id="qplManufacturersTable">
                <thead class="table-light">
                    <tr>
                        <th>Manufacturer</th>
                        <th>CAGE Code</th>
                        <th>Part Number</th>
                        <th>Added</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for qpl in qpl_manufacturers %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="fas fa-industry text-primary"></i>
                                </div>
                                <div>
                                    <div class="fw-bold">{{ qpl.manufacturer_name }}</div>
                                    <small class="text-muted">
                                        <a href="/account/{{ qpl.account_id }}" class="text-decoration-none">
                                            View Account Details
                                        </a>
                                    </small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <code class="bg-secondary bg-opacity-10 p-1 rounded">{{ qpl.cage_code }}</code>
                        </td>
                        <td>
                            <span class="fw-bold text-primary">{{ qpl.part_number }}</span>
                        </td>
                        <td>
                            <small class="text-muted">{{ qpl.created_date | date }}</small>
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" 
                                        onclick="editQPLEntry({{ qpl.id }})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger" 
                                        onclick="deleteQPLEntry({{ qpl.id }})" title="Remove">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-industry fa-3x text-muted mb-3"></i>
            <h6 class="text-muted">No QPL Manufacturers</h6>
            <p class="text-muted small">No manufacturers have been approved for this product yet.</p>
            <button type="button" class="btn btn-outline-primary" onclick="addQPLManufacturer({{ product.id }})">
                <i class="fas fa-plus me-1"></i>Add First Manufacturer
            </button>
        </div>
        {% endif %}
    </div>
</div>
{% endmacro %}

{% macro vendors_card(vendors) %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            <i class="fas fa-store me-2"></i>Vendors
            <span class="badge bg-secondary ms-2">{{ vendors|length }}</span>
        </h5>
        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addVendorAccount()">
            <i class="fas fa-plus me-1"></i>Add Vendor
        </button>
    </div>
    <div class="card-body">
        {% if vendors %}
        <div class="table-responsive">
            <table class="table table-hover" id="vendorsTable">
                <thead class="table-light">
                    <tr>
                        <th>Vendor Name</th>
                        <th>Type</th>
                        <th>CAGE Code</th>
                        <th>Location</th>
                        <th>Contact</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vendor in vendors %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar avatar-sm bg-success rounded-circle me-2">
                                    <span class="text-white small">{{ vendor.vendor_name[0] if vendor.vendor_name else 'V' }}</span>
                                </div>
                                <a href="{{ url_for('account_detail', account_id=vendor.id) }}" class="text-decoration-none">
                                    <strong>{{ vendor.vendor_name }}</strong>
                                </a>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-info">{{ vendor.type or 'Vendor' }}</span>
                        </td>
                        <td>
                            <code class="text-primary">{{ vendor.vendor_cage or 'N/A' }}</code>
                        </td>
                        <td>
                            <small class="text-muted">{{ vendor.location or 'N/A' }}</small>
                        </td>
                        <td>
                            {% if vendor.primary_contact %}
                                <small class="text-muted">{{ vendor.primary_contact }}</small>
                            {% elif vendor.email %}
                                <small class="text-muted">{{ vendor.email }}</small>
                            {% else %}
                                <small class="text-muted">N/A</small>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <a href="/account/{{ vendor.id }}" class="btn btn-outline-primary btn-sm" title="View Vendor">
                                <i class="fas fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-store fa-3x text-muted mb-3"></i>
            <h6 class="text-muted">No Vendors</h6>
            <p class="text-muted small">No vendor accounts have been linked to this product yet.</p>
            <button type="button" class="btn btn-outline-primary" onclick="addVendorAccount()">
                <i class="fas fa-plus me-1"></i>Add First Vendor
            </button>
        </div>
        {% endif %}
    </div>
</div>
{% endmacro %}

{% macro opportunities_card(opportunities) %}
{% if opportunities %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-handshake me-2"></i>Opportunities Table
            <span class="badge bg-info ms-2">{{ opportunities|length }}</span>
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-sm table-hover" id="opportunitiesTable">
                <thead class="table-light">
                    <tr>
                        <th>Request #</th>
                        <th>Stage</th>
                        <th>Amount</th>
                        <th>Close Date</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for opp in opportunities %}
                    <tr>
                        <td>
                            <a href="/opportunity/{{ opp.id }}" class="text-decoration-none">
                                {{ opp.name }}
                            </a>
                        </td>
                        <td>
                            <span class="badge bg-primary">{{ opp.stage }}</span>
                        </td>
                        <td>
                            {% if opp.amount %}
                            <span class="text-success fw-bold">${{ "{:,.0f}".format(opp.amount) }}</span>
                            {% else %}
                            <span class="text-muted">TBD</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if opp.close_date %}
                            {{ opp.close_date | date }}
                            {% else %}
                            <span class="text-muted">Not set</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <a href="/opportunity/{{ opp.id }}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}
{% endmacro %}

{% macro payment_histories_card(opportunities) %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-credit-card me-2"></i>Payment Histories
            {% set payment_count = opportunities|selectattr('payment_history')|list|length %}
            <span class="badge bg-success ms-2">{{ payment_count }}</span>
        </h5>
    </div>
    <div class="card-body">
        {% set opportunities_with_payment = opportunities|selectattr('payment_history') %}
        {% if opportunities_with_payment %}
        <div class="row">
            {% for opp in opportunities_with_payment %}
            <div class="col-12 mb-3">
                <div class="card border-start border-success border-3 shadow-sm">
                    <div class="card-header bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 fw-bold text-success">
                                <a href="/opportunity/{{ opp.id }}" class="text-decoration-none text-success">
                                    {{ opp.name }}
                                </a>
                            </h6>
                            <div class="d-flex gap-2">
                                <span class="badge bg-{% if opp.stage == 'Closed Won' %}success{% elif opp.stage == 'Closed Lost' %}danger{% elif opp.stage == 'Proposal' %}warning{% else %}primary{% endif %}">
                                    {{ opp.stage or 'Unknown' }}
                                </span>
                                <a href="/opportunity/{{ opp.id }}" class="btn btn-outline-success btn-sm" title="View Opportunity">
                                    <i class="fas fa-eye me-1"></i>View
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="payment-history-content">
                            {% if opp.payment_history %}
                            <div class="bg-light p-3 rounded">
                                <h6 class="mb-2 text-success">
                                    <i class="fas fa-dollar-sign me-2"></i>Payment History Records
                                </h6>
                                <div class="payment-entries" style="max-height: 300px; overflow-y: auto;">
                                    {% for line in opp.payment_history.split('\n') %}
                                    {% if line.strip() %}
                                    <div class="payment-entry mb-2 p-2 bg-white border rounded">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong class="text-primary">{{ line.strip() }}</strong>
                                            </div>
                                            <div>
                                                <small class="badge bg-success">Historical</small>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            {% else %}
                            <div class="text-muted text-center py-2">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                No payment history data available
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-credit-card fa-3x text-muted mb-3"></i>
            <h6 class="text-muted">No Payment History</h6>
            <p class="text-muted small">No payment information available from connected opportunities.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endmacro %}

{% macro quotes_card(quotes) %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-file-invoice-dollar me-2"></i>Quotes Table
            <span class="badge bg-warning ms-2">{{ quotes|length if quotes else 0 }}</span>
        </h5>
    </div>
    <div class="card-body">
        {% if quotes %}
        <div class="table-responsive">
            <table class="table table-hover" id="quotesTable">
                <thead class="table-light">
                    <tr>
                        <th>Quote #</th>
                        <th>Vendor</th>
                        <th>Amount</th>
                        <th>Lead Time</th>
                        <th>Status</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for quote in quotes %}
                    <tr>
                        <td>
                            <strong>{{ quote.quote_number or 'N/A' }}</strong>
                        </td>
                        <td>
                            {% if quote.vendor_name %}
                                {{ quote.vendor_name }}
                            {% else %}
                                <span class="text-muted">Unknown Vendor</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if quote.quote_amount %}
                                <strong class="text-success">${{ "%.2f"|format(quote.quote_amount) }}</strong>
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="text-muted">{{ quote.lead_time or 'N/A' }}</span>
                        </td>
                        <td>
                            <span class="badge bg-{% if quote.status == 'Accepted' %}success{% elif quote.status == 'Rejected' %}danger{% else %}secondary{% endif %}">
                                {{ quote.status or 'Pending' }}
                            </span>
                        </td>
                        <td class="text-center">
                            <a href="/quote/{{ quote.id }}" class="btn btn-outline-primary btn-sm" title="View Quote">
                                <i class="fas fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-file-invoice-dollar fa-3x text-muted mb-3"></i>
            <h6 class="text-muted">No Quotes</h6>
            <p class="text-muted small">No quotes are linked to this product yet.</p>
            <button type="button" class="btn btn-outline-primary" onclick="addQuote()">
                <i class="fas fa-plus me-1"></i>Request Quote
            </button>
        </div>
        {% endif %}
    </div>
</div>
{% endmacro %}

{% macro quick_stats_sidebar(product, qpl_manufacturers, opportunities, vendors, quotes) %}
<div class="card mb-4 border-0 shadow-lg" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3) !important;">
    <div class="card-header border-0 bg-transparent">
        <h6 class="card-title mb-0 text-white fw-bold" style="text-shadow: 0 1px 3px rgba(0,0,0,0.3);">
            <i class="fas fa-chart-bar me-2"></i>Quick Stats
        </h6>
    </div>
    <div class="card-body text-white">
        <div class="row text-center">
            <div class="col-6 mb-3">
                <div class="border-end border-white border-opacity-30 pe-3">
                    <div class="bg-white bg-opacity-25 rounded-circle d-inline-flex align-items-center justify-content-center mb-2 shadow-sm" style="width: 50px; height: 50px;">
                        <i class="fas fa-industry text-white fs-6"></i>
                    </div>
                    <h5 class="text-white mb-1 fw-bold" style="text-shadow: 0 1px 3px rgba(0,0,0,0.4);">{{ qpl_manufacturers|length }}</h5>
                    <small class="text-white fw-medium" style="text-shadow: 0 1px 2px rgba(0,0,0,0.3); font-size: 0.75rem;">QPL Manufacturers</small>
                </div>
            </div>
            <div class="col-6 mb-3">
                <div class="ps-3">
                    <div class="bg-white bg-opacity-25 rounded-circle d-inline-flex align-items-center justify-content-center mb-2 shadow-sm" style="width: 50px; height: 50px;">
                        <i class="fas fa-handshake text-white fs-6"></i>
                    </div>
                    <h5 class="text-white mb-1 fw-bold" style="text-shadow: 0 1px 3px rgba(0,0,0,0.4);">{{ opportunities|length if opportunities else 0 }}</h5>
                    <small class="text-white fw-medium" style="text-shadow: 0 1px 2px rgba(0,0,0,0.3); font-size: 0.75rem;">Opportunities</small>
                </div>
            </div>
        </div>
        <div class="row text-center">
            <div class="col-6">
                <div class="border-end border-white border-opacity-30 pe-3">
                    <div class="bg-white bg-opacity-25 rounded-circle d-inline-flex align-items-center justify-content-center mb-2 shadow-sm" style="width: 50px; height: 50px;">
                        <i class="fas fa-store text-white fs-6"></i>
                    </div>
                    <h5 class="text-white mb-1 fw-bold" style="text-shadow: 0 1px 3px rgba(0,0,0,0.4);">{{ vendors|length if vendors else 0 }}</h5>
                    <small class="text-white fw-medium" style="text-shadow: 0 1px 2px rgba(0,0,0,0.3); font-size: 0.75rem;">Vendors</small>
                </div>
            </div>
            <div class="col-6">
                <div class="ps-3">
                    <div class="bg-white bg-opacity-25 rounded-circle d-inline-flex align-items-center justify-content-center mb-2 shadow-sm" style="width: 50px; height: 50px;">
                        <i class="fas fa-file-invoice-dollar text-white fs-6"></i>
                    </div>
                    <h5 class="text-white mb-1 fw-bold" style="text-shadow: 0 1px 3px rgba(0,0,0,0.4);">{{ quotes|length if quotes else 0 }}</h5>
                    <small class="text-white fw-medium" style="text-shadow: 0 1px 2px rgba(0,0,0,0.3); font-size: 0.75rem;">Quotes</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endmacro %}

{% macro pricing_information_sidebar(product) %}
{% if product.unit_price or product.cost_price or product.list_price %}
<div class="card mb-4">
    <div class="card-header">
        <h6 class="card-title mb-0">
            <i class="fas fa-dollar-sign me-2"></i>Pricing Information
        </h6>
    </div>
    <div class="card-body">
        {% if product.list_price %}
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-muted">List Price:</span>
            <span class="fw-bold">${{ "{:,.2f}".format(product.list_price) }}</span>
        </div>
        {% endif %}
        
        {% if product.unit_price %}
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-muted">Unit Price:</span>
            <span class="fw-bold text-success">${{ "{:,.2f}".format(product.unit_price) }}</span>
        </div>
        {% endif %}
        
        {% if product.cost_price %}
        <div class="d-flex justify-content-between align-items-center">
            <span class="text-muted">Cost Price:</span>
            <span class="fw-bold text-warning">${{ "{:,.2f}".format(product.cost_price) }}</span>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}
{% endmacro %}

{% macro activity_timeline_sidebar(product, qpl_manufacturers) %}
<div class="card border-0 shadow-sm">
    <div class="card-header bg-secondary text-white border-0">
        <h6 class="card-title mb-0 fw-bold">
            <i class="fas fa-clock me-2"></i>Recent Activity
        </h6>
    </div>
    <div class="card-body">
        <div class="timeline">
            <div class="timeline-item">
                <div class="timeline-marker bg-primary shadow"></div>
                <div class="timeline-content">
                    <h6 class="mb-1 fw-bold text-primary">
                        <i class="fas fa-plus-circle me-1"></i>Product Created
                    </h6>
                    <small class="text-muted">{{ product.created_date | date if product.created_date else 'Unknown' }}</small>
                </div>
            </div>
            
            {% if product.modified_date and product.modified_date != product.created_date %}
            <div class="timeline-item">
                <div class="timeline-marker bg-info shadow"></div>
                <div class="timeline-content">
                    <h6 class="mb-1 fw-bold text-info">
                        <i class="fas fa-edit me-1"></i>Product Updated
                    </h6>
                    <small class="text-muted">{{ product.modified_date | date }}</small>
                </div>
            </div>
            {% endif %}
            
            {% for qpl in qpl_manufacturers[:3] %}
            <div class="timeline-item">
                <div class="timeline-marker bg-success shadow"></div>
                <div class="timeline-content">
                    <h6 class="mb-1 fw-bold text-success">
                        <i class="fas fa-industry me-1"></i>QPL Entry Added
                    </h6>
                    <small class="text-muted">{{ qpl.created_date | date if qpl.created_date else 'Unknown' }}</small>
                    {% if qpl.manufacturer_name %}
                    <p class="mb-0 small text-secondary">{{ qpl.manufacturer_name }}</p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            
            {% if not qpl_manufacturers and (not product.modified_date or product.modified_date == product.created_date) %}
            <div class="timeline-item">
                <div class="timeline-marker bg-light border border-secondary shadow-sm"></div>
                <div class="timeline-content">
                    <h6 class="mb-1 fw-bold text-muted">
                        <i class="fas fa-clock me-1"></i>No Recent Activity
                    </h6>
                    <small class="text-muted">Only creation event recorded</small>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endmacro %}

{# ========== PRODUCTS LIST PAGE MACROS (consolidated from products_macros.html) ========== #}

{# Products Page Header Macro #}
{% macro products_page_header() %}
<div class="d-flex justify-content-between align-items-center mb-5">
    <div>
        <h1 class="display-6 fw-bold mb-2">
            <i class="fas fa-box me-3" style="background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></i>
            Products
        </h1>
        <p class="text-muted mb-0 fs-5">Manage product catalog and inventory</p>
    </div>
    <div>
        <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#newProductModal">
            <i class="fas fa-plus me-2"></i>
            New Product
        </button>
    </div>
</div>
{% endmacro %}

{# Products Search and Filters Macro #}
{% macro products_search_filters(search='', fsc='') %}
<div class="card mb-5">
    <div class="card-header">
        <h5 class="mb-0 d-flex align-items-center">
            <i class="fas fa-search me-2"></i>
            Search & Filter Products
        </h5>
    </div>
    <div class="card-body">
        <form method="GET" class="row g-4">
            <div class="col-md-4">
                <label for="search" class="form-label fw-medium">Search Products</label>
                <input type="text" class="form-control" id="search" name="search" 
                       value="{{ search }}" placeholder="Search by NSN, FSC, or category...">
            </div>
            <div class="col-md-3">
                <label for="fsc" class="form-label fw-medium">FSC Filter</label>
                <input type="text" class="form-control" id="fsc" name="fsc" value="{{ fsc }}" placeholder="Filter by FSC...">
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="fas fa-search me-1"></i>
                    Search
                </button>
                <a href="{{ url_for('products') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-times me-1"></i>
                    Clear
                </a>
            </div>
        </form>
    </div>
</div>
{% endmacro %}

{# Products Table Macro #}
{% macro products_table(products) %}
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>NSN</th>
                        <th>FSC</th>
                        <th>Category</th>
                        <th>Manufacturer</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr>
                        <td>
                            <strong>{{ product.nsn or 'N/A' }}</strong>
                            {% if product.description %}
                            <br><small class="text-muted">{{ (product.description or 'No description')[:80] }}{% if (product.description or '')|length > 80 %}...{% endif %}</small>
                            {% endif %}
                        </td>
                        <td>{{ product.fsc or 'N/A' }}</td>
                        <td>{{ product.category or product.name or 'N/A' }}</td>
                        <td>
                            {% if product.qpl_manufacturers and product.qpl_manufacturers|length > 0 %}
                                <!-- Display QPL manufacturers as clickable links -->
                                {% for manufacturer in product.qpl_manufacturers %}
                                    <div class="mb-1">
                                        <a href="/account/{{ manufacturer.account_id }}" class="text-decoration-none fw-bold text-primary" title="View {{ manufacturer.manufacturer_name }} account">
                                            {{ manufacturer.manufacturer_name }}
                                        </a>
                                        {% if manufacturer.cage_code %}
                                        <br><small class="text-muted fw-bold text-info">CAGE: {{ manufacturer.cage_code }}</small>
                                        {% endif %}
                                        {% if manufacturer.part_number %}
                                        <br><small class="text-muted">P/N: {{ manufacturer.part_number }}</small>
                                        {% endif %}
                                    </div>
                                    {% if not loop.last %}<hr class="my-1">{% endif %}
                                {% endfor %}
                            {% elif product.manufacturer %}
                                <!-- Fallback to original manufacturer display -->
                                {% set mfr_parts = product.manufacturer.split(' P/N ') %}
                                {{ mfr_parts[0] }}
                                {% if mfr_parts|length > 1 %}
                                <br><small class="text-muted">P/N: {{ mfr_parts[1] }}</small>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-primary" onclick="viewProduct('{{ product.nsn }}')" title="View Product">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-secondary" onclick="editProduct('{{ product.nsn }}')" title="Edit Product">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteProduct('{{ product.nsn }}', '{{ product.name or product.nsn }}')" title="Delete Product">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if pagination %}{% include 'pagination.html' %}{% endif %}
    </div>
</div>
{% endmacro %}

{# Products Empty State using common macro #}
{% macro products_empty_state() %}
{% from 'macros/common_macros.html' import empty_state_card %}
{{ empty_state_card('box', 'No Products Found', 'No products match your current search criteria. Try searching by NSN, DLA name, or adjust your filters.') }}
{% endmacro %}

{# New Product Modal Macro #}
{% macro new_product_modal() %}
<div class="modal fade" id="newProductModal" tabindex="-1" aria-labelledby="newProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newProductModalLabel">New Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="newProductForm">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="name" class="form-label">Product Name *</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <div class="col-md-6">
                            <label for="product_code" class="form-label">Product Code</label>
                            <input type="text" class="form-control" id="product_code" name="product_code">
                        </div>
                        <div class="col-md-6">
                            <label for="nsn" class="form-label">NSN (National Stock Number) <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="nsn" name="nsn" required
                                   placeholder="e.g., 1234-56-789-0123" pattern="[0-9]{4}-[0-9]{2}-[0-9]{3}-[0-9]{4}">
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-6">
                            <label for="fsc" class="form-label">FSC (Federal Supply Class)</label>
                            <input type="text" class="form-control" id="fsc" name="fsc">
                        </div>
                        <div class="col-md-6">
                            <label for="manufacturer" class="form-label">Manufacturer</label>
                            <input type="text" class="form-control" id="manufacturer" name="manufacturer">
                        </div>
                        <div class="col-md-6">
                            <label for="part_number" class="form-label">Part Number</label>
                            <input type="text" class="form-control" id="part_number" name="part_number">
                        </div>
                        <div class="col-md-4">
                            <label for="category" class="form-label">Category</label>
                            <input type="text" class="form-control" id="category" name="category">
                        </div>
                        <div class="col-md-4">
                            <label for="family" class="form-label">Family</label>
                            <input type="text" class="form-control" id="family" name="family">
                        </div>
                        <div class="col-md-4">
                            <label for="unit_price" class="form-label">Unit Price</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="unit_price" name="unit_price" 
                                       step="0.01" min="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="cost_price" class="form-label">Cost Price</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="cost_price" name="cost_price" 
                                       step="0.01" min="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="list_price" class="form-label">List Price</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="list_price" name="list_price" 
                                       step="0.01" min="0">
                            </div>
                        </div>
                        <div class="col-12">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                        </div>
                    </div>
                    <div id="duplicateAlert" class="alert alert-warning mt-3" style="display: none;">
                        <strong>Warning:</strong> <span id="duplicateMessage"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Product</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endmacro %}

{# View Product Modal Macro #}
{% macro view_product_modal() %}
<div class="modal fade" id="viewProductModal" tabindex="-1" aria-labelledby="viewProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewProductModalLabel">Product Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label"><strong>NSN</strong></label>
                        <p id="viewNSN" class="form-control-plaintext">-</p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><strong>FSC</strong></label>
                        <p id="viewFSC" class="form-control-plaintext">-</p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><strong>Category</strong></label>
                        <p id="viewCategory" class="form-control-plaintext">-</p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><strong>Created Date</strong></label>
                        <p id="viewCreatedDate" class="form-control-plaintext">-</p>
                    </div>
                    <div class="col-12">
                        <label class="form-label"><strong>Manufacturer</strong></label>
                        <p id="viewManufacturer" class="form-control-plaintext">-</p>
                    </div>
                    <div class="col-12">
                        <label class="form-label"><strong>Description</strong></label>
                        <p id="viewDescription" class="form-control-plaintext">-</p>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label"><strong>Unit Price</strong></label>
                        <p id="viewUnitPrice" class="form-control-plaintext">-</p>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label"><strong>Cost Price</strong></label>
                        <p id="viewCostPrice" class="form-control-plaintext">-</p>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label"><strong>List Price</strong></label>
                        <p id="viewListPrice" class="form-control-plaintext">-</p>
                    </div>
                </div>
                
                <!-- Relationships Section -->
                <hr class="my-4">
                <h6>Related Information</h6>
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label"><strong>Related Quotes</strong></label>
                        <div id="viewRFQs" class="border rounded p-2 bg-light">
                            <em>Loading...</em>
                        </div>
                    </div>
                    <div class="col-12">
                        <label class="form-label"><strong>Related Opportunities</strong></label>
                        <div id="viewOpportunities" class="border rounded p-2 bg-light">
                            <em>Loading...</em>
                        </div>
                    </div>
                    <div class="col-12">
                        <label class="form-label"><strong>Vendors</strong></label>
                        <div id="viewVendors" class="border rounded p-2 bg-light">
                            <em>Loading...</em>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="openEditModal()">Edit Product</button>
            </div>
        </div>
    </div>
</div>
{% endmacro %}

{# Edit Product Modal Macro #}
{% macro edit_product_modal() %}
<div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editProductModalLabel">Edit Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editProductForm">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="editNSN" class="form-label">NSN <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editNSN" name="nsn" required readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="editFSC" class="form-label">FSC</label>
                            <input type="text" class="form-control" id="editFSC" name="fsc">
                        </div>
                        <div class="col-md-6">
                            <label for="editName" class="form-label">Name/Category</label>
                            <input type="text" class="form-control" id="editName" name="name">
                        </div>
                        <div class="col-md-6">
                            <label for="editCategory" class="form-label">Category</label>
                            <input type="text" class="form-control" id="editCategory" name="category">
                        </div>
                        <div class="col-12">
                            <label for="editDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="editDescription" name="description" rows="3"></textarea>
                        </div>
                        <div class="col-12">
                            <label for="editManufacturer" class="form-label">Manufacturer</label>
                            <input type="text" class="form-control" id="editManufacturer" name="manufacturer">
                        </div>
                        <div class="col-md-4">
                            <label for="editUnitPrice" class="form-label">Unit Price</label>
                            <input type="number" step="0.01" class="form-control" id="editUnitPrice" name="unit_price">
                        </div>
                        <div class="col-md-4">
                            <label for="editCostPrice" class="form-label">Cost Price</label>
                            <input type="number" step="0.01" class="form-control" id="editCostPrice" name="cost_price">
                        </div>
                        <div class="col-md-4">
                            <label for="editListPrice" class="form-label">List Price</label>
                            <input type="number" step="0.01" class="form-control" id="editListPrice" name="list_price">
                        </div>
                    </div>
                    
                    <!-- Relationships Section -->
                    <hr class="my-4">
                    <h6>Relationships</h6>
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label"><strong>Related Quotes</strong></label>
                            <div id="editRFQs" class="border rounded p-2 bg-light mb-2">
                                <em>Loading...</em>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addQuoteRelationship()">
                                <i class="fas fa-plus me-1"></i>Link Quote
                            </button>
                        </div>
                        <div class="col-12">
                            <label class="form-label"><strong>Related Opportunities</strong></label>
                            <div id="editOpportunities" class="border rounded p-2 bg-light mb-2">
                                <em>Loading...</em>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addOpportunityRelationship()">
                                <i class="fas fa-plus me-1"></i>Link Opportunity
                            </button>
                        </div>
                        <div class="col-12">
                            <label class="form-label"><strong>Vendors</strong></label>
                            <div id="editVendors" class="border rounded p-2 bg-light mb-2">
                                <em>Loading...</em>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addVendorRelationship()">
                                <i class="fas fa-plus me-1"></i>Add Vendor
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endmacro %}

{# Products Page Styles Macro #}
{% macro products_styles() %}
<style>
tbody tr:hover {
    background-color: #f8f9fa !important;
    transform: translateY(-1px);  
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
}

tbody tr {
    transition: all 0.2s ease;
}
</style>
{% endmacro %}