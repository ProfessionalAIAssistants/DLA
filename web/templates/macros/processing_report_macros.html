{% macro summary_card(title, value, text_class="primary", icon="info-circle") %}
<div class="col-md-2">
    <div class="card text-center">
        <div class="card-body">
            <h3 class="text-{{ text_class }} mb-1">{{ value }}</h3>
            <small class="text-muted">{{ title }}</small>
        </div>
    </div>
</div>
{% endmacro %}

{% macro badge_with_change(before_count, after_count, label) %}
<div class="col-md-2 mb-3">
    <div class="text-center">
        <h6 class="text-capitalize">{{ label }}</h6>
        <div class="d-flex justify-content-center align-items-center">
            <span class="me-2">{{ before_count }}</span>
            <i class="fas fa-arrow-right text-muted me-2"></i>
            <span class="me-2">{{ after_count }}</span>
            {% set change = after_count - before_count %}
            {% if change > 0 %}
            <span class="badge bg-success">+{{ change }}</span>
            {% elif change < 0 %}
            <span class="badge bg-danger">{{ change }}</span>
            {% else %}
            <span class="text-muted">Â±0</span>
            {% endif %}
        </div>
    </div>
</div>
{% endmacro %}

{% macro file_table(files, table_type, show_columns=None) %}
<div class="table-responsive">
    <table class="table table-sm mb-0">
        <thead class="table-light">
            <tr>
                <th>Filename</th>
                <th>DLA RFQ Number</th>
                {% if table_type == "processed" %}
                <th>Manufacturer</th>
                <th>Delivery Days</th>
                <th>Records Created</th>
                <th>Records Updated</th>
                {% elif table_type == "skipped" %}
                <th>Skip Reason</th>
                <th>Delivery Days</th>
                <th>ISO</th>
                <th>Sampling</th>
                {% elif table_type == "error" %}
                <th>Error</th>
                <th>Timestamp</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for file in files %}
            <tr>
                <td class="fw-bold">{{ file.filename }}</td>
                <td>{{ file.rfq_data.get('request_number', 'N/A') if file.rfq_data else 'N/A' }}</td>
                {% if table_type == "processed" %}
                <td>{{ file.rfq_data.get('mfr', 'N/A') if file.rfq_data else 'N/A' }}</td>
                <td>{{ file.rfq_data.get('delivery_days', 'N/A') if file.rfq_data else 'N/A' }}</td>
                <td>
                    {% if file.created_records > 0 %}
                    <span class="badge bg-success">{{ file.created_records }}</span>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if file.updated_records > 0 %}
                    <span class="badge bg-info">{{ file.updated_records }}</span>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                </td>
                {% elif table_type == "skipped" %}
                <td>
                    <small class="text-warning">{{ file.reason | replace('\n', '<br>') | safe }}</small>
                </td>
                <td>{{ file.rfq_data.get('delivery_days', 'N/A') if file.rfq_data else 'N/A' }}</td>
                <td>{{ file.rfq_data.get('iso', 'N/A') if file.rfq_data else 'N/A' }}</td>
                <td>{{ file.rfq_data.get('sampling', 'N/A') if file.rfq_data else 'N/A' }}</td>
                {% elif table_type == "error" %}
                <td>
                    <small class="text-danger">{{ file.error }}</small>
                </td>
                <td>{{ file.timestamp[:19] | replace('T', ' ') }}</td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endmacro %}

{% macro record_type_card(record_type, records, card_class="success") %}
<div class="col-md-6 mb-3">
    <div class="card border-{{ card_class }}">
        <div class="card-header bg-light">
            <h6 class="card-title mb-0 text-capitalize text-{{ card_class }}">
                <i class="fas fa-{% if record_type == 'opportunities' %}handshake{% elif record_type == 'contacts' %}user{% elif record_type == 'accounts' %}building{% elif record_type == 'products' %}box{% elif record_type == 'tasks' %}tasks{% elif record_type == 'qpls' %}list-alt{% else %}plus{% endif %} me-2"></i>
                {{ "QPLs" if record_type == 'qpls' else record_type.title() }} ({{ records|length }})
            </h6>
        </div>
        <div class="card-body p-0" style="max-height: 200px; overflow-y: auto;">
            <ul class="list-group list-group-flush">
                {% for record in records %}
                <li class="list-group-item py-2 record-item" 
                    data-record-type="{{ record_type }}" 
                    data-record-id="{{ record.get('id', '') }}"
                    style="cursor: pointer;"
                    title="Double-click to view details"
                    ondblclick="ProcessingReportJS.Records.view('{{ record_type }}', '{{ record.get('id', '') }}')">
                    <div class="d-flex justify-content-start align-items-center">
                        <div>
                            <strong>
                                {% if record_type == 'opportunities' %}
                                    {{ record.get('request_number', 'Unknown') }}
                                {% elif record_type == 'contacts' %}
                                    {{ record.get('name', 'Unknown') }}
                                {% elif record_type == 'accounts' %}
                                    {{ record.get('name', 'Unknown') }}
                                {% elif record_type == 'products' %}
                                    {{ record.get('name', 'Unknown') }}
                                {% elif record_type == 'tasks' %}
                                    {{ record.get('subject', 'Unknown') }}
                                {% elif record_type == 'qpls' %}
                                    {{ record.get('manufacturer', 'Unknown') }} - {{ record.get('part_number', 'Unknown') }}
                                {% else %}
                                    {{ record.get('name', record.get('id', 'Unknown')) }}
                                {% endif %}
                            </strong>
                            {% if record_type == 'opportunities' and record.get('nsn') %}
                            <br><small class="text-muted">NSN: {{ record.nsn }}</small>
                            {% elif record_type == 'contacts' and record.get('email') %}
                            <br><small class="text-muted">{{ record.email }}</small>
                            {% elif record_type == 'products' and record.get('nsn') %}
                            <br><small class="text-muted">NSN: {{ record.nsn }}</small>
                            {% elif record_type == 'qpls' and record.get('nsn') %}
                            <br><small class="text-muted">NSN: {{ record.nsn }}</small>
                            {% endif %}
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
{% endmacro %}

{% macro updated_record_card(record_type, records) %}
<div class="col-md-6 mb-3">
    <div class="card border-info">
        <div class="card-header bg-light">
            <h6 class="card-title mb-0 text-capitalize text-info">
                <i class="fas fa-{% if record_type == 'contacts' %}user{% elif record_type == 'accounts' %}building{% else %}edit{% endif %} me-2"></i>
                {{ record_type.title() }} ({{ records|length }})
            </h6>
        </div>
        <div class="card-body p-0" style="max-height: 200px; overflow-y: auto;">
            <ul class="list-group list-group-flush">
                {% for record in records %}
                <li class="list-group-item py-2">
                    <div class="d-flex justify-content-start align-items-start">
                        <div>
                            <strong>{{ record.get('name', 'Unknown') }}</strong>
                            {% if record.get('email') %}
                            <br><small class="text-muted">{{ record.email }}</small>
                            {% endif %}
                            {% if record.get('updates') %}
                            <br><small class="text-success">Updated: {{ record.updates | join(', ') }}</small>
                            {% endif %}
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
{% endmacro %}

{% macro card_section(title, icon, icon_class="primary", content_id=None) %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-{{ icon }} me-2 text-{{ icon_class }}"></i>
            {{ title }}
        </h5>
        {% if content_id %}
        <small class="text-muted">Double-click any record to view details</small>
        {% endif %}
    </div>
    <div class="card-body{% if content_id %} p-0{% endif %}">
        {{ caller() }}
    </div>
</div>
{% endmacro %}

{# ==================== MERGED FROM processing_report_content_macros.html ==================== #}

{# Report Header Macro #}
{% macro report_header(report) %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1>
            <i class="fas fa-file-chart me-3"></i>
            Processing Report Details
        </h1>
        <p class="text-muted mb-0">
            Report from {{ report.processing_start[:19] | replace('T', ' ') }}
            {% if report.processing_end %}
            - {{ report.processing_end[:19] | replace('T', ' ') }}
            {% endif %}
        </p>
    </div>
    <div>
        <a href="{{ url_for('processing_reports') }}" class="btn btn-outline-secondary me-2">
            <i class="fas fa-arrow-left me-2"></i>Back to Reports
        </a>
        <button onclick="window.print()" class="btn btn-outline-primary">
            <i class="fas fa-print me-2"></i>Print Report
        </button>
    </div>
</div>
{% endmacro %}

{# Processing Time Card Macro #}
{% macro processing_time_card(report) %}
<div class="col-md-2">
    <div class="card text-center">
        <div class="card-body">
            <h3 class="text-secondary mb-1">
                {% if report.processing_start and report.processing_end %}
                {{ ((report.processing_end | to_datetime) - (report.processing_start | to_datetime)).total_seconds() | round(1) }}s
                {% else %}
                -
                {% endif %}
            </h3>
            <small class="text-muted">Processing Time</small>
        </div>
    </div>
</div>
{% endmacro %}

{# Summary Row Macro #}
{% macro summary_row(report) %}
<div class="row mb-4">
    {{ summary_card("Files Processed", report.processed or 0, "primary") }}
    {{ summary_card("Opportunities Created", report.summary.opportunities_created if report.summary else (report.created or 0), "success") }}
    {{ summary_card("Records Updated", (report.summary.contacts_updated + report.summary.accounts_updated) if report.summary else (report.updated or 0), "info") }}
    {{ summary_card("Files Skipped", report.skipped or 0, "warning") }}
    {{ summary_card("Errors", report.errors|length if report.errors else 0, "danger") }}
    {{ processing_time_card(report) }}
</div>
{% endmacro %}

{# Detailed Summary Card Macro #}
{% macro detailed_summary_card(report) %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Detailed Processing Summary
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {{ summary_card("Opportunities Created", report.summary.opportunities_created if report.summary else 0, "success") }}
                    {{ summary_card("Contacts Created", report.summary.contacts_created if report.summary else 0, "success") }}
                    {{ summary_card("Accounts Created", report.summary.accounts_created if report.summary else 0, "success") }}
                    {{ summary_card("Products Created", report.summary.products_created if report.summary else 0, "success") }}
                    {{ summary_card("QPLs Created", report.summary.qpls_created if report.summary else 0, "success") }}
                    {{ summary_card("Contacts Updated", report.summary.contacts_updated if report.summary else 0, "info") }}
                    {{ summary_card("Accounts Updated", report.summary.accounts_updated if report.summary else 0, "info") }}
                </div>
            </div>
        </div>
    </div>
</div>
{% endmacro %}

{# Database Changes Card Macro #}
{% macro database_changes_card(report) %}
{% if report.database_stats_before and report.database_stats_after %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-database me-2"></i>Database Changes
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for table, before_count in report.database_stats_before.items() %}
                    {% if table != 'error' %}
                    {% set after_count = report.database_stats_after.get(table, before_count) %}
                    {% set label = "DLA RFQs" if table == 'rfqs' else table %}
                    {{ badge_with_change(before_count, after_count, label) }}
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endmacro %}

{# Filter Settings Card Macro #}
{% macro filter_settings_card(report) %}
{% if report.filter_settings %}
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-filter me-2"></i>Filter Settings Used
                </h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li><strong>Min Delivery Days:</strong> {{ report.filter_settings.min_delivery_days or 'Not set' }}</li>
                    <li><strong>ISO Required:</strong> {{ report.filter_settings.iso_required or 'ANY' }}</li>
                    <li><strong>Sampling Required:</strong> {{ report.filter_settings.sampling_required or 'ANY' }}</li>
                    <li><strong>Inspection Point:</strong> {{ report.filter_settings.inspection_point or 'ANY' }}</li>
                    <li><strong>Auto Create Opportunities:</strong> {{ 'Yes' if report.filter_settings.auto_create_opportunities else 'No' }}</li>
                    <li><strong>Move Processed Files:</strong> {{ 'Yes' if report.filter_settings.move_processed_files else 'No' }}</li>
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        {% if report.filter_settings.manufacturer_filter %}
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-industry me-2"></i>Manufacturer Filter
                </h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    {% for mfr in report.filter_settings.manufacturer_filter.split('\n') %}
                    {% if mfr.strip() %}
                    <li>{{ mfr.strip() }}</li>
                    {% endif %}
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}
{% endmacro %}

{# ========== PROCESSING REPORTS LIST PAGE MACROS ========== #}
{# These macros are for the processing reports listing page #}

{# Consolidated macros for processing reports page #}
{% from 'macros/common_macros.html' import empty_state %}

{% macro processing_reports_page_header() %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1>
            <i class="fas fa-chart-line me-3"></i>
            PDF Processing Reports
        </h1>
        <p class="text-muted mb-0">View detailed reports from PDF processing sessions</p>
        <small class="text-info clickable-hint"><i class="fas fa-mouse-pointer me-1"></i>Double-click any row to view detailed report</small>
    </div>
    <div>
        <button class="btn btn-danger me-2" onclick="clearAllReports()" id="clearAllBtn">
            <i class="fas fa-trash-alt me-2"></i>Clear All Reports
        </button>
        <a href="/" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
        </a>
    </div>
</div>
{% endmacro %}

{% macro reports_table(reports) %}
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-file-alt me-2"></i>
            Processing Reports ({{ reports|length }})
        </h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="reportsTable">
                <thead class="table-light">
                    <tr>
                        <th>Processing Time</th>
                        <th>Files Processed</th>
                        <th>Records Created</th>
                        <th>Records Updated</th>
                        <th>Files Skipped</th>
                        <th>Errors</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for report in reports %}
                    <tr class="report-row" data-filename="{{ report.filename }}" style="cursor: pointer;" title="Double-click to view details">
                        <td>
                            <div class="fw-bold">{{ report.timestamp[:19] | replace('T', ' ') }}</div>
                            <small class="text-muted">{{ report.filename }}</small>
                        </td>
                        <td>
                            <span class="badge bg-primary fs-6">{{ report.processed }}</span>
                        </td>
                        <td>
                            <span class="badge bg-success fs-6">{{ report.created }}</span>
                        </td>
                        <td>
                            <span class="badge bg-info fs-6">{{ report.updated }}</span>
                        </td>
                        <td>
                            {% if report.skipped > 0 %}
                            <span class="badge bg-warning fs-6">{{ report.skipped }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if report.errors > 0 %}
                            <span class="badge bg-danger fs-6">{{ report.errors }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('view_processing_report', filename=report.filename) }}" 
                               class="btn btn-sm btn-outline-primary me-1">
                                <i class="fas fa-eye me-1"></i>View
                            </a>
                            <button class="btn btn-sm btn-outline-danger" 
                                    onclick="deleteReport('{{ report.filename }}')">
                                <i class="fas fa-trash me-1"></i>Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-secondary">
                    <tr class="fw-bold">
                        <td>TOTALS</td>
                        <td>
                            <span class="badge bg-primary fs-6">
                                {% set total_processed = reports|sum(attribute='processed') %}{{ total_processed }}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-success fs-6">
                                {% set total_created = reports|sum(attribute='created') %}{{ total_created }}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-info fs-6">
                                {% set total_updated = reports|sum(attribute='updated') %}{{ total_updated }}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-warning fs-6">
                                {% set total_skipped = reports|sum(attribute='skipped') %}{{ total_skipped }}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-danger fs-6">
                                {% set total_errors = reports|sum(attribute='errors') %}{{ total_errors }}
                            </span>
                        </td>
                        <td>-</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% endmacro %}

{# Reports Empty State using common macro #}
{% macro reports_empty_state() %}
{{ empty_state('chart-line', 'No Processing Reports Found', 'Reports will appear here after you process PDF files using "Load PDFs"') }}
<div class="text-center">
    <a href="/" class="btn btn-primary">
        <i class="fas fa-arrow-left me-2"></i>Go to Dashboard
    </a>
</div>
{% endmacro %}

{% macro processing_reports_styles() %}
<style>
    .report-row {
        transition: background-color 0.2s ease;
    }
    
    .report-row:hover {
        background-color: #f8f9fa !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .report-row:active {
        background-color: #e9ecef !important;
    }
    
    .clickable-hint {
        font-size: 0.85em;
        opacity: 0.8;
    }
</style>
{% endmacro %}
