{% extends "base.html" %}
{% from 'macros/account_macros.html' import account_type_badge, quick_stats_card, account_info_card, edit_account_modal %}

{% block title %}{{ account.name }} - CDE Prosperity{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-building me-2"></i>{{ account.name }}
        {{ account_type_badge(account.type, 'ms-2') }}
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="editAccount({{ account.id }})">
                <i class="fas fa-edit me-1"></i>
                Edit Account
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-plus me-1"></i>
                Add Contact
            </button>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteAccount({{ account.id }})">
                <i class="fas fa-trash me-1"></i>
                Delete Account
            </button>
        </div>
        <a href="{{ url_for('accounts') }}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>
            Back to Accounts
        </a>
    </div>
</div>

<!-- Account Summary -->
<div class="row">
    <div class="col-xl-8">
        <!-- Basic Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>Basic Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>Name:</strong></td>
                                <td>{{ account.name }}</td>
                            </tr>
                            <tr>
                                <td><strong>Type:</strong></td>
                                <td>{{ account_type_badge(account.type) }}</td>
                            </tr>
                            <tr>
                                <td><strong>Location:</strong></td>
                                <td>{{ account.location or 'N/A' }}</td>
                            </tr>
                            <tr>
                                <td><strong>Parent Company:</strong></td>
                                <td>{{ account.parent_co or 'N/A' }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>CAGE Code:</strong></td>
                                <td>{{ account.cage or 'N/A' }}</td>
                            </tr>
                            <tr>
                                <td><strong>Website:</strong></td>
                                <td>
                                    {% if account.website %}
                                        <a href="{{ account.website }}" target="_blank" class="text-decoration-none">
                                            <i class="fas fa-external-link-alt me-1"></i>{{ account.website }}
                                        </a>
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Email:</strong></td>
                                <td>
                                    {% if account.email %}
                                        <a href="mailto:{{ account.email }}" class="text-decoration-none">
                                            <i class="fas fa-envelope me-1"></i>{{ account.email }}
                                        </a>
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>LinkedIn:</strong></td>
                                <td>
                                    {% if account.linkedin %}
                                        <a href="{{ account.linkedin }}" target="_blank" class="text-decoration-none">
                                            <i class="fab fa-linkedin me-1"></i>LinkedIn Profile
                                        </a>
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                            </tr>
                            {% if account.type == 'Vendor' %}
                            <tr>
                                <td><strong>Primary Contact:</strong></td>
                                <td>
                                    {% if primary_contact %}
                                        <a href="{{ url_for('contact_detail', contact_id=primary_contact.id) }}" class="text-decoration-none">
                                            <strong>{{ primary_contact.first_name }} {{ primary_contact.last_name }}</strong>
                                        </a>
                                        <br>
                                        <small class="text-muted">{{ primary_contact.title or 'Contact' }}</small>
                                        {% if primary_contact.email %}
                                        <br>
                                        <a href="mailto:{{ primary_contact.email }}" class="text-muted text-decoration-none">
                                            <i class="fas fa-envelope me-1"></i>{{ primary_contact.email }}
                                        </a>
                                        {% endif %}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                </div>
                
                {% if account.summary %}
                <div class="mt-3">
                    <h6><strong>Summary:</strong></h6>
                    <p class="text-muted">{{ account.summary }}</p>
                </div>
                {% endif %}
                
                {% if account.detail %}
                <div class="mt-3">
                    <h6><strong>Details:</strong></h6>
                    <p class="text-muted">{{ account.detail }}</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Child Accounts (for parent companies) -->
        {% if child_accounts %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-sitemap me-2"></i>Child Companies ({{ child_accounts|length }})
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Company Name</th>
                                <th>Type</th>
                                <th>Location</th>
                                <th>Contacts</th>
                                <th>Opportunities</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for child in child_accounts %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('account_detail', account_id=child.id) }}" class="text-decoration-none fw-semibold">
                                        {{ child.name }}
                                    </a>
                                </td>
                                <td>
                                    {% if child.type %}
                                        {{ account_type_badge(child.type) }}
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>{{ child.location or 'N/A' }}</td>
                                <td>
                                    <span class="badge bg-info">{{ child.contact_count or 0 }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-success">{{ child.opportunity_count or 0 }}</span>
                                </td>
                                <td>
                                    <a href="{{ url_for('account_detail', account_id=child.id) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye me-1"></i>View
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Contacts -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-users me-2"></i>Contacts ({{ contacts|length }})
                </h5>
                <button type="button" class="btn btn-sm btn-primary">
                    <i class="fas fa-plus me-1"></i>Add Contact
                </button>
            </div>
            <div class="card-body">
                {% if contacts %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Title</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for contact in contacts %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('contact_detail', contact_id=contact.id) }}" class="text-decoration-none">
                                        <strong>{{ contact.first_name }} {{ contact.last_name }}</strong>
                                    </a>
                                </td>
                                <td>{{ contact.title or 'N/A' }}</td>
                                <td>
                                    {% if contact.email %}
                                        <a href="mailto:{{ contact.email }}">{{ contact.email }}</a>
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                                <td>{{ contact.phone or 'N/A' }}</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{{ url_for('contact_detail', contact_id=contact.id) }}" class="btn btn-sm btn-outline-primary" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button class="btn btn-sm btn-outline-danger delete-contact-btn" 
                                                data-contact-id="{{ contact.id }}" 
                                                data-contact-name="{{ contact.first_name }} {{ contact.last_name }}" 
                                                title="Delete Contact">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-users fa-2x text-muted mb-3"></i>
                    <h6 class="text-muted">No Contacts</h6>
                    <p class="text-muted">No contacts have been added to this account yet.</p>
                    <button type="button" class="btn btn-primary" onclick="window.location.href='/contacts?account={{ account.id }}#add'">
                        <i class="fas fa-plus me-1"></i>Add First Contact
                    </button>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- QPLs (if applicable) -->
        {% if account.type == 'QPL' %}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-certificate me-2"></i>QPL Qualifications
                </h5>
                {% if qpl_products %}
                <small class="text-muted">{{ qpl_products|length }} qualified products</small>
                {% endif %}
            </div>
            <div class="card-body">
                {% if qpl_products %}
                <div class="table-responsive">
                    <table class="table table-striped" id="qplTable">
                        <thead>
                            <tr>
                                <th>NSN</th>
                                <th>Product Description</th>
                                <th>FSC</th>
                                <th>Date Added</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in qpl_products %}
                            <tr>
                                <td>
                                    {% if product.nsn %}
                                    <span class="fw-bold text-primary">{{ product.nsn }}</span>
                                    {% else %}
                                    <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if product.nsn %}
                                    <a href="/products/{{ product.nsn }}" class="text-decoration-none">
                                        <strong>{{ product.product_name or product.description or 'O-RING' }}</strong>
                                    </a>
                                    {% else %}
                                    <strong>{{ product.product_name or product.description or 'O-RING' }}</strong>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if product.cage_code %}
                                    <span class="fw-bold text-info fs-6">{{ product.cage_code }}</span>
                                    {% else %}
                                    <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if product.created_date %}
                                    <small class="text-muted">{{ product.created_date[:10] if product.created_date else 'N/A' }}</small>
                                    {% else %}
                                    <small class="text-muted">N/A</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        {% if product.nsn %}
                                        <a href="/products/{{ product.nsn }}" class="btn btn-outline-primary btn-sm" 
                                                title="View Product Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% else %}
                                        <button type="button" class="btn btn-outline-secondary btn-sm" disabled
                                                title="No NSN available">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% endif %}
                                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                                onclick="deleteQPLEntry({{ product.id }})"
                                                title="Remove from QPL">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-certificate fa-2x text-muted mb-3"></i>
                    <h6 class="text-muted">No QPL Data</h6>
                    <p class="text-muted">This manufacturer is not currently qualified for any products.</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- QPL-Vendor Relationships -->
        {% if account.type == 'QPL' or account.type == 'Vendor' %}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    {% if account.type == 'QPL' %}
                    <i class="fas fa-truck me-2"></i>Approved Vendors
                    {% else %}
                    <i class="fas fa-industry me-2"></i>QPL Manufacturers
                    {% endif %}
                </h5>
                <button type="button" class="btn btn-primary btn-sm" onclick="showAddRelationshipModal()">
                    <i class="fas fa-plus me-1"></i>
                    {% if account.type == 'QPL' %}Add Vendor{% else %}Add QPL Manufacturer{% endif %}
                </button>
            </div>
            <div class="card-body">
                {% if account.type == 'QPL' %}
                    <!-- Vendors who can supply this QPL manufacturer's parts -->
                    {% if qpl_vendors %}
                    <div class="table-responsive">
                        <table class="table table-striped" id="vendorsTable">
                            <thead>
                                <tr>
                                    <th>Vendor Name</th>
                                    <th>Location</th>
                                    <th>Contact</th>
                                    <th>Relationship Since</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for vendor in qpl_vendors %}
                                <tr>
                                    <td>
                                        <a href="/account/{{ vendor.id }}" class="text-decoration-none">
                                            <strong>{{ vendor.name }}</strong>
                                        </a>
                                        <br><small class="text-muted">{{ vendor.type }}</small>
                                    </td>
                                    <td>{{ vendor.location or 'N/A' }}</td>
                                    <td>
                                        {% if vendor.email %}
                                        <a href="mailto:{{ vendor.email }}" class="text-decoration-none">{{ vendor.email }}</a>
                                        {% else %}
                                        N/A
                                        {% endif %}
                                    </td>
                                    <td>{{ vendor.relationship_created[:10] if vendor.relationship_created else 'N/A' }}</td>
                                    <td>
                                        <button class="btn btn-outline-danger btn-sm" 
                                                onclick="removeRelationship({{ account.id }}, {{ vendor.id }})"
                                                title="Remove relationship">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-truck fa-2x text-muted mb-3"></i>
                        <h6 class="text-muted">No Approved Vendors</h6>
                        <p class="text-muted">No vendors are currently approved to supply this manufacturer's parts.</p>
                    </div>
                    {% endif %}
                {% else %}
                    <!-- QPL manufacturers this vendor can supply parts for -->
                    {% if vendor_qpl_accounts %}
                    <div class="table-responsive">
                        <table class="table table-striped" id="qplManufacturersTable">
                            <thead>
                                <tr>
                                    <th>Manufacturer</th>
                                    <th>CAGE Code</th>
                                    <th>Location</th>
                                    <th>Relationship Since</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for qpl_account in vendor_qpl_accounts %}
                                <tr>
                                    <td>
                                        <a href="/account/{{ qpl_account.id }}" class="text-decoration-none">
                                            <strong>{{ qpl_account.name }}</strong>
                                        </a>
                                        <br><small class="text-muted">{{ qpl_account.type }}</small>
                                    </td>
                                    <td>
                                        {% if qpl_account.cage %}
                                        <span class="badge bg-info">{{ qpl_account.cage }}</span>
                                        {% else %}
                                        N/A
                                        {% endif %}
                                    </td>
                                    <td>{{ qpl_account.location or 'N/A' }}</td>
                                    <td>{{ qpl_account.relationship_created[:10] if qpl_account.relationship_created else 'N/A' }}</td>
                                    <td>
                                        <button class="btn btn-outline-danger btn-sm" 
                                                onclick="removeRelationship({{ qpl_account.id }}, {{ account.id }})"
                                                title="Remove relationship">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-industry fa-2x text-muted mb-3"></i>
                        <h6 class="text-muted">No QPL Manufacturers</h6>
                        <p class="text-muted">This vendor is not currently approved to supply any QPL manufacturer's parts.</p>
                    </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- QPL Qualifications for Vendor Accounts -->
        {% if account.type == 'Vendor' and vendor_qpl_qualifications %}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-certificate me-2"></i>QPL Qualifications
                </h5>
                <small class="text-muted">{{ vendor_qpl_qualifications|length }} qualified products</small>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="qplQualificationsTable">
                        <thead>
                            <tr>
                                <th>NSN</th>
                                <th>Product Description</th>
                                <th>FSC</th>
                                <th>Date Added</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for qualification in vendor_qpl_qualifications %}
                            <tr>
                                <td>
                                    <span class="fw-bold text-primary">{{ qualification.part_number }}</span>
                                </td>
                                <td>
                                    <a href="/account/{{ qualification.account_id }}" class="text-decoration-none">
                                        <strong>O-RING</strong>
                                    </a>
                                </td>
                                <td>
                                    {% if qualification.cage_code %}
                                    <span class="fw-bold text-info fs-6">{{ qualification.cage_code }}</span>
                                    {% else %}
                                    <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">{{ qualification.created_date[:10] if qualification.created_date else 'N/A' }}</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="/account/{{ qualification.account_id }}" class="btn btn-outline-primary btn-sm" 
                                                title="View Manufacturer Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        This vendor is qualified to supply the above QPL parts from associated manufacturers.
                    </small>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="col-xl-4">
        <!-- Quick Stats -->
        {{ quick_stats_card(contacts|length, opportunities|length) }}

        <!-- Account Info -->
        {{ account_info_card(account) }}

        <!-- Media -->
        {% if account.image or account.video %}
        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-header bg-warning text-dark border-0">
                <h6 class="card-title mb-0 fw-bold">
                    <i class="fas fa-image me-2"></i>Media
                </h6>
            </div>
            <div class="card-body">
                {% if account.image %}
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-warning bg-opacity-10 rounded-circle p-2 me-3">
                        <i class="fas fa-image text-warning"></i>
                    </div>
                    <div class="flex-grow-1">
                        <small class="text-muted fw-medium">Image</small>
                        <div class="text-dark small">{{ account.image }}</div>
                    </div>
                </div>
                {% endif %}
                {% if account.video %}
                <div class="d-flex align-items-center">
                    <div class="bg-warning bg-opacity-10 rounded-circle p-2 me-3">
                        <i class="fas fa-video text-warning"></i>
                    </div>
                    <div class="flex-grow-1">
                        <small class="text-muted fw-medium">Video</small>
                        <div class="text-dark small">{{ account.video }}</div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Recent Activity -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-info text-white border-0">
                <h6 class="card-title mb-0 fw-bold">
                    <i class="fas fa-clock me-2"></i>Recent Activity
                </h6>
            </div>
            <div class="card-body">
                {% if activity_data %}
                    <div class="timeline">
                        {% for activity in activity_data[:10] %}
                        <div class="timeline-item d-flex mb-3">
                            <div class="timeline-marker me-3">
                                <div class="bg-{{ activity.color }} rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                    <i class="{{ activity.icon }} text-white"></i>
                                </div>
                            </div>
                            <div class="timeline-content flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <p class="mb-1 fw-semibold">{{ activity.description }}</p>
                                        <small class="text-muted">
                                            <i class="fas fa-calendar-alt me-1"></i>
                                            {% if activity.date != 'Unknown' %}
                                                {% if activity.date.strftime is defined %}
                                                    {{ activity.date.strftime('%B %d, %Y at %I:%M %p') }}
                                                {% else %}
                                                    {{ activity.date }}
                                                {% endif %}
                                            {% else %}
                                                Unknown date
                                            {% endif %}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <div class="bg-info bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                            <i class="fas fa-clock text-info fa-2x"></i>
                        </div>
                        <h6 class="text-dark fw-bold mb-2">No Recent Activity</h6>
                        <p class="text-muted small mb-0">Activity tracking will appear here.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
{{ edit_account_modal() }}

{% endblock %}

{% block scripts %}
<!-- Load jQuery first for DataTables -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Load DataTables -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

<!-- Add Relationship Modal -->
<div class="modal fade" id="addRelationshipModal" tabindex="-1" aria-labelledby="addRelationshipModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addRelationshipModalLabel">
                    {% if account.type == 'QPL' %}Add Approved Vendor{% else %}Add QPL Manufacturer{% endif %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addRelationshipForm">
                    <div class="mb-3">
                        <label for="relationshipAccount" class="form-label">
                            {% if account.type == 'QPL' %}Select Vendor:{% else %}Select QPL Manufacturer:{% endif %}
                        </label>
                        <select class="form-select" id="relationshipAccount" name="relationshipAccount" onchange="toggleNewAccountForm()">
                            <option value="">Choose...</option>
                            <option value="new">+ Create New {% if account.type == 'QPL' %}Vendor{% else %}QPL Manufacturer{% endif %}</option>
                        </select>
                    </div>
                    
                    <!-- New Account Form (hidden by default) -->
                    <div id="newAccountForm" style="display: none;">
                        <div class="border-top pt-3 mb-3">
                            <h6>Create New {% if account.type == 'QPL' %}Vendor{% else %}QPL Manufacturer{% endif %}</h6>
                            <div class="mb-3">
                                <label for="newAccountName" class="form-label">Account Name *</label>
                                <input type="text" class="form-control" id="newAccountName" name="newAccountName" required>
                            </div>
                            <div class="mb-3">
                                <label for="newAccountLocation" class="form-label">Location</label>
                                <input type="text" class="form-control" id="newAccountLocation" name="newAccountLocation">
                            </div>
                            <div class="mb-3">
                                <label for="newAccountEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="newAccountEmail" name="newAccountEmail">
                            </div>
                            {% if account.type != 'QPL' %}
                            <div class="mb-3">
                                <label for="newAccountCage" class="form-label">CAGE Code</label>
                                <input type="text" class="form-control" id="newAccountCage" name="newAccountCage" maxlength="5">
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="relationshipNotes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="relationshipNotes" name="relationshipNotes" rows="3" 
                                  placeholder="Add any notes about this relationship..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addRelationship()">Add Relationship</button>
            </div>
        </div>
    </div>
</div>

<!-- Load account detail JavaScript after jQuery -->
<script src="{{ url_for('static', filename='js/account_detail.js') }}"></script>

<!-- QPL-Vendor Relationship JavaScript -->
<script>
function toggleNewAccountForm() {
    const select = document.getElementById('relationshipAccount');
    const newAccountForm = document.getElementById('newAccountForm');
    
    if (select.value === 'new') {
        newAccountForm.style.display = 'block';
        // Remove required attribute from select since we're creating new
        select.removeAttribute('required');
    } else {
        newAccountForm.style.display = 'none';
        // Clear new account form
        document.getElementById('newAccountName').value = '';
        document.getElementById('newAccountLocation').value = '';
        document.getElementById('newAccountEmail').value = '';
        const cageField = document.getElementById('newAccountCage');
        if (cageField) cageField.value = '';
        // Restore required attribute to select
        select.setAttribute('required', 'required');
    }
}

function showAddRelationshipModal() {
    // Load available accounts for relationship
    const accountType = '{{ account.type }}';
    const targetType = accountType === 'QPL' ? 'Vendor' : 'QPL';
    
    fetch(`/api/accounts/${targetType.toLowerCase()}`)
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('relationshipAccount');
            select.innerHTML = '<option value="">Choose...</option>';
            select.innerHTML += `<option value="new">+ Create New ${targetType}</option>`;
            
            // Check if data has accounts array
            const accounts = data.accounts || data;
            accounts.forEach(account => {
                const option = document.createElement('option');
                option.value = account.id;
                option.textContent = `${account.name} ${account.location ? '(' + account.location + ')' : ''}`;
                select.appendChild(option);
            });
            
            // Reset form
            document.getElementById('newAccountForm').style.display = 'none';
            toggleNewAccountForm();
            
            // Show modal
            new bootstrap.Modal(document.getElementById('addRelationshipModal')).show();
        })
        .catch(error => {
            console.error('Error loading accounts:', error);
            alert('Error loading available accounts. Please try again.');
        });
}

async function createNewAccount() {
    const accountType = '{{ account.type }}';
    const targetType = accountType === 'QPL' ? 'Vendor' : 'QPL';
    
    const newAccountData = {
        name: document.getElementById('newAccountName').value,
        type: targetType,
        location: document.getElementById('newAccountLocation').value,
        email: document.getElementById('newAccountEmail').value
    };
    
    // Add CAGE code for QPL accounts
    if (targetType === 'QPL') {
        newAccountData.cage = document.getElementById('newAccountCage').value;
    }
    
    // Validate required fields
    if (!newAccountData.name) {
        alert('Account name is required.');
        return null;
    }
    
    try {
        const response = await fetch('/api/create_account', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(newAccountData)
        });
        
        const result = await response.json();
        if (result.success) {
            return result.account_id;
        } else {
            alert('Error creating account: ' + (result.error || 'Unknown error'));
            return null;
        }
    } catch (error) {
        console.error('Error creating account:', error);
        alert('Error creating account. Please try again.');
        return null;
    }
}

async function addRelationship() {
    const accountType = '{{ account.type }}';
    const currentAccountId = {{ account.id }};
    let targetAccountId = document.getElementById('relationshipAccount').value;
    
    // Handle new account creation
    if (targetAccountId === 'new') {
        targetAccountId = await createNewAccount();
        if (!targetAccountId) {
            return; // Account creation failed
        }
    } else if (!targetAccountId) {
        alert('Please select an account or create a new one.');
        return;
    }
    
    // Determine the relationship direction
    let qplAccountId, vendorAccountId;
    if (accountType === 'QPL') {
        qplAccountId = currentAccountId;
        vendorAccountId = targetAccountId;
    } else {
        qplAccountId = targetAccountId;
        vendorAccountId = currentAccountId;
    }
    
    const data = {
        qpl_account_id: qplAccountId,
        vendor_account_id: vendorAccountId
    };
    
    fetch('/api/qpl-vendors', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('addRelationshipModal')).hide();
            // Reload page to show updated relationships
            location.reload();
        } else {
            alert('Error: ' + (result.error || 'Failed to create relationship'));
        }
    })
    .catch(error => {
        console.error('Error creating relationship:', error);
        alert('Error creating relationship. Please try again.');
    });
}

function removeRelationship(qplAccountId, vendorAccountId) {
    if (!confirm('Are you sure you want to remove this relationship?')) {
        return;
    }
    
    fetch(`/api/qpl-vendors/${qplAccountId}/${vendorAccountId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Reload page to show updated relationships
            location.reload();
        } else {
            alert('Error: ' + (result.error || 'Failed to remove relationship'));
        }
    })
    .catch(error => {
        console.error('Error removing relationship:', error);
        alert('Error removing relationship. Please try again.');
    });
}
</script>

<style>
/* Custom styles for enhanced visual appeal */
.card {
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
}

.btn {
    transition: all 0.3s ease;
}
</style>
{% endblock %}
