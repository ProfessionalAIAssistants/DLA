{# 
=============================================================================
CONSOLIDATED PRODUCT SCRIPTS
=============================================================================
This file combines functionality from both product_scripts.html and products_scripts.html
- Product Detail Page Scripts (individual product functionality)  
- Product List/Management Scripts (products list functionality)
=============================================================================
#}

{% macro product_styles() %}
<style>
.timeline {
    position: relative;
    padding-left: 2rem;
}

.timeline-item {
    position: relative;
    margin-bottom: 1.5rem;
}

.timeline-item:not(:last-child)::before {
    content: '';
    position: absolute;
    left: -1.5rem;
    top: 1.5rem;
    width: 2px;
    height: calc(100% + 0.5rem);
    background: linear-gradient(to bottom, #e9ecef 0%, #dee2e6 100%);
}

.timeline-marker {
    position: absolute;
    left: -1.875rem;
    top: 0.375rem;
    width: 0.75rem;
    height: 0.75rem;
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.timeline-content {
    font-size: 0.875rem;
    padding-left: 0.5rem;
}

.timeline-content h6 {
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
}

.timeline-content small {
    font-size: 0.75rem;
}

.timeline-content p {
    font-size: 0.8rem;
    line-height: 1.4;
    margin-top: 0.25rem;
}
</style>
{% endmacro %}

{% macro product_external_dependencies() %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

<!-- jQuery and DataTables JS -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
{% endmacro %}

{% macro product_javascript_functions() %}
<script>
// ================================
// PRODUCT DETAIL FUNCTIONS
// ================================
function editProduct(productId) {
    // Get the product to find its NSN, then redirect to products page with edit modal
    fetch('/api/products/id/' + productId)
        .then(response => response.json())
        .then(product => {
            if (product.error) {
                alert('Error: ' + product.error);
                return;
            }
            // Redirect to products page and trigger edit for this NSN
            window.location.href = '/products?edit=' + encodeURIComponent(product.nsn);
        })
        .catch(error => {
            console.error('Error:', error);
            // Fallback: just redirect to products page
            window.location.href = '/products';
        });
}

function deleteProduct(productId) {
    if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
        fetch('/api/products/' + productId, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '/products';
            } else {
                alert('Failed to delete product: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete product');
        });
    }
}

function addQPLManufacturer(productId) {
    // Create the URL with query parameters to pre-populate the QPL form
    const url = new URL('/qpls', window.location.origin);
    url.searchParams.set('add', 'true');
    url.searchParams.set('product_id', productId);
    
    window.location.href = url.toString();
}

function addVendorAccount() {
    // Redirect to accounts page with vendor type pre-selected
    const url = new URL('/accounts', window.location.origin);
    url.searchParams.set('add', 'true');
    url.searchParams.set('type', 'Vendor');
    
    window.location.href = url.toString();
}

function editQPLEntry(qplId) {
    alert('QPL Entry editing will be implemented');
}

function deleteQPLEntry(qplId) {
    if (confirm('Are you sure you want to remove this QPL entry?')) {
        fetch('/api/qpl-entries/' + qplId, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to remove QPL entry: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to remove QPL entry');
        });
    }
}

function exportQPLData(productId) {
    window.open('/api/products/' + productId + '/qpl-export', '_blank');
}

function addQuote(productId) {
    if (productId) {
        console.log('addQuote called for product:', productId);
        showVendorSelectionModal(productId);
    } else {
        alert('Product context required for quotes');
    }
}

function showVendorSelectionModal(productId) {
    // Create modal for vendor selection
    const modalHtml = `
        <div class="modal fade" id="vendorSelectionModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-users me-2"></i>Request Quotes from Vendors
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Email Template:</label>
                            <select id="modalEmailTemplate" class="form-select">
                                <option value="Standard Quote Request">Standard Quote Request</option>
                                <option value="Urgent Quote Request">Urgent Quote Request</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Quantity Needed:</label>
                            <input type="number" id="quoteQuantity" class="form-control" value="1" min="1">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Select Vendors:</label>
                            <div id="vendorCheckboxes" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                <div class="text-center py-3">
                                    <i class="fas fa-spinner fa-spin"></i> Loading vendors...
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info small">
                            <i class="fas fa-info-circle me-1"></i>
                            Selected vendors will receive quote request emails with product details and specifications.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-success" onclick="processQuoteRequests(${productId})">
                            <i class="fas fa-paper-plane me-1"></i>Send Quote Requests
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('vendorSelectionModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('vendorSelectionModal'));
    modal.show();
    
    // Load vendors for this product
    loadVendorsForProduct(productId);
}

function loadVendorsForProduct(productId) {
    fetch(`/api/accounts/vendors`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayVendorCheckboxes(data.accounts);
            } else {
                console.error('Error loading vendors:', data.message);
                document.getElementById('vendorCheckboxes').innerHTML = `
                    <div class="text-center py-3 text-danger">
                        <i class="fas fa-exclamation-triangle"></i> Error loading vendors
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('vendorCheckboxes').innerHTML = `
                <div class="text-center py-3 text-danger">
                    <i class="fas fa-exclamation-triangle"></i> Network error
                </div>
            `;
        });
}

function displayVendorCheckboxes(vendors) {
    const container = document.getElementById('vendorCheckboxes');
    
    if (!vendors || vendors.length === 0) {
        container.innerHTML = `
            <div class="text-center py-3 text-muted">
                <i class="fas fa-building fa-2x mb-2"></i>
                <p>No vendor accounts found.</p>
                <small>Add vendor accounts first to request quotes.</small>
            </div>
        `;
        return;
    }
    
    let html = '';
    vendors.forEach(vendor => {
        html += `
            <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" value="${vendor.id}" id="vendor${vendor.id}">
                <label class="form-check-label d-flex justify-content-between align-items-center" for="vendor${vendor.id}">
                    <div>
                        <strong>${vendor.name}</strong>
                        <span class="badge bg-info ms-2">${vendor.type || 'Vendor'}</span>
                    </div>
                    ${vendor.location ? `<small class="text-muted">Location: ${vendor.location}</small>` : ''}
                </label>
            </div>
        `;
    });
    
    // Add "Select All" option
    html = `
        <div class="form-check mb-3 border-bottom pb-2">
            <input class="form-check-input" type="checkbox" id="selectAllVendors" onchange="toggleAllVendors()">
            <label class="form-check-label fw-bold" for="selectAllVendors">
                Select All Vendors
            </label>
        </div>
    ` + html;
    
    container.innerHTML = html;
}

function toggleAllVendors() {
    const selectAll = document.getElementById('selectAllVendors');
    const checkboxes = document.querySelectorAll('#vendorCheckboxes input[type="checkbox"]:not(#selectAllVendors)');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

function processQuoteRequests(productId) {
    const selectedVendors = [];
    const checkboxes = document.querySelectorAll('#vendorCheckboxes input[type="checkbox"]:checked:not(#selectAllVendors)');
    
    checkboxes.forEach(checkbox => {
        selectedVendors.push(parseInt(checkbox.value));
    });
    
    if (selectedVendors.length === 0) {
        alert('Please select at least one vendor to send quote requests.');
        return;
    }
    
    const template = document.getElementById('modalEmailTemplate').value;
    const quantity = document.getElementById('quoteQuantity').value;
    
    const requestData = {
        vendor_ids: selectedVendors,
        template: template,
        quantity: parseInt(quantity)
    };
    
    console.log('Sending quote requests:', requestData);
    
    // Show loading state
    const button = document.querySelector('[onclick*="processQuoteRequests"]');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Sending...';
    button.disabled = true;
    
    fetch(`/api/products/${productId}/request-quotes`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('vendorSelectionModal'));
            modal.hide();
            
            // Show success message
            showSuccessMessage(`Quote requests sent to ${selectedVendors.length} vendor(s)`);
            
            // Refresh the page to show new quotes
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            alert('Error sending quote requests: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error while sending quote requests');
    })
    .finally(() => {
        // Restore button
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function showSuccessMessage(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
    `;
    alertDiv.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// ================================
// PRODUCT LIST/MANAGEMENT FUNCTIONS 
// ================================
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('newProductForm');
    const nsnInput = document.getElementById('nsn');
    const duplicateAlert = document.getElementById('duplicateAlert');
    const duplicateMessage = document.getElementById('duplicateMessage');
    
    // Real-time NSN duplicate checking
    let checkTimeout;
    
    function checkForDuplicates() {
        const nsn = nsnInput.value.trim();
        
        if (!nsn) {
            duplicateAlert.style.display = 'none';
            return;
        }
        
        clearTimeout(checkTimeout);
        checkTimeout = setTimeout(() => {
            fetch('/api/check_product_duplicate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    nsn: nsn
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.has_duplicates) {
                    const messages = data.duplicates.map(dup => dup.message).join('; ');
                    duplicateMessage.textContent = messages;
                    duplicateAlert.style.display = 'block';
                    nsnInput.classList.add('is-invalid');
                } else {
                    duplicateAlert.style.display = 'none';
                    nsnInput.classList.remove('is-invalid');
                }
            })
            .catch(error => {
                console.error('Error checking duplicates:', error);
            });
        }, 500); // Wait 500ms after user stops typing
    }
    
    if (nsnInput) {
        nsnInput.addEventListener('input', checkForDuplicates);
    }
    
    // Form submission
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(form);
            const productData = Object.fromEntries(formData.entries());
            
            // Remove empty values
            Object.keys(productData).forEach(key => {
                if (!productData[key]) {
                    delete productData[key];
                }
            });
            
            // Convert numeric fields
            if (productData.unit_price) productData.unit_price = parseFloat(productData.unit_price);
            if (productData.cost_price) productData.cost_price = parseFloat(productData.cost_price);
            if (productData.list_price) productData.list_price = parseFloat(productData.list_price);
            
            fetch('/api/create_product', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(productData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Success - close modal and reload page
                    const newProductModal = document.getElementById('newProductModal');
                    if (newProductModal) {
                        bootstrap.Modal.getInstance(newProductModal).hide();
                    }
                    location.reload();
                } else {
                    // Show error
                    alert('Error creating product: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error creating product. Please try again.');
            });
        });
    }
    
    // Reset form when modal is closed
    const newProductModal = document.getElementById('newProductModal');
    if (newProductModal) {
        newProductModal.addEventListener('hidden.bs.modal', function() {
            if (form) {
                form.reset();
            }
            if (duplicateAlert) {
                duplicateAlert.style.display = 'none';
            }
            // Clear validation states
            document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
        });
    }
    
    // Initialize DataTables
    if (typeof $ !== 'undefined' && $.fn.DataTable) {
        if ($('#qplManufacturersTable').length) {
            $('#qplManufacturersTable').DataTable({
                pageLength: 10,
                responsive: true,
                order: [[0, 'asc']], // Sort by manufacturer name
                language: {
                    search: "Search manufacturers:",
                    lengthMenu: "Show _MENU_ manufacturers per page",
                    info: "Showing _START_ to _END_ of _TOTAL_ manufacturers",
                    emptyTable: "No QPL manufacturers found for this product"
                },
                columnDefs: [
                    { orderable: false, targets: 4 }
                ]
            });
        }
        
        if ($('#vendorsTable').length) {
            $('#vendorsTable').DataTable({
                pageLength: 10,
                responsive: true,
                order: [[0, 'asc']],
                language: {
                    search: "Search vendors:",
                    lengthMenu: "Show _MENU_ vendors per page", 
                    info: "Showing _START_ to _END_ of _TOTAL_ vendors",
                    emptyTable: "No vendor information available"
                },
                columnDefs: [
                    { orderable: false, targets: 5 }
                ]
            });
        }
    }

    // Add double-click functionality to product rows
    document.querySelectorAll('tbody tr').forEach(row => {
        row.style.cursor = 'pointer';
        row.title = 'Double-click to view product details';
        row.addEventListener('dblclick', function() {
            const nsnElement = this.querySelector('td strong');
            if (nsnElement) {
                const nsn = nsnElement.textContent.trim();
                if (nsn && nsn !== 'N/A') {
                    window.location.href = `/products/${nsn}`;
                }
            }
        });
    });
});

// Global product functions for template usage
window.viewProduct = function(nsn) {
    window.location.href = `/products/${nsn}`;
};

window.editProduct = function(nsn) {
    window.location.href = `/products?edit=${encodeURIComponent(nsn)}`;
};

window.deleteProduct = function(nsn, productName) {
    if (confirm(`Are you sure you want to delete product "${productName}"?\n\nNSN: ${nsn}\n\nThis action cannot be undone.`)) {
        fetch(`/api/products/${encodeURIComponent(nsn)}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('Product deleted successfully!');
                location.reload();
            } else {
                const errorMsg = result.error || result.message || 'Unknown error';
                alert('Error deleting product: ' + errorMsg);
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting product. Please try again.');
        });
    }
};
</script>
{% endmacro %}