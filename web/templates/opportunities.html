{% extends "base.html" %}

{% block title %}Opportunities - CDE Prosperity{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h1 class="display-6 fw-bold mb-2">
                <i class="fas fa-dollar-sign me-3" style="background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></i>
                Opportunities
            </h1>
            <p class="text-muted mb-0 fs-5">Manage bids, proposals, and sales opportunities</p>
        </div>
        <div>
            <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addOpportunityModal" onclick="resetModalForAdd()">
                <i class="fas fa-plus me-2"></i>
                Add Opportunity
            </button>
        </div>
    </div>

    <!-- Quote Stats - Top Priority (Compact) -->
    <div class="row mb-3">
        <div class="col-md-2">
            <div class="card card-metric h-100">
                <div class="card-body py-2 px-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-dark mb-1 text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 1px; opacity: 0.8;">Total Quotes</h6>
                            <h4 class="mb-0 fw-bold text-dark">{{ rfq_stats.total_rfqs if rfq_stats else 0 }}</h4>
                        </div>
                        <div class="ms-2">
                            <i class="fas fa-file-alt"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card card-metric info h-100">
                <div class="card-body py-2 px-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-dark mb-1 text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 1px; opacity: 0.8;">Quote Requested</h6>
                            <h4 class="mb-0 fw-bold text-dark">{{ rfq_stats.rfq_requested if rfq_stats else 0 }}</h4>
                        </div>
                        <div class="ms-2">
                            <i class="fas fa-paper-plane"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card card-metric success h-100">
                <div class="card-body py-2 px-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-dark mb-1 text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 1px; opacity: 0.8;">Quote Received</h6>
                            <h4 class="mb-0 fw-bold text-dark">{{ rfq_stats.rfq_received if rfq_stats else 0 }}</h4>
                        </div>
                        <div class="ms-2">
                            <i class="fas fa-inbox"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card card-metric warning h-100">
                <div class="card-body py-2 px-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-dark mb-1 text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 1px; opacity: 0.8;">Active Quotes</h6>
                            <h4 class="mb-0 fw-bold text-dark">{{ rfq_stats.active_rfqs if rfq_stats else 0 }}</h4>
                        </div>
                        <div class="ms-2">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card card-metric danger h-100">
                <div class="card-body py-2 px-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-dark mb-1 text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 1px; opacity: 0.8;">Ready to Bid</h6>
                            <h4 class="mb-0 fw-bold text-dark">{{ rfq_stats.ready_to_bid if rfq_stats else 0 }}</h4>
                        </div>
                        <div class="ms-2">
                            <i class="fas fa-gavel"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card card-metric secondary h-100">
                <div class="card-body py-2 px-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-dark mb-1 text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 1px; opacity: 0.8;">Due Soon</h6>
                            <h4 class="mb-0 fw-bold text-dark">{{ rfq_stats.due_soon if rfq_stats else 0 }}</h4>
                        </div>
                        <div class="ms-2">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- General Opportunity Stats (Compact) -->
    <div class="row mb-3">
        <div class="col-md-4">
            <div class="card card-metric h-100">
                <div class="card-body py-2 px-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-dark mb-1 text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 1px; opacity: 0.8;">Total Opportunities</h6>
                            <h4 class="mb-0 fw-bold text-dark">{{ stats.total if stats else 0 }}</h4>
                            <small class="text-dark" style="opacity: 0.7; font-size: 0.75rem;">All opportunities in system</small>
                        </div>
                        <div class="ms-2">
                            <i class="fas fa-handshake"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-metric success h-100">
                <div class="card-body py-2 px-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-dark mb-1 text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 1px; opacity: 0.8;">Pipeline Value</h6>
                            <h4 class="mb-0 fw-bold text-dark">${{ "{:,.0f}".format(stats.pipeline_value or 0) if stats else "0" }}</h4>
                            <small class="text-dark" style="opacity: 0.7; font-size: 0.75rem;">Active opportunities</small>
                        </div>
                        <div class="ms-2">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-metric info h-100">
                <div class="card-body py-2 px-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-dark mb-1 text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 1px; opacity: 0.8;">Won Value</h6>
                            <h4 class="mb-0 fw-bold text-dark">${{ "{:,.0f}".format(stats.won_value or 0) if stats else "0" }}</h4>
                            <small class="text-dark" style="opacity: 0.7; font-size: 0.75rem;">Successful bids</small>
                        </div>
                        <div class="ms-2">
                            <i class="fas fa-trophy"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Overview (Compact) -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card card-metric warning h-100">
                <div class="card-body py-2 px-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-dark mb-1 text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 1px; opacity: 0.8;">Active</h6>
                            <h4 class="mb-0 fw-bold text-dark">{{ stats.active if stats else 0 }}</h4>
                        </div>
                        <div class="ms-2">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-metric danger h-100">
                <div class="card-body py-2 px-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-dark mb-1 text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 1px; opacity: 0.8;">Overdue</h6>
                            <h4 class="mb-0 fw-bold text-dark">{{ stats.overdue if stats else 0 }}</h4>
                        </div>
                        <div class="ms-2">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-metric secondary h-100">
                <div class="card-body py-2 px-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-dark mb-1 text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 1px; opacity: 0.8;">Due Today</h6>
                            <h4 class="mb-0 fw-bold text-dark">{{ stats.due_today if stats else 0 }}</h4>
                        </div>
                        <div class="ms-2">
                            <i class="fas fa-calendar-day"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-metric success h-100">
                <div class="card-body py-2 px-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-dark mb-1 text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 1px; opacity: 0.8;">Won</h6>
                            <h4 class="mb-0 fw-bold text-dark">{{ stats.won if stats else 0 }}</h4>
                        </div>
                        <div class="ms-2">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Collapsible Search and Filters -->
    <div class="card mb-4">
        <div class="card-header">
            <button class="btn btn-link p-0 text-decoration-none fw-bold text-dark d-flex align-items-center w-100" 
                    type="button" data-bs-toggle="collapse" data-bs-target="#searchFilters" 
                    aria-expanded="false" aria-controls="searchFilters">
                <i class="fas fa-filter me-2"></i>
                Search & Filters
                <i class="fas fa-chevron-down ms-auto"></i>
            </button>
        </div>
        <div class="collapse" id="searchFilters">
            <div class="card-body">
                <form method="GET" class="row g-3">
                    <div class="col-md-2">
                        <label for="stage" class="form-label">Stage</label>
                        <select class="form-select" id="stage" name="stage">
                            <option value="">All Stages</option>
                            <option value="Prospecting" {{ 'selected' if stage == 'Prospecting' }}>Prospecting</option>
                            <option value="RFQ Requested" {{ 'selected' if stage == 'RFQ Requested' }}>Quote Requested</option>
                            <option value="RFQ Received" {{ 'selected' if stage == 'RFQ Received' }}>Quote Received</option>
                            <option value="Submit Bid" {{ 'selected' if stage == 'Submit Bid' }}>Submit Bid</option>
                            <option value="Project Started" {{ 'selected' if stage == 'Project Started' }}>Project Started</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="state" class="form-label">State</label>
                        <select class="form-select" id="state" name="state">
                            <option value="">All States</option>
                            <option value="Active" {{ 'selected' if state == 'Active' }}>Active</option>
                            <option value="No Bid" {{ 'selected' if state == 'No Bid' }}>No Bid</option>
                            <option value="Past Due" {{ 'selected' if state == 'Past Due' }}>Past Due</option>
                            <option value="Bid Lost" {{ 'selected' if state == 'Bid Lost' }}>Bid Lost</option>
                            <option value="Won" {{ 'selected' if state == 'Won' }}>Won</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="iso" class="form-label">ISO Required</label>
                        <select class="form-select" id="iso" name="iso">
                            <option value="">All</option>
                            <option value="Yes" {{ 'selected' if iso == 'Yes' }}>Yes</option>
                            <option value="No" {{ 'selected' if iso == 'No' }}>No</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="fob" class="form-label">FOB</label>
                        <select class="form-select" id="fob" name="fob">
                            <option value="">All FOB</option>
                            <option value="Origin" {{ 'selected' if fob == 'Origin' }}>Origin</option>
                            <option value="Destination" {{ 'selected' if fob == 'Destination' }}>Destination</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="buyer" class="form-label">Buyer</label>
                        <input type="text" class="form-control" id="buyer" name="buyer" value="{{ buyer }}" placeholder="Search buyer...">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="fas fa-filter me-1"></i>
                            Filter
                        </button>
                        <a href="{{ url_for('opportunities') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i>
                            Clear
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Opportunities Table -->
    <div class="card">
        <div class="card-body">
            {% if opportunities %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Opportunity</th>
                            <th>Stage</th>
                            <th>State</th>
                            <th>Bid Price</th>
                            <th>Profit</th>
                            <th>Close Date</th>
                            <th>MFR</th>
                            <th>FOB</th>
                            <th>ISO</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for opp in opportunities %}
                        <tr class="{{ 'table-danger' if opp.status_indicator == 'Overdue' else 'table-warning' if opp.days_to_close == 'Due Today' else 'table-success' if opp.state == 'Won' else '' }}">
                            <td>
                                <div>
                                    <strong><a href="{{ url_for('opportunity_detail', opportunity_id=opp.id) }}" class="text-decoration-none">{{ opp.name or 'Unnamed Opportunity' }}</a></strong>
                                    {% if opp.account_name %}
                                        <br><small class="text-muted"><i class="fas fa-building me-1"></i>{{ opp.account_name }}</small>
                                    {% endif %}
                                    {% if opp.contact_name %}
                                        <br><small class="text-muted"><i class="fas fa-user me-1"></i>{{ opp.contact_name }}</small>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-{{ 'secondary' if opp.stage == 'Prospecting' else 'info' if opp.stage == 'RFQ Requested' else 'primary' if opp.stage == 'RFQ Received' else 'warning' if opp.stage == 'Submit Bid' else 'success' }}">
                                    {{ opp.stage or 'N/A' }}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-{{ 'success' if opp.state == 'Won' else 'danger' if opp.state == 'Bid Lost' else 'warning' if opp.state == 'Past Due' else 'secondary' if opp.state == 'No Bid' else 'primary' }}">
                                    {{ opp.state or 'N/A' }}
                                </span>
                            </td>
                            <td>
                                {% if opp.bid_price and opp.quantity %}
                                    <strong>${{ "{:,.2f}".format(opp.bid_price) }}</strong>
                                    <br><small class="text-muted">Qty: {{ opp.quantity }} {{ opp.unit or '' }}</small>
                                    <br><small class="text-muted">Total: ${{ "{:,.2f}".format(opp.bid_price * opp.quantity) }}</small>
                                {% else %}
                                    <span class="text-muted">Not set</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if opp.profit %}
                                    <span class="text-{{ 'success' if opp.profit > 0 else 'danger' if opp.profit < 0 else 'muted' }}">
                                        ${{ "{:,.2f}".format(opp.profit) }}
                                    </span>
                                {% else %}
                                    <span class="text-muted">TBD</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if opp.close_date %}
                                    {{ opp.close_date }}
                                    <br><span class="badge bg-{{ 'danger' if opp.days_to_close and opp.days_to_close < 0 else 'warning' if opp.days_to_close and opp.days_to_close == 0 else 'primary' }}">
                                        {% if opp.days_to_close is not none %}
                                            {% if opp.days_to_close < 0 %}
                                                {{ opp.days_to_close * -1 }} days past due
                                            {% elif opp.days_to_close == 0 %}
                                                Due today
                                            {% else %}
                                                {{ opp.days_to_close }} days remaining
                                            {% endif %}
                                        {% else %}
                                            No due date
                                        {% endif %}
                                    </span>
                                {% else %}
                                    <span class="text-muted">No due date</span>
                                {% endif %}
                            </td>
                            <td>{{ opp.mfr or 'N/A' }}</td>
                            <td>
                                {% if opp.fob %}
                                    <span class="badge bg-{{ 'info' if opp.fob == 'Origin' else 'secondary' }}">
                                        {{ opp.fob }}
                                    </span>
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if opp.iso %}
                                    <span class="badge bg-{{ 'success' if opp.iso == 'Yes' else 'secondary' }}">
                                        {{ opp.iso }}
                                    </span>
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="{{ url_for('opportunity_detail', opportunity_id=opp.id) }}">
                                            <i class="fas fa-eye me-2"></i>View Details
                                        </a></li>
                                        {% if opp.stage != 'Project Started' %}
                                        <li><a class="dropdown-item" href="#" onclick="advanceStage({{ opp.id }})">
                                            <i class="fas fa-arrow-right me-2"></i>Advance Stage
                                        </a></li>
                                        {% endif %}
                                        {% if opp.state not in ['Won', 'Bid Lost'] %}
                                        <li><a class="dropdown-item text-success" href="#" onclick="markWon({{ opp.id }})">
                                            <i class="fas fa-trophy me-2"></i>Mark Won
                                        </a></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="markLost({{ opp.id }})">
                                            <i class="fas fa-times me-2"></i>Mark Lost
                                        </a></li>
                                        {% endif %}
                                        <li><a class="dropdown-item" href="#" onclick="editOpportunity({{ opp.id }})">
                                            <i class="fas fa-edit me-2"></i>Edit
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteOpportunity({{ opp.id }})">
                                            <i class="fas fa-trash me-2"></i>Delete
                                        </a></li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-handshake fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No Opportunities Found</h5>
                <p class="text-muted">No opportunities match your current filters or there are no opportunities yet.</p>
            </div>
            {% endif %}
            
            <!-- Pagination -->
            {% include 'pagination.html' %}
        </div>
    </div>
</div>

<!-- Add Opportunity Modal -->
<div class="modal fade" id="addOpportunityModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Opportunity</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addOpportunityForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">Opportunity Name *</label>
                                <input type="text" class="form-control" id="name" name="name" required placeholder="Enter opportunity name">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="opp_stage" class="form-label">Stage</label>
                                <select class="form-select" id="opp_stage" name="stage">
                                    <option value="Prospecting">Prospecting</option>
                                    <option value="RFQ Requested">Quote Requested</option>
                                    <option value="RFQ Received">Quote Received</option>
                                    <option value="Submit Bid">Submit Bid</option>
                                    <option value="Project Started">Project Started</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="opp_state" class="form-label">State</label>
                                <select class="form-select" id="opp_state" name="state">
                                    <option value="Active">Active</option>
                                    <option value="No Bid">No Bid</option>
                                    <option value="Past Due">Past Due</option>
                                    <option value="Bid Lost">Bid Lost</option>
                                    <option value="Won">Won</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="opp_description" class="form-label">Description</label>
                        <textarea class="form-control" id="opp_description" name="description" rows="3" placeholder="Opportunity details"></textarea>
                    </div>
                    
                    <!-- Financial Information -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">Financial Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="bid_price" class="form-label">Bid Price (per unit)</label>
                                        <input type="number" class="form-control" id="bid_price" name="bid_price" step="0.01" min="0">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="purchase_costs" class="form-label">Purchase Costs (per unit)</label>
                                        <input type="number" class="form-control" id="purchase_costs" name="purchase_costs" step="0.01" min="0">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="packaging_shipping" class="form-label">Packaging & Shipping</label>
                                        <input type="number" class="form-control" id="packaging_shipping" name="packaging_shipping" step="0.01" min="0">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="opp_quantity" class="form-label">Quantity</label>
                                        <input type="number" class="form-control" id="opp_quantity" name="quantity" min="1">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Product & Shipping Information -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">Product & Shipping Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="opp_unit" class="form-label">Unit</label>
                                        <input type="text" class="form-control" id="opp_unit" name="unit" placeholder="EA, LB, FT, etc.">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="mfr" class="form-label">Manufacturer (MFR)</label>
                                        <input type="text" class="form-control" id="mfr" name="mfr" placeholder="Manufacturer name">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="opp_fob" class="form-label">FOB</label>
                                        <select class="form-select" id="opp_fob" name="fob">
                                            <option value="">Select FOB</option>
                                            <option value="Origin">Origin</option>
                                            <option value="Destination">Destination</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="packaging_type" class="form-label">Packaging Type</label>
                                        <input type="text" class="form-control" id="packaging_type" name="packaging_type" value="MIL-STD-2073-1E" placeholder="Packaging standard">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="opp_iso" class="form-label">ISO Required</label>
                                        <select class="form-select" id="opp_iso" name="iso">
                                            <option value="">Select</option>
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="sampling" class="form-label">Sampling Required</label>
                                        <select class="form-select" id="sampling" name="sampling">
                                            <option value="">Select</option>
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="days_aod" class="form-label">Days AOD</label>
                                        <input type="number" class="form-control" id="days_aod" name="days_aod" min="0" placeholder="Days After Order">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="opp_buyer" class="form-label">Buyer</label>
                                        <input type="text" class="form-control" id="opp_buyer" name="buyer" placeholder="Buyer name">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dates & Documentation -->
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="bid_date" class="form-label">Bid Date</label>
                                <input type="date" class="form-control" id="bid_date" name="bid_date">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="close_date" class="form-label">Close Date</label>
                                <input type="date" class="form-control" id="close_date" name="close_date">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="payment" class="form-label">Payment Terms</label>
                                <input type="text" class="form-control" id="payment" name="payment" placeholder="e.g., Net 30">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="document" class="form-label">Document Reference</label>
                                <input type="text" class="form-control" id="document" name="document" placeholder="Quote number, document ref">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Relationships -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="opp_account_id" class="form-label">Related Account</label>
                                <select class="form-select" id="opp_account_id" name="account_id">
                                    <option value="">Select Account</option>
                                    {% for account in accounts %}
                                    <option value="{{ account.id }}">{{ account.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="opp_contact_id" class="form-label">Related Contact</label>
                                <select class="form-select" id="opp_contact_id" name="contact_id">
                                    <option value="">Select Contact</option>
                                    {% for contact in contacts %}
                                    <option value="{{ contact.id }}">{{ contact.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="opp_product_id" class="form-label">Related Product</label>
                                <select class="form-select" id="opp_product_id" name="product_id">
                                    <option value="">Select Product</option>
                                    {% for product in products %}
                                    <option value="{{ product.id }}">{{ product.name }} ({{ product.nsn }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="packaging_info" class="form-label">Packaging Information</label>
                        <textarea class="form-control" id="packaging_info" name="packaging_info" rows="2" placeholder="Special packaging requirements or notes"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveOpportunity()">Save Opportunity</button>
            </div>
        </div>
    </div>
</div>

<script>
function resetModalForAdd() {
    // Reset the form
    document.getElementById('addOpportunityForm').reset();
    // Remove edit ID if present
    document.getElementById('addOpportunityForm').removeAttribute('data-edit-id');
    // Reset modal title
    document.querySelector('#addOpportunityModal .modal-title').textContent = 'Add New Opportunity';
}

function saveOpportunity() {
    const form = document.getElementById('addOpportunityForm');
    const formData = new FormData(form);
    const editId = form.getAttribute('data-edit-id');
    
    if (editId) {
        // Edit existing opportunity
        const updateData = {};
        for (let [key, value] of formData.entries()) {
            updateData[key] = value;
        }
        
        fetch(`/api/opportunities/${editId}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(updateData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reset form and modal for next use
                form.reset();
                form.removeAttribute('data-edit-id');
                document.querySelector('#addOpportunityModal .modal-title').textContent = 'Add New Opportunity';
                location.reload();
            } else {
                alert('Error updating opportunity: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the opportunity');
        });
    } else {
        // Add new opportunity
        fetch('/api/opportunities', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving the opportunity');
        });
    }
}

function advanceStage(opportunityId) {
    fetch(`/api/opportunities/${opportunityId}/advance`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    });
}

function markWon(opportunityId) {
    if (confirm('Mark this opportunity as Won?')) {
        fetch(`/api/opportunities/${opportunityId}/won`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        });
    }
}

function markLost(opportunityId) {
    const reason = prompt('Reason for losing this opportunity (optional):');
    fetch(`/api/opportunities/${opportunityId}/lost`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({reason: reason})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    });
}

function editOpportunity(opportunityId) {
    console.log('Edit opportunity:', opportunityId);
    
    // Fetch the opportunity data
    fetch(`/api/opportunities/${opportunityId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.opportunity) {
                const opp = data.opportunity;
                
                // Change modal title to Edit
                document.querySelector('#addOpportunityModal .modal-title').textContent = 'Edit Opportunity';
                
                // Populate form fields with existing data
                document.getElementById('name').value = opp.name || '';
                document.getElementById('opp_stage').value = opp.stage || 'Prospecting';
                document.getElementById('opp_state').value = opp.state || 'Active';
                document.getElementById('bid_price').value = opp.bid_price || '';
                document.getElementById('purchase_costs').value = opp.purchase_costs || '';
                document.getElementById('packaging_shipping').value = opp.packaging_shipping || '';
                document.getElementById('bid_date').value = opp.bid_date || '';
                document.getElementById('close_date').value = opp.close_date || '';
                document.getElementById('quantity').value = opp.quantity || '';
                document.getElementById('unit').value = opp.unit || '';
                document.getElementById('mfr').value = opp.mfr || '';
                document.getElementById('fob').value = opp.fob || 'Origin';
                document.getElementById('packaging_type').value = opp.packaging_type || 'MIL-STD-2073-1E';
                document.getElementById('iso').value = opp.iso || 'No';
                document.getElementById('sampling').value = opp.sampling || 'No';
                document.getElementById('buyer').value = opp.buyer || '';
                document.getElementById('description').value = opp.description || '';
                
                // Store the opportunity ID for saving
                document.getElementById('addOpportunityForm').setAttribute('data-edit-id', opportunityId);
                
                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('addOpportunityModal'));
                modal.show();
            } else {
                alert('Error loading opportunity data: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading opportunity data');
        });
}

function deleteOpportunity(opportunityId) {
    if (confirm('Are you sure you want to delete this opportunity?')) {
        fetch(`/api/opportunities/${opportunityId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the opportunity');
        });
    }
}

// Auto-calculate profit when financial fields change
document.addEventListener('DOMContentLoaded', function() {
    const bidPrice = document.getElementById('bid_price');
    const purchaseCosts = document.getElementById('purchase_costs');
    const packagingShipping = document.getElementById('packaging_shipping');
    const quantity = document.getElementById('opp_quantity');
    
    function calculateProfit() {
        const bid = parseFloat(bidPrice.value) || 0;
        const purchase = parseFloat(purchaseCosts.value) || 0;
        const shipping = parseFloat(packagingShipping.value) || 0;
        const qty = parseFloat(quantity.value) || 0;
        
        if (bid && purchase && qty) {
            const profit = (bid - purchase - shipping) * qty;
            // Could display calculated profit somewhere in the form
            console.log('Calculated profit:', profit);
        }
    }
    
    [bidPrice, purchaseCosts, packagingShipping, quantity].forEach(field => {
        if (field) {
            field.addEventListener('input', calculateProfit);
        }
    });

    // Handle collapsible search section
    const searchFiltersCollapse = document.getElementById('searchFilters');
    const chevronIcon = document.querySelector('[data-bs-target="#searchFilters"] i.fa-chevron-down');
    
    if (searchFiltersCollapse && chevronIcon) {
        searchFiltersCollapse.addEventListener('show.bs.collapse', function () {
            chevronIcon.classList.remove('fa-chevron-down');
            chevronIcon.classList.add('fa-chevron-up');
        });
        
        searchFiltersCollapse.addEventListener('hide.bs.collapse', function () {
            chevronIcon.classList.remove('fa-chevron-up');
            chevronIcon.classList.add('fa-chevron-down');
        });
    }
});
</script>

{% endblock %}
